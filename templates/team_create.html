<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="UTF-8">
  <title>{{ "Edit Team" if edit else "Create Team" }} – SimCricketX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Modern CSS Reset -->
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css" />

  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap"
    rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='css/shared.css') }}">

  <style>
    :root {
      /* Premium Font Stack */
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Code', monospace;

      /* Light Theme - Clean, Airy, Premium */
      --bg-body: #f8fafc;
      --bg-surface: #ffffff;
      --bg-glass: rgba(255, 255, 255, 0.8);

      --text-main: #0f172a;
      --text-muted: #64748b;
      --text-on-accent: #ffffff;

      --border-light: #e2e8f0;
      --border-focused: #6366f1;

      /* Brand Colors - Indigo/Violet Gradient */
      --brand-primary: #4f46e5;
      --brand-secondary: #818cf8;
      --brand-gradient: linear-gradient(135deg, #4f46e5 0%, #8b5cf6 100%);

      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;

      /* Shadows & Elevation */
      --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-glow: 0 0 20px rgba(79, 70, 229, 0.3);

      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --radius-full: 9999px;

      --ease-elastic: cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme="dark"] {
      /* Dark Theme - VS Code One Dark Pro */
      --bg-body: #282c34;
      --bg-surface: #21252b;
      --bg-glass: rgba(33, 37, 43, 0.85);

      --text-main: #abb2bf;
      --text-muted: #5c6370;

      --border-light: #3e4451;
      --border-focused: #61afef;

      --brand-primary: #61afef;
      --brand-secondary: #c678dd;
      --brand-gradient: linear-gradient(135deg, #61afef 0%, #c678dd 100%);

      --success: #98c379;
      --warning: #e5c07b;
      --danger: #e06c75;

      --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.4);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
      --shadow-glow: 0 0 20px rgba(97, 175, 239, 0.2);

      /* One Dark Pro Extended Palette */
      --one-dark-red: #e06c75;
      --one-dark-green: #98c379;
      --one-dark-yellow: #e5c07b;
      --one-dark-blue: #61afef;
      --one-dark-purple: #c678dd;
      --one-dark-cyan: #56b6c2;
      --one-dark-orange: #d19a66;
    }

    /* Global Reset & Typography */
    * {
      box-sizing: border-box;
      outline: none;
    }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-family: var(--font-sans);
      margin: 0;
      padding: 0;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      transition: background-color 0.3s ease;
      overflow-x: hidden;
    }

    h1,
    h2,
    h3,
    h4 {
      margin: 0;
      font-weight: 700;
      letter-spacing: -0.025em;
    }

    p {
      margin: 0;
    }

    /* Layout Container */
    .main-content {
      max-width: 1100px;
      margin: 0 auto;
      padding: 120px 2rem 100px;
      /* Top padding for fixed header */
    }

    /* ─── Ultra-Premium Navbar ─── */
    .nav-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 72px;
      background: var(--bg-glass);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border-light);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      transition: all 0.3s ease;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 700;
      color: var(--text-main);
      font-size: 1.25rem;
    }

    .home-btn {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      background: transparent;
      border: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      text-decoration: none;
      transition: all 0.2s var(--ease-elastic);
    }

    .home-btn:hover {
      background: var(--bg-surface);
      color: var(--brand-primary);
      border-color: var(--brand-primary);
      transform: scale(1.05);
      box-shadow: var(--shadow-sm);
    }

    .theme-toggle {
      background: transparent;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 8px;
      color: var(--text-muted);
      transition: transform 0.3s ease, color 0.3s ease;
    }

    .theme-toggle:hover {
      color: var(--text-main);
      transform: rotate(15deg) scale(1.1);
    }

    /* ─── Page Header & Typography ─── */
    .page-header {
      text-align: center;
      margin-bottom: 4rem;
      animation: fadeUp 0.6s ease-out;
    }

    .dynamic-title {
      font-size: 3.5rem;
      line-height: 1.1;
      font-weight: 800;
      background: var(--brand-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
      letter-spacing: -0.04em;
    }

    .page-subtitle {
      color: var(--text-muted);
      font-size: 1.1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    /* ─── Cards & Sections ─── */
    .glass-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: 2rem;
      /* Overflow visible to allow dropdowns to pop out */
      overflow: visible;
      transition: box-shadow 0.3s ease, transform 0.3s ease;
    }

    .glass-card:hover {
      box-shadow: var(--shadow-lg);
    }

    .section-header {
      padding: 2rem;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      gap: 1rem;
      background: linear-gradient(to bottom, var(--bg-surface), rgba(255, 255, 255, 0.02));
    }

    .section-icon {
      width: 48px;
      height: 48px;
      background: var(--brand-gradient);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.25rem;
      box-shadow: var(--shadow-glow);
    }

    .section-title {
      font-size: 1.5rem;
      color: var(--text-main);
    }

    .section-body {
      padding: 2rem;
    }

    /* ─── Form Elements ─── */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      position: relative;
    }

    .form-label {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .form-input,
    .form-select {
      background: var(--bg-body);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      padding: 1rem;
      font-size: 1rem;
      color: var(--text-main);
      font-family: var(--font-sans);
      transition: all 0.2s ease;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    /* Premium Input Interaction */
    .form-input:hover,
    .form-select:hover {
      background: var(--bg-surface);
      border-color: var(--border-light);
    }

    .form-input:focus,
    .form-select:focus {
      background: var(--bg-surface);
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
    }

    /* Custom Color Picker */
    .color-picker-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.5rem;
      background: var(--bg-body);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .color-picker-wrapper:hover {
      background: var(--bg-surface);
      box-shadow: 0 0 0 2px var(--border-light);
    }

    .color-swatch {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      border: 2px solid rgba(255, 255, 255, 0.2);
      box-shadow: var(--shadow-sm);
    }

    /* ─── Squad Management / Player Table ─── */
    .squad-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      background: var(--bg-body);
      padding: 1rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
    }

    .squad-stats {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    .stat-badge {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-muted);
      background: var(--bg-surface);
      padding: 0.5rem 1rem;
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-xs);
      border: 1px solid var(--border-light);
    }

    .player-counter {
      color: var(--brand-primary);
      font-weight: 700;
    }

    /* Action Buttons */
    .btn-group {
      display: flex;
      gap: 1rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      font-size: 0.95rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s var(--ease-elastic);
      border: none;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    /* Primary Gradient Button */
    .btn-primary {
      background: var(--brand-gradient);
      color: white;
      box-shadow: var(--shadow-glow);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    /* Secondary Glass Button */
    .btn-secondary {
      background: var(--bg-surface);
      border: 1px solid var(--border-light);
      color: var(--text-main);
    }

    .btn-secondary:hover {
      border-color: var(--brand-primary);
      color: var(--brand-primary);
      transform: translateY(-1px);
      background: var(--bg-body);
    }

    /* ─── Player List Rows ─── */
    .players-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .player-row {
      display: grid;
      /* Mobile layout by default, overridden by media query */
      grid-template-columns: 1fr;
      gap: 1rem;

      background: var(--bg-surface);
      border: 1px solid var(--border-light);
      padding: 1.25rem;
      border-radius: var(--radius-md);
      position: relative;
      transition: all 0.2s ease;
      animation: slideIn 0.3s ease forwards;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .player-row:hover {
      border-color: var(--brand-secondary);
      box-shadow: var(--shadow-sm);
      transform: translateX(4px);
    }

    /* Responsive Desktop Grid for Players */
    @media (min-width: 1024px) {
      .player-row {
        /* Adjusted grid pattern to be tighter and fit within 900-1000px container */
        grid-template-columns: minmax(140px, 1.8fr) minmax(100px, 1.2fr) repeat(3, minmax(60px, 0.7fr)) repeat(3, minmax(80px, 0.9fr)) 40px;
        padding: 0.75rem 1rem;
        align-items: center;
        gap: 0.5rem;
        /* Reduced gap from 0.75rem to 0.5rem */
      }
    }

    /* Horizontal Scroll Wrapper for smaller desktops/tablets */
    .players-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      /* Ensure it doesn't break layout if still too wide */
      overflow-x: auto;
      padding-bottom: 0.5rem;
      /* Space for scrollbar if needed */
      -webkit-overflow-scrolling: touch;
    }

    /* Sleek Inputs inside rows */
    .player-row .form-input,
    .player-row .form-select {
      background: transparent;
      border: 1px solid transparent;
      padding: 0.5rem;
      font-size: 0.9rem;
      border-radius: var(--radius-sm);
      box-shadow: none;
    }

    .player-row .form-input:hover,
    .player-row .form-select:hover {
      background: var(--bg-body);
    }

    .player-row .form-input:focus,
    .player-row .form-select:focus {
      background: var(--bg-body);
      border-color: var(--brand-primary);
      box-shadow: none;
    }

    /* Remove Button */
    .btn-remove {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      border: none;
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-remove:hover {
      background: var(--danger);
      color: white;
      transform: rotate(90deg);
    }

    /* ─── Sticky Footer ─── */
    .sticky-footer {
      position: fixed;
      bottom: 2rem;
      padding: 1rem 2rem;
      background: rgba(15, 23, 42, 0.9);
      /* Dark background even on light mode for contrast */
      backdrop-filter: blur(12px);
      color: white;
      border-radius: var(--radius-full);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      z-index: 900;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 1rem;
      align-items: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
      width: 90%;
      max-width: 600px;
      justify-content: space-between;
    }

    /* Template Helper Dropdown */
    .template-dropdown {
      position: relative;
      display: inline-block;
    }

    .template-card {
      position: absolute;
      top: 100%;
      /* Drop DOWN */
      bottom: auto;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 12px;
      /* Small gap from button */
      width: 340px;
      max-width: 90vw;
      /* Prevent mobile overflow */
      background: var(--bg-surface);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xl);
      padding: 1.25rem;
      display: none;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: all 0.2s ease;
    }

    /* Arrow pointing UP */
    .template-card::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      margin-left: -6px;
      border-width: 6px;
      border-style: solid;
      border-color: transparent transparent var(--bg-surface) transparent;
    }

    .template-dropdown:hover .template-card {
      display: block;
      pointer-events: auto;
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .code-block {
      background: #1e293b;
      color: #a78bfa;
      font-family: var(--font-mono);
      padding: 1rem;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      overflow-x: auto;
      margin: 0.5rem 0;
      white-space: pre;
    }

    /* Media Queries */
    @media (max-width: 768px) {
      .dynamic-title {
        font-size: 2.5rem;
      }

      .nav-header {
        padding: 0 1rem;
      }

      .main-content {
        padding: 100px 1rem 120px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .sticky-footer {
        width: 95%;
        bottom: 1rem;
        flex-direction: column;
        border-radius: var(--radius-lg);
      }

      .btn {
        width: 100%;
      }

      .player-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
        padding: 1.5rem;
        border-left: 4px solid var(--brand-primary);
      }
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ─── Format Profile Tabs ─── */
    .profile-tab {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.65rem 1.25rem;
      font-size: 0.9rem;
      font-weight: 600;
      border: none;
      border-bottom: 3px solid transparent;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      top: 2px;
    }

    .profile-tab:hover {
      color: var(--brand-primary);
    }

    .profile-tab.active {
      color: var(--brand-primary);
      border-bottom-color: var(--brand-primary);
    }

    .profile-count-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 5px;
      border-radius: var(--radius-full);
      font-size: 0.7rem;
      font-weight: 700;
      background: var(--border-light);
      color: var(--text-muted);
      transition: all 0.2s ease;
    }

    .profile-tab.active .profile-count-badge,
    .profile-tab.has-players .profile-count-badge {
      background: var(--brand-primary);
      color: white;
    }

    .profile-tab.complete .profile-count-badge {
      background: var(--success);
      color: white;
    }
  </style>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/theme_manage.css') }}">
</head>

<body>
  <!-- Navigation Header -->
  <header class="nav-header">
    <div class="nav-brand">
      <a href="{{ url_for('home') }}" class="home-btn" title="Home">
        <i class="fa-solid fa-house"></i>
      </a>
      <span>SimCricket<span style="color:var(--brand-primary)">X</span></span>
    </div>

    <button class="theme-toggle" id="theme-toggle">
      <i class="fa-solid fa-moon"></i>
    </button>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="dynamic-title" id="dynamic-title">{{ team.team_name if edit else 'Create Team' }}</h1>
      <p class="page-subtitle">Design your championship winning squad with precision and style.</p>
    </div>

    <!-- Error Messages -->
    {% if error %}
    <div class="glass-card" style="border-left: 4px solid var(--danger); padding: 1rem;">
      <div style="color: var(--danger); display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
        <i class="fa-solid fa-circle-exclamation"></i>
        {{ error }}
      </div>
    </div>
    {% endif %}

    <!-- Main Team Form -->
    <form id="team-form" method="POST"
      action="{{ url_for('edit_team', short_code=team.short_code) if edit else url_for('create_team') }}">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <input type="hidden" name="profiles_payload" id="profiles_payload" value="{}">

      <!-- Team Details Section -->
      <div class="glass-card">
        <div class="section-header">
          <div class="section-icon">
            <i class="fa-solid fa-shield-halved"></i>
          </div>
          <div class="section-title">Team Identity</div>
        </div>

        <div class="section-body">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="team_name">Team Name</label>
              <input id="team_name" name="team_name" class="form-input" placeholder="e.g. Mumbai Indians" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="short_code">Short Code</label>
              <input name="short_code" class="form-input" placeholder="e.g. MI" minlength="2" maxlength="3" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="home_ground">Home Ground</label>
              <input name="home_ground" class="form-input" placeholder="e.g. Wankhede Stadium" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="pitch_preference">Pitch Preference</label>
              <select name="pitch_preference" class="form-select" required>
                <option value="">Select Surface</option>
                <option>Green</option>
                <option>Flat</option>
                <option>Dry</option>
                <option>Hard</option>
                <option>Dead</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Team Color</label>
              <div class="color-picker-wrapper" id="color-picker-trigger">
                <div id="color-swatch" class="color-swatch"></div>
                <span style="font-size: 0.9rem; font-weight: 500;">Select Brand Color</span>
                <input type="color" id="team_color" name="team_color" value="#4f46e5" class="color-input" required>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Format Profiles Section -->
      <div class="glass-card">
        <div class="section-header">
          <div class="section-icon">
            <i class="fa-solid fa-layer-group"></i>
          </div>
          <div>
            <div class="section-title">Format Profiles</div>
            <p style="color:var(--text-muted);font-size:0.85rem;margin-top:0.25rem;">
              Each format has its own independent squad. At least one profile is required.
            </p>
          </div>
        </div>

        <div class="section-body">
          <!-- Profile Tabs -->
          <div style="display:flex;gap:0.5rem;margin-bottom:1.5rem;border-bottom:2px solid var(--border-light);padding-bottom:0;">
            <button type="button" class="profile-tab active" data-fmt="T20" id="tab-T20">
              <i class="fa-solid fa-bolt"></i> T20
              <span class="profile-count-badge" id="badge-T20">0</span>
            </button>
            <button type="button" class="profile-tab" data-fmt="ListA" id="tab-ListA">
              <i class="fa-solid fa-cricket-bat-ball"></i> List A / ODI
              <span class="profile-count-badge" id="badge-ListA">0</span>
            </button>

          </div>

          <!-- Profile Panels -->
          <div id="profile-panels">
            <!-- T20 Panel -->
            <div class="profile-panel" id="panel-T20" data-fmt="T20">
              <div class="squad-toolbar">
                <div class="squad-stats">
                  <div class="stat-badge">Squad: <span class="player-counter" id="count-T20">0/25</span></div>
                </div>
                <div class="btn-group">
                  <button type="button" class="btn btn-secondary import-btn" data-fmt="T20">
                    <i class="fa-solid fa-file-import"></i> Import
                  </button>
                  <div class="template-dropdown">
                    <button type="button" class="btn btn-secondary">
                      <i class="fa-solid fa-wand-magic-sparkles"></i> AI Prompt
                    </button>
                    <div class="template-card">
                      <div style="display:flex;justify-content:space-between;margin-bottom:0.5rem;color:var(--text-muted);font-size:0.8rem;text-transform:uppercase;font-weight:700;">
                        <span>JSON Format</span>
                      </div>
                      <div class="code-block" id="json-template-preview">[
  {
    "name": "Player Name",
    "role": "Batsman",
    "bat": 85, "bowl": 20, "field": 80,
    "bhand": "Right", "btype": "", "bhand2": ""
  }
]</div>
                      <button type="button" class="btn btn-primary copy-prompt-btn" data-fmt="T20" style="width:100%;font-size:0.8rem;padding:0.5rem;">
                        <i class="fa-regular fa-copy"></i> Copy AI Prompt
                      </button>
                    </div>
                  </div>
                  <button type="button" class="btn btn-primary add-player-btn" data-fmt="T20">
                    <i class="fa-solid fa-plus"></i> Add Player
                  </button>
                </div>
              </div>
              <div class="players-list profile-players" id="players-T20"></div>
              <!-- Leadership -->
              <div style="margin-top:1.5rem;display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
                <div class="form-group">
                  <label class="form-label">Captain (T20)</label>
                  <select class="form-select profile-captain" data-fmt="T20" id="captain-T20">
                    <option value="">Select Captain</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Wicketkeeper (T20)</label>
                  <select class="form-select profile-wk" data-fmt="T20" id="wk-T20">
                    <option value="">Select Wicketkeeper</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- List A Panel -->
            <div class="profile-panel" id="panel-ListA" data-fmt="ListA" style="display:none;">
              <div class="squad-toolbar">
                <div class="squad-stats">
                  <div class="stat-badge">Squad: <span class="player-counter" id="count-ListA">0/25</span></div>
                </div>
                <div class="btn-group">
                  <button type="button" class="btn btn-secondary copy-from-t20-btn" data-fmt="ListA">
                    <i class="fa-solid fa-copy"></i> Copy from T20
                  </button>
                  <button type="button" class="btn btn-secondary import-btn" data-fmt="ListA">
                    <i class="fa-solid fa-file-import"></i> Import
                  </button>
                  <button type="button" class="btn btn-primary add-player-btn" data-fmt="ListA">
                    <i class="fa-solid fa-plus"></i> Add Player
                  </button>
                </div>
              </div>
              <div class="players-list profile-players" id="players-ListA"></div>
              <div style="margin-top:1.5rem;display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;">
                <div class="form-group">
                  <label class="form-label">Captain (List A)</label>
                  <select class="form-select profile-captain" data-fmt="ListA" id="captain-ListA">
                    <option value="">Select Captain</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Wicketkeeper (List A)</label>
                  <select class="form-select profile-wk" data-fmt="ListA" id="wk-ListA">
                    <option value="">Select Wicketkeeper</option>
                  </select>
                </div>
              </div>
            </div>


          </div>
        </div>
      </div>

      <!-- Sticky Footer Actions -->
      <div class="sticky-footer">
        <div style="font-size: 0.9rem; opacity: 0.8; display: flex; flex-direction: column;">
          <span>{% if edit %}Editing <strong>{{ team.short_code }}</strong>{% else %}Creating New Team{% endif %}</span>
          <span id="auto-save-status"
            style="font-size: 0.75rem; color: var(--success); opacity: 0; transition: opacity 0.5s ease;">
            <i class="fa-solid fa-check"></i> Saved to browser
          </span>
        </div>
        <div class="btn-group">
          <!-- Validation Feedback -->
          <div id="validation-feedback"
            style="display: flex; flex-direction: column; justify-content: center; align-items: flex-end; margin-right: 1rem; font-size: 0.8rem; color: var(--warning);">
            <!-- Dynamic errors will appear here -->
          </div>
          {% if edit %}
          <a href="{{ url_for('manage_teams') }}" class="btn btn-secondary"
            style="background: rgba(255,255,255,0.1); color: white; border: none;">
            Cancel
          </a>
          <!-- Save as Draft removed -->
          {% else %}
          <button type="button" class="btn btn-secondary" id="clear-draft"
            style="background: rgba(255,255,255,0.1); color: white; border: none;">
            Clear Draft
          </button>

          <!-- Save as Draft removed -->
          {% endif %}

          <button type="submit" name="action" value="publish" class="btn btn-primary" id="btn-publish">
            <i class="fa-solid fa-floppy-disk"></i>
            {{ 'Save Changes' if edit else 'Create Team' }}
          </button>
        </div>
      </div>

    </form>
  </main>

  <!-- Player Row Template -->
  <template id="player-template">
    <div class="player-row">
      <input name="player_name" class="form-input" placeholder="Player Name" required>
      <select name="player_role" class="form-select" required>
        <option value="">Role</option>
        <option>Batsman</option>
        <option>Bowler</option>
        <option>All-rounder</option>
        <option>Wicketkeeper</option>
      </select>
      <input type="number" name="batting_rating" class="form-input" placeholder="Bat" min="0" max="100" title="Batting Rating" required>
      <input type="number" name="bowling_rating" class="form-input" placeholder="Bowl" min="0" max="100" title="Bowling Rating" required>
      <input type="number" name="fielding_rating" class="form-input" placeholder="Fld" min="0" max="100" title="Fielding Rating" required>
      <select name="batting_hand" class="form-select" required>
        <option value="">Bat Hand</option>
        <option>Left</option>
        <option>Right</option>
      </select>
      <select name="bowling_type" class="form-select">
        <option value="">Bowl Type</option>
        <option>Fast</option>
        <option>Fast-medium</option>
        <option>Medium-fast</option>
        <option>Medium</option>
        <option>Off spin</option>
        <option>Leg spin</option>
        <option>Finger spin</option>
        <option>Wrist spin</option>
      </select>
      <select name="bowling_hand" class="form-select">
        <option value="">Bowl Hand</option>
        <option>Left</option>
        <option>Right</option>
      </select>
      <button type="button" class="btn-remove player-remove" title="Remove Player">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
  </template>

  <!-- Data Injection -->
  <script id="edit-mode-data" type="application/json">{{ 'true' if edit else 'false' }}</script>
  <script id="team-data-json" type="application/json">{{ team | tojson | safe if edit else 'null' }}</script>

  <script>
    // ─── Constants & State ────────────────────────────────────────
    const EDIT_MODE = JSON.parse(document.getElementById('edit-mode-data').textContent);
    let TEAM_DATA = null;
    try { TEAM_DATA = JSON.parse(document.getElementById('team-data-json').textContent); }
    catch (e) { console.error("Failed to parse team data", e); }

    const FORMATS = ['T20', 'ListA'];
    const MAX = 25, MIN = 12;
    const DRAFT_KEY = 'team_create_draft_v2';

    // ─── Tab switching ────────────────────────────────────────────
    document.querySelectorAll('.profile-tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const fmt = tab.dataset.fmt;
        document.querySelectorAll('.profile-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.profile-panel').forEach(p => p.style.display = 'none');
        tab.classList.add('active');
        document.getElementById('panel-' + fmt).style.display = 'block';
      });
    });

    // ─── Per-profile player management ────────────────────────────

    function getContainer(fmt) { return document.getElementById('players-' + fmt); }
    function getCountEl(fmt)  { return document.getElementById('count-' + fmt); }
    function getBadge(fmt)    { return document.getElementById('badge-' + fmt); }
    function getCaptainSel(fmt) { return document.getElementById('captain-' + fmt); }
    function getWkSel(fmt)      { return document.getElementById('wk-' + fmt); }

    function createPlayerCard(data) {
      const tpl = document.getElementById('player-template').content.cloneNode(true);
      const card = tpl.querySelector('.player-row');
      if (data) {
        card.querySelector('[name=player_name]').value = data.name || '';
        const validRoles = ['Batsman','Bowler','All-rounder','Wicketkeeper'];
        card.querySelector('[name=player_role]').value = validRoles.includes(data.role) ? data.role : 'Batsman';
        card.querySelector('[name=batting_rating]').value  = data.bat  ?? data.batting_rating  ?? '';
        card.querySelector('[name=bowling_rating]').value  = data.bowl ?? data.bowling_rating  ?? '';
        card.querySelector('[name=fielding_rating]').value = data.field?? data.fielding_rating ?? '';
        card.querySelector('[name=batting_hand]').value    = data.bhand || data.batting_hand  || '';
        card.querySelector('[name=bowling_type]').value    = data.btype || data.bowling_type  || '';
        card.querySelector('[name=bowling_hand]').value    = data.bhand2|| data.bowling_hand  || '';
      }
      return card;
    }

    function wireCard(card, fmt) {
      const roleSelect  = card.querySelector('[name=player_role]');
      const btypeSelect = card.querySelector('[name=bowling_type]');
      const bhand2Select= card.querySelector('[name=bowling_hand]');

      function applyRoleConstraints() {
        if (roleSelect.value === 'Wicketkeeper') {
          btypeSelect.value = ''; bhand2Select.value = '';
          btypeSelect.disabled = bhand2Select.disabled = true;
          btypeSelect.style.opacity = bhand2Select.style.opacity = '0.5';
        } else {
          btypeSelect.disabled = bhand2Select.disabled = false;
          btypeSelect.style.opacity = bhand2Select.style.opacity = '1';
        }
        refreshProfileSelectors(fmt);
        updateSubmitButtons();
      }
      roleSelect.addEventListener('change', applyRoleConstraints);
      applyRoleConstraints();

      card.querySelector('[name=player_name]').addEventListener('input', () => {
        refreshProfileSelectors(fmt); updateSubmitButtons();
      });
      card.querySelectorAll('input, select').forEach(el => {
        el.addEventListener('input',  () => { updateSubmitButtons(); if (!EDIT_MODE) saveDraft(); });
        el.addEventListener('change', () => { updateSubmitButtons(); if (!EDIT_MODE) saveDraft(); });
      });

      card.querySelector('.player-remove').onclick = () => {
        card.style.transform = 'translateX(20px)';
        card.style.opacity = '0';
        setTimeout(() => { card.remove(); updateProfileCount(fmt); updateSubmitButtons(); }, 300);
      };
    }

    function addPlayerToProfile(fmt, data, autoUpdate = true) {
      const cont = getContainer(fmt);
      if (cont.children.length >= MAX) return;
      const card = createPlayerCard(data);
      wireCard(card, fmt);
      cont.appendChild(card);
      if (autoUpdate) { updateProfileCount(fmt); refreshProfileSelectors(fmt); updateSubmitButtons(); }
    }

    function updateProfileCount(fmt) {
      const cont  = getContainer(fmt);
      const count = cont.children.length;
      const countEl = getCountEl(fmt);
      const badge   = getBadge(fmt);

      countEl.textContent = `${count} / ${MAX}`;
      badge.textContent = count;

      const tab = document.getElementById('tab-' + fmt);
      tab.classList.toggle('has-players', count > 0);
      tab.classList.toggle('complete', count >= MIN);

      if (count < MIN && count > 0) {
        countEl.style.color = '#dc3545';
      } else if (count >= MIN) {
        countEl.style.color = '#10b981';
      } else {
        countEl.style.color = '';
      }

      refreshProfileSelectors(fmt);
      if (!EDIT_MODE) saveDraft();
    }

    function refreshProfileSelectors(fmt) {
      const cont    = getContainer(fmt);
      const capSel  = getCaptainSel(fmt);
      const wkSel   = getWkSel(fmt);
      const curCap  = capSel.value;
      const curWk   = wkSel.value;
      const cards   = [...cont.querySelectorAll('.player-row')];

      capSel.innerHTML = '<option value="">Select Captain</option>';
      cards.forEach(c => {
        const n = c.querySelector('[name=player_name]').value.trim();
        if (n) {
          const o = document.createElement('option');
          o.value = o.textContent = n;
          if (n === curCap) o.selected = true;
          capSel.appendChild(o);
        }
      });

      wkSel.innerHTML = '<option value="">Select Wicketkeeper</option>';
      cards.filter(c => c.querySelector('[name=player_role]').value === 'Wicketkeeper')
        .forEach(c => {
          const n = c.querySelector('[name=player_name]').value.trim();
          if (n) {
            const o = document.createElement('option');
            o.value = o.textContent = n;
            if (n === curWk) o.selected = true;
            wkSel.appendChild(o);
          }
        });
    }

    // ─── "Add Player" buttons ─────────────────────────────────────
    document.querySelectorAll('.add-player-btn').forEach(btn => {
      btn.addEventListener('click', () => addPlayerToProfile(btn.dataset.fmt));
    });

    // ─── Import JSON ──────────────────────────────────────────────
    document.querySelectorAll('.import-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const fmt = btn.dataset.fmt;
        const jsonStr = prompt(`Paste JSON array for ${fmt} squad:`);
        if (!jsonStr) return;
        try {
          const data = JSON.parse(jsonStr);
          if (!Array.isArray(data)) throw new Error("Must be a JSON array");
          const cont = getContainer(fmt);
          if (cont.children.length > 0 && !confirm("Replace current squad?")) return;
          cont.innerHTML = '';
          data.forEach(p => addPlayerToProfile(fmt, p, false));
          updateProfileCount(fmt);
          refreshProfileSelectors(fmt);
          setTimeout(updateSubmitButtons, 100);
        } catch (e) { alert("Invalid JSON: " + e.message); }
      });
    });

    // ─── Copy from T20 ────────────────────────────────────────────
    document.querySelectorAll('.copy-from-t20-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const targetFmt = btn.dataset.fmt;
        const t20Cont = getContainer('T20');
        const cards = [...t20Cont.querySelectorAll('.player-row')];
        if (cards.length === 0) { alert('T20 profile is empty. Add players to T20 first.'); return; }
        const targetCont = getContainer(targetFmt);
        if (targetCont.children.length > 0 && !confirm(`Replace ${targetFmt} squad with T20 squad?`)) return;
        targetCont.innerHTML = '';
        cards.forEach(card => {
          const p = {
            name:   card.querySelector('[name=player_name]').value,
            role:   card.querySelector('[name=player_role]').value,
            bat:    card.querySelector('[name=batting_rating]').value,
            bowl:   card.querySelector('[name=bowling_rating]').value,
            field:  card.querySelector('[name=fielding_rating]').value,
            bhand:  card.querySelector('[name=batting_hand]').value,
            btype:  card.querySelector('[name=bowling_type]').value,
            bhand2: card.querySelector('[name=bowling_hand]').value,
          };
          addPlayerToProfile(targetFmt, p, false);
        });
        updateProfileCount(targetFmt);
        refreshProfileSelectors(targetFmt);
        // Copy captain/wk selections too
        const t20Cap = getCaptainSel('T20').value;
        const t20Wk  = getWkSel('T20').value;
        setTimeout(() => {
          if (t20Cap) getCaptainSel(targetFmt).value = t20Cap;
          if (t20Wk)  getWkSel(targetFmt).value = t20Wk;
          updateSubmitButtons();
        }, 50);
      });
    });

    // ─── AI Prompt copy ───────────────────────────────────────────
    document.querySelectorAll('.copy-prompt-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const fmt = btn.dataset.fmt;
        const teamName   = document.getElementById('team_name').value || '[Team Name]';
        const shortCode  = document.querySelector('[name=short_code]').value || '[Code]';
        const homeGround = document.querySelector('[name=home_ground]').value || '[Ground]';
        const pitchPref  = document.querySelector('[name=pitch_preference]').value || 'Flat';
        const templateTxt= document.getElementById('json-template-preview').innerText;
        const promptText = `Generate a JSON squad for ${fmt} cricket for team "${teamName}" (${shortCode}).
Home ground: ${homeGround}, pitch: ${pitchPref}.
Requirements:
- JSON array, 12–25 players
- At least 5 Batsmen, 1 Wicketkeeper, 6 Bowlers/All-rounders
- Ratings 0–100 (stars 85–95, regulars 70–84)
- Bowling types: Fast, Fast-medium, Medium-fast, Medium, Off spin, Leg spin, Finger spin, Wrist spin
Format:\n${templateTxt}\nReturn ONLY the JSON array.`;
        navigator.clipboard.writeText(promptText).then(() => {
          const orig = btn.innerHTML;
          btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
          setTimeout(() => { btn.innerHTML = orig; }, 2000);
        }).catch(() => alert('Clipboard access denied'));
      });
    });

    // ─── Validation ───────────────────────────────────────────────
    function checkValidity() {
      const errors = [];
      if (!document.getElementById('team_name').value.trim()) errors.push('Team Name required');
      if (!document.querySelector('[name=short_code]').value.trim()) errors.push('Short Code required');
      if (!document.querySelector('[name=home_ground]').value.trim()) errors.push('Home Ground required');
      if (!document.querySelector('[name=pitch_preference]').value) errors.push('Pitch Preference required');

      let anyComplete = false;
      for (const fmt of FORMATS) {
        const cont  = getContainer(fmt);
        const cards = [...cont.querySelectorAll('.player-row')];
        if (cards.length === 0) continue; // empty profile — skip

        // Field completeness
        let missingFields = false;
        for (const c of cards) {
          const n  = c.querySelector('[name=player_name]').value.trim();
          const r  = c.querySelector('[name=player_role]').value;
          const bh = c.querySelector('[name=batting_hand]').value;
          const bt = c.querySelector('[name=bowling_type]').value;
          const bh2= c.querySelector('[name=bowling_hand]').value;
          if (!n || !r || !bh) { missingFields = true; break; }
          if (bt && !bh2) errors.push(`${fmt}: set Bowling Hand for ${n}`);
        }
        if (missingFields) { errors.push(`${fmt}: complete all player fields`); continue; }

        if (cards.length < MIN) { errors.push(`${fmt}: need at least ${MIN} players (have ${cards.length})`); continue; }
        if (cards.length > MAX) { errors.push(`${fmt}: max ${MAX} players`); continue; }

        const wkCount   = cards.filter(c => c.querySelector('[name=player_role]').value === 'Wicketkeeper').length;
        const bowlCount = cards.filter(c => ['Bowler','All-rounder'].includes(c.querySelector('[name=player_role]').value)).length;
        if (wkCount < 1)   errors.push(`${fmt}: need 1+ Wicketkeeper`);
        if (bowlCount < 6) errors.push(`${fmt}: need 6+ Bowlers/All-rounders`);

        if (!getCaptainSel(fmt).value) errors.push(`${fmt}: select a Captain`);
        if (!getWkSel(fmt).value)      errors.push(`${fmt}: select a Wicketkeeper`);

        if (wkCount >= 1 && bowlCount >= 6 && cards.length >= MIN && getCaptainSel(fmt).value && getWkSel(fmt).value) {
          anyComplete = true;
        }
      }
      if (!anyComplete && errors.filter(e => e.includes('required')).length === 0) {
        errors.push('At least one complete profile (T20, List A, or First Class) is required');
      }
      return { valid: errors.length === 0, errors };
    }

    function updateSubmitButtons() {
      const { valid, errors } = checkValidity();
      const btn = document.getElementById('btn-publish');
      const feed= document.getElementById('validation-feedback');
      if (feed) {
        if (!valid) {
          const show = errors.slice(0, 2);
          const more = errors.length > 2 ? ` (+${errors.length-2} more)` : '';
          feed.innerHTML = show.map(e => `<span><i class="fa-solid fa-circle-exclamation"></i> ${e}</span>`).join('') + (more ? `<span>${more}</span>` : '');
          feed.style.color = 'var(--warning)';
        } else {
          feed.innerHTML = '<span style="color:var(--success)"><i class="fa-solid fa-check"></i> Ready to Publish</span>';
        }
      }
      if (btn) {
        btn.disabled = !valid;
        btn.style.opacity = valid ? '1' : '0.5';
        btn.style.cursor  = valid ? 'pointer' : 'not-allowed';
      }
    }

    // ─── Serialize profiles on submit ─────────────────────────────
    const profilesPayloadInput = document.getElementById('profiles_payload');

    function syncProfilesPayload() {
      const payload = {};
      for (const fmt of FORMATS) {
        const cont  = getContainer(fmt);
        const cards = [...cont.querySelectorAll('.player-row')];
        if (cards.length === 0) continue;
        payload[fmt] = {
          captain:     getCaptainSel(fmt).value,
          wicketkeeper:getWkSel(fmt).value,
          players: cards.map(c => ({
            name:            c.querySelector('[name=player_name]').value.trim(),
            role:            c.querySelector('[name=player_role]').value,
            batting_rating:  parseInt(c.querySelector('[name=batting_rating]').value) || 0,
            bowling_rating:  parseInt(c.querySelector('[name=bowling_rating]').value) || 0,
            fielding_rating: parseInt(c.querySelector('[name=fielding_rating]').value) || 0,
            batting_hand:    c.querySelector('[name=batting_hand]').value,
            bowling_type:    c.querySelector('[name=bowling_type]').value,
            bowling_hand:    c.querySelector('[name=bowling_hand]').value,
          }))
        };
      }
      profilesPayloadInput.value = JSON.stringify(payload);
    }

    document.getElementById('team-form').addEventListener('submit', syncProfilesPayload);

    // ─── Edit-mode prefill ────────────────────────────────────────
    if (EDIT_MODE && TEAM_DATA) {
      document.getElementById('team_name').value = TEAM_DATA.team_name || '';
      document.querySelector('[name=short_code]').value    = TEAM_DATA.short_code || '';
      document.querySelector('[name=home_ground]').value   = TEAM_DATA.home_ground || '';
      document.querySelector('[name=pitch_preference]').value = TEAM_DATA.pitch_preference || '';
      document.getElementById('team_color').value = TEAM_DATA.team_color || '#4f46e5';
      document.getElementById('color-swatch').style.background = TEAM_DATA.team_color || '#4f46e5';

      const profiles = TEAM_DATA.profiles || {};
      for (const fmt of FORMATS) {
        const pdata = profiles[fmt];
        if (!pdata) continue;
        const container = getContainer(fmt);
        container.innerHTML = '';
        (pdata.players || []).forEach(p => addPlayerToProfile(fmt, p, false));
        updateProfileCount(fmt);
        refreshProfileSelectors(fmt);
        setTimeout(() => {
          if (pdata.captain)     getCaptainSel(fmt).value = pdata.captain;
          if (pdata.wicketkeeper)getWkSel(fmt).value      = pdata.wicketkeeper;
          updateSubmitButtons();
        }, 50);
      }
      updateSubmitButtons();
    }

    // ─── Color swatch ─────────────────────────────────────────────
    const colorInput = document.getElementById('team_color');
    const swatch     = document.getElementById('color-swatch');
    swatch.style.background = colorInput.value;
    swatch.onclick = () => colorInput.click();
    colorInput.addEventListener('input',  e => { swatch.style.background = e.target.value; if (!EDIT_MODE) saveDraft(); });
    colorInput.addEventListener('change', e => { swatch.style.background = e.target.value; if (!EDIT_MODE) saveDraft(); });

    // ─── Team-info field listeners ────────────────────────────────
    ['team_name','short_code','home_ground','pitch_preference'].forEach(n => {
      const el = document.querySelector(`[name="${n}"], #${n}`);
      if (el) {
        el.addEventListener('input',  () => { updateSubmitButtons(); if (!EDIT_MODE) saveDraft(); });
        el.addEventListener('change', () => { updateSubmitButtons(); if (!EDIT_MODE) saveDraft(); });
      }
    });

    // Dynamic title
    const teamInput = document.getElementById('team_name');
    const titleEl   = document.getElementById('dynamic-title');
    teamInput.addEventListener('input', () => { titleEl.textContent = teamInput.value || 'Team Creation'; });

    updateSubmitButtons();
  </script>

  <script>
    // ─── Theme toggle ─────────────────────────────────────────────
    document.addEventListener('DOMContentLoaded', () => {
      const root = document.documentElement;
      const btn  = document.getElementById('theme-toggle');
      const icon = btn.querySelector('i');
      const saved = localStorage.getItem('theme') || 'light';
      root.setAttribute('data-theme', saved);
      function updateIcon(t) {
        icon.classList.toggle('fa-sun',  t === 'dark');
        icon.classList.toggle('fa-moon', t !== 'dark');
      }
      updateIcon(saved);
      btn.addEventListener('click', () => {
        const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
        root.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        updateIcon(next);
      });
    });

    // ─── Draft (localStorage) ─────────────────────────────────────
    const clearDraftBtn = document.getElementById('clear-draft');

    function saveDraft() {
      if (EDIT_MODE) return;
      const draft = {
        team_name:        document.getElementById('team_name').value,
        short_code:       document.querySelector('[name=short_code]').value,
        home_ground:      document.querySelector('[name=home_ground]').value,
        pitch_preference: document.querySelector('[name=pitch_preference]').value,
        team_color:       document.getElementById('team_color').value,
        profiles: {},
        timestamp: Date.now(),
      };
      for (const fmt of FORMATS) {
        const cont  = getContainer(fmt);
        const cards = [...cont.querySelectorAll('.player-row')];
        if (cards.length === 0) continue;
        draft.profiles[fmt] = {
          captain:      getCaptainSel(fmt).value,
          wicketkeeper: getWkSel(fmt).value,
          players: cards.map(c => ({
            name:   c.querySelector('[name=player_name]').value,
            role:   c.querySelector('[name=player_role]').value,
            bat:    c.querySelector('[name=batting_rating]').value,
            bowl:   c.querySelector('[name=bowling_rating]').value,
            field:  c.querySelector('[name=fielding_rating]').value,
            bhand:  c.querySelector('[name=batting_hand]').value,
            btype:  c.querySelector('[name=bowling_type]').value,
            bhand2: c.querySelector('[name=bowling_hand]').value,
          }))
        };
      }
      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
      const status = document.getElementById('auto-save-status');
      if (status) {
        status.style.opacity = '1';
        clearTimeout(window._saveTimeout);
        window._saveTimeout = setTimeout(() => { status.style.opacity = '0'; }, 2000);
      }
    }

    function loadDraft() {
      if (EDIT_MODE) return;
      const raw = localStorage.getItem(DRAFT_KEY);
      if (!raw) return;
      try {
        const draft = JSON.parse(raw);
        document.getElementById('team_name').value = draft.team_name || '';
        document.querySelector('[name=short_code]').value      = draft.short_code || '';
        document.querySelector('[name=home_ground]').value     = draft.home_ground || '';
        document.querySelector('[name=pitch_preference]').value= draft.pitch_preference || '';
        if (draft.team_color) {
          document.getElementById('team_color').value = draft.team_color;
          document.getElementById('color-swatch').style.background = draft.team_color;
        }
        const profiles = draft.profiles || {};
        for (const fmt of FORMATS) {
          if (!profiles[fmt]) continue;
          const cont = getContainer(fmt);
          cont.innerHTML = '';
          (profiles[fmt].players || []).forEach(p => addPlayerToProfile(fmt, p, false));
          updateProfileCount(fmt);
          refreshProfileSelectors(fmt);
          setTimeout(() => {
            if (profiles[fmt].captain)      getCaptainSel(fmt).value = profiles[fmt].captain;
            if (profiles[fmt].wicketkeeper) getWkSel(fmt).value      = profiles[fmt].wicketkeeper;
            updateSubmitButtons();
          }, 100);
        }
        updateSubmitButtons();
      } catch (e) { console.error('Error loading draft', e); }
    }

    if (clearDraftBtn) {
      clearDraftBtn.onclick = () => {
        if (confirm('Clear the form? This cannot be undone.')) {
          localStorage.removeItem(DRAFT_KEY);
          location.reload();
        }
      };
    }

    if (!EDIT_MODE) loadDraft();
  </script>

</body>

</html>
