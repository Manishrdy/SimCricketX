<!DOCTYPE html>
<html lang="en">

<head>
  <script>
    const saved = localStorage.getItem('theme');
    if (saved) document.documentElement.setAttribute('data-theme', saved);
  </script>
  <meta charset="UTF-8">
  <title>{{ "Edit Team" if edit else "Create Team" }} – Project X</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Reset + Icons -->
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

  <style>
    :root {
      --bg: #f0f4f9;
      --fg: #333;
      --card-bg: #fff;
      --accent: #005fcc;
      --shadow: rgba(0, 0, 0, 0.1);
      --gradient: linear-gradient(135deg, #6a11cb, #2575fc);
      --border: 1px solid var(--accent);
      --input-bg: #eaeaea;
    }

    [data-theme="dark"] {
      --bg: #0d1117;
      --fg: #eaeaea;
      --card-bg: #161b22;
      --accent: #00bcd4;
      --shadow: rgba(0, 0, 0, 0.6);
      --gradient: linear-gradient(135deg, #00bcd4, #8bc34a);
      --border: 1px solid var(--accent);
      --input-bg: #2a2a2a;
    }

    /* ─── Light Themes ───────────────────────────────── */
    :root[data-theme="nord"] {
      --bg: #eceff4;
      --fg: #2e3440;
      --card-bg: #e5e9f0;
      --input-bg: #dde1e8;
      --accent: #88c0d0;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    :root[data-theme="retro"] {
      --bg: #fdf0d5;
      --fg: #4b3621;
      --card-bg: #fff7e6;
      --input-bg: #f7e6c5;
      --accent: #d97706;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    :root[data-theme="cupcake"] {
      --bg: #fffaf0;
      --fg: #4b2995;
      --card-bg: #faf5ff;
      --input-bg: #f3e8ff;
      --accent: #d946ef;
      --shadow: rgba(0, 0, 0, 0.1);
    }

    /* ─── Dark Themes ────────────────────────────────── */
    :root[data-theme="dim"] {
      --bg: #1f1f1f;
      --fg: #e0e0e0;
      --card-bg: #2a2a2a;
      --input-bg: #333;
      --accent: #6366f1;
      --shadow: rgba(0, 0, 0, 0.5);
    }

    :root[data-theme="dracula"] {
      --bg: #282a36;
      --fg: #f8f8f2;
      --card-bg: #44475a;
      --input-bg: #373844;
      --accent: #6272a4;
      --shadow: rgba(0, 0, 0, 0.6);
    }

    :root[data-theme="sunset"] {
      --bg: #2d182d;
      --fg: #f5e0dc;
      --card-bg: #3c1f1f;
      --input-bg: #5f3d3d;
      --accent: #f28fb6;
      --shadow: rgba(0, 0, 0, 0.6);
    }

    /* ─── Light Themes ─────────────── */
    :root[data-theme="nord"] {
      --bg: #eceff4;
      --fg: #2e3440;
      --card-bg: #e5e9f0;
      --input-bg: #dde1e8;
      --accent: #88c0d0;
      --icon-color: #5e81ac;
      --gradient: linear-gradient(135deg, #8fbcbb, #88c0d0);
    }

    :root[data-theme="retro"] {
      --bg: #fdf0d5;
      --fg: #4b3621;
      --card-bg: #fff7e6;
      --input-bg: #f7e6c5;
      --accent: #d97706;
      --icon-color: #b45309;
      --gradient: linear-gradient(135deg, #d97706, #f59e0b);
    }

    :root[data-theme="cupcake"] {
      --bg: #fffaf0;
      --fg: #4b2995;
      --card-bg: #faf5ff;
      --input-bg: #f3e8ff;
      --accent: #d946ef;
      --icon-color: #a21caf;
      --gradient: linear-gradient(135deg, #f472b6, #d946ef);
    }

    /* ─── Dark Themes ──────────────── */
    :root[data-theme="dim"] {
      --bg: #1f1f1f;
      --fg: #e0e0e0;
      --card-bg: #2a2a2a;
      --input-bg: #333;
      --accent: #6366f1;
      --icon-color: #818cf8;
      --gradient: linear-gradient(135deg, #4f46e5, #6366f1);
    }

    :root[data-theme="dracula"] {
      --bg: #282a36;
      --fg: #f8f8f2;
      --card-bg: #44475a;
      --input-bg: #373844;
      --accent: #6272a4;
      --icon-color: #8be9fd;
      --gradient: linear-gradient(135deg, #6272a4, #8be9fd);
    }

    :root[data-theme="sunset"] {
      --bg: #2d182d;
      --fg: #f5e0dc;
      --card-bg: #3c1f1f;
      --input-bg: #5f3d3d;
      --accent: #f28fb6;
      --icon-color: #ff9ede;
      --gradient: linear-gradient(135deg, #fb7185, #f28fb6);
    }



    body {
      background: var(--bg);
      color: var(--fg);
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      justify-content: center;
      padding: 2rem;
    }

    .toggle {
      position: fixed;
      top: 1rem;
      right: 1rem;
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--fg);
    }

    .card {
      background: var(--card-bg);
      border-radius: 1rem;
      box-shadow: 0 10px 30px var(--shadow);
      padding: 2rem;
      width: 100%;
      max-width: 900px;
      animation: fadeIn 0.8s ease;
    }

    h1 {
      font-size: 2rem;
      text-align: center;
      margin-bottom: 1.5rem;
      background: var(--gradient);
      -webkit-background-clip: text;
      color: transparent;
    }

    form>.form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .form-grid input,
    .form-grid select {
      padding: 0.6rem;
      border-radius: 0.5rem;
      border: var(--border);
      background: var(--input-bg);
      color: var(--fg);
      font-size: 1rem;
      width: 100%;
      box-sizing: border-box;
    }

    .color-picker {
      width: 2rem;
      height: 2rem;
      padding: 0;
      border: none;
      cursor: pointer;
      border-radius: 0.25rem;
    }

    .buttons {
      display: flex;
      justify-content: flex-end;
      gap: 1rem;
      flex-wrap: wrap;
      margin-bottom: 1rem;
    }

    .buttons .btn {
      padding: 0.6rem 1.2rem;
      border-radius: 0.5rem;
      border: none;
      background: var(--accent);
      color: #fff;
      cursor: pointer;
      font-size: 0.95rem;
    }

    .buttons .btn.secondary {
      background: transparent;
      color: var(--accent);
      border: var(--border);
    }

    .btn {
      border-radius: 0.5rem;
      font-weight: 500;
      cursor: pointer;
    }

    .btn.secondary {
      background: transparent;
      border: 2px solid var(--accent);
      color: var(--accent);
    }


    #player-count {
      margin-left: auto;
      align-self: center;
      font-size: 0.9rem;
    }

    #players-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .player-card {
      background: var(--card-bg);
      border: var(--border);
      border-radius: 0.75rem;
      padding: 1rem;
      position: relative;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.5rem;
    }

    .player-card .remove {
      position: absolute;
      top: -8px;
      /* pull it outside the card a bit */
      right: -8px;
      /* same on the right */
      background: var(--accent);
      color: #fff;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 6px var(--shadow);
      cursor: pointer;
      z-index: 1;
    }

    .player-card input,
    .player-card select {
      width: 100%;
      padding: 0.4rem;
      border-radius: 0.4rem;
      border: var(--border);
      background: var(--input-bg);
      color: var(--fg);
      font-size: 0.9rem;
    }

    .flash {
      padding: 0.75rem;
      border-radius: 0.5rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
    }

    .alert-success {
      background: #d1e7dd;
      color: #0f5132;
    }

    .alert-danger {
      background: #f8d7da;
      color: #842029;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <!-- Dark/Light Toggle -->
  <button class="toggle" id="theme-toggle">🌙</button>


  <div class="card" style="position:relative;">
    <!-- Home icon -->
    <a href="{{ url_for('home') }}" style="
        position:absolute; top:1rem; left:1rem;
        color:var(--accent); font-size:1.3rem;
      " title="Home">
      <i class="fa-solid fa-house"></i>
    </a>

    <h1 id="dynamic-title">{{ team.team_name if edit else 'Team Creation' }}</h1>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, msg in messages %}
    <div class="flash alert-{{category}}">{{msg}}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <form id="team-form" method="POST"
      action="{{ url_for('edit_team', short_code=team.short_code) if edit else url_for('create_team') }}">

      <div class="submit-row"
        style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 0.75rem; flex-wrap: wrap;">
        {% if edit %}
        <a href="{{ url_for('manage_teams') }}" class="btn secondary" style="
      display: inline-flex;
      align-items: center;
      padding: 0.4rem 0.9rem;
      font-size: 0.85rem;
      gap: 0.4rem;
    ">
          <i class="fa-solid fa-xmark-circle"></i> Cancel
        </a>
        {% endif %}
        <button type="submit" class="btn" style="
    display: inline-flex;
    align-items: center;
    padding: 0.4rem 0.9rem;
    font-size: 0.85rem;
    gap: 0.4rem;
    background: var(--accent);
    color: #fff;
    border: none;
  ">
          <i class="fa-solid fa-cloud-upload-alt"></i>
          {{ 'Update Team' if edit else 'Save Team' }}
        </button>
      </div>

      <!-- Team Details Grid -->
      <div class="form-grid">
        <input id="team_name" name="team_name" placeholder="Team Name" required>
        <input name="short_code" placeholder="Short Code (2-3 chars)" minlength="2" maxlength="3" required>
        <input name="home_ground" placeholder="Home Ground" required>
        <select name="pitch_preference" required>
          <option value="">Pitch Preference</option>
          <option>Green</option>
          <option>Flat</option>
          <option>Dry</option>
          <option>Hard</option>
          <option>Dead</option>
        </select>

        <!-- Replace your current “Color Swatch” block with this -->
        <div style="display:flex; align-items:center; gap:0.5rem;">
          <label style="margin:0;" for="team_color">Team Color</label>
          <div style="position:relative; width:24px; height:24px;">
            <input type="color" id="team_color" name="team_color" value="#ff4500" required style="
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
        opacity:0;
        cursor:pointer;
      ">
            <div id="color-swatch" style="
        width:100%; height:100%;
        border:2px solid var(--accent);
        border-radius:4px;
        background:#ff4500;
        pointer-events:none;
      "></div>
          </div>
        </div>


      </div>

      <!-- Action Buttons & Counter -->
      <div class="buttons">
        <button type="button" class="btn secondary" id="add-player">+ Add Player</button>
        <button type="button" class="btn secondary" id="generate-team">⚙️ Generate Team</button>
        <span id="player-count">0 / 18</span>
      </div>

      <!-- Players Grid -->
      <div id="players-container"></div>

      <!-- Select captain & wicket-keeperr -->
      <div class="form-grid" style="margin-top:1rem;">
        <select name="captain" id="select-captain" required>
          <option value="">Select Captain</option>
        </select>
        <select name="wicketkeeper" id="select-wk" required>
          <option value="">Select Wicketkeeper</option>
        </select>
      </div>

      <!-- Save / Cancel -->
      <div class="submit-row"
        style="margin-top: 2rem; display: flex; justify-content: flex-end; gap: 0.75rem; flex-wrap: wrap;">
        {% if edit %}
        <a href="{{ url_for('manage_teams') }}" class="btn secondary" style="
      display: inline-flex;
      align-items: center;
      padding: 0.4rem 0.9rem;
      font-size: 0.85rem;
      gap: 0.4rem;
    ">
          <i class="fa-solid fa-xmark-circle"></i> Cancel
        </a>
        {% endif %}
        <button type="submit" class="btn" style="
    display: inline-flex;
    align-items: center;
    padding: 0.4rem 0.9rem;
    font-size: 0.85rem;
    gap: 0.4rem;
    background: var(--accent);
    color: #fff;
    border: none;
  ">
          <i class="fa-solid fa-cloud-upload-alt"></i>
          {{ 'Update Team' if edit else 'Save Team' }}
        </button>
      </div>

    </form>
  </div>

  <!-- Player Template -->
  <template id="player-template">
    <div class="player-card">
      <span class="remove"><i class="fa-solid fa-xmark"></i></span>
      <input name="player_name" placeholder="Player Name" required>
      <select name="player_role" required>
        <option value="">Role</option>
        <option>Batsman</option>
        <option>Bowler</option>
        <option>All-rounder</option>
        <option>Wicketkeeper</option>
      </select>
      <input type="number" name="batting_rating" placeholder="Batting (0-100)" min="0" max="100" required>
      <input type="number" name="bowling_rating" placeholder="Bowling (0-100)" min="0" max="100" required>
      <input type="number" name="fielding_rating" placeholder="Fielding (0-100)" min="0" max="100" required>
      <select name="batting_hand" required>
        <option value="">Batting Hand</option>
        <option>Left</option>
        <option>Right</option>
      </select>
      <select name="bowling_type">
        <option value="">Bowling Type</option>
        <option>Fast</option>
        <option>Fast-medium</option>
        <option>Medium-fast</option>
        <option>Medium</option>
        <option>Off spin</option>
        <option>Leg spin</option>
        <option>Finger spin</option>
        <option>Wrist spin</option>
      </select>
      <select name="bowling_hand">
        <option value="">Bowling Hand</option>
        <option>Left</option>
        <option>Right</option>
      </select>
    </div>
  </template>

  <script>

    // Dynamic Title
    const teamInput = document.getElementById('team_name');
    const titleEl = document.getElementById('dynamic-title');
    teamInput.oninput = () => {
      titleEl.textContent = teamInput.value || 'Team Creation';
    };

    // Dark/Light Toggle
    const toggle = document.getElementById('theme-toggle');
    const root = document.documentElement;
    if (localStorage.theme) root.setAttribute('data-theme', localStorage.theme);
    toggle.onclick = () => {
      const next = root.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      root.setAttribute('data-theme', next);
      localStorage.theme = next;
      toggle.textContent = next === 'dark' ? '☀️' : '🌙';
    };
    toggle.textContent = root.getAttribute('data-theme') === 'dark' ? '☀️' : '🌙';


    // Player Logic
    const container = document.getElementById('players-container');
    const countEl = document.getElementById('player-count');
    const MAX = 18, MIN = 15;

    // Helpers
    const rand = arr => arr[Math.floor(Math.random() * arr.length)];
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    // Sample data
    const NAMES = ["Virat", "Rohit", "Dhoni", "Smith", "Warner", "Anderson", "Bumrah", "Jadeja", "Stokes", "Root"];
    const ROLES = ["Batsman", "Bowler", "All-rounder", "Wicketkeeper"];
    const HANDS = ["Left", "Right"];
    const TYPES = ["Fast", "Fast-medium", "Medium-fast", "Medium", "Off spin", "Leg spin", "Finger spin", "Wrist spin"];

    // Update count
    function updateCount() {
      countEl.textContent = `${container.children.length} / ${MAX}`;
    }

    function refreshRoleSelectors() {
      const cards = [...document.querySelectorAll('.player-card')];
      const cap = document.getElementById('select-captain');
      const wk = document.getElementById('select-wk');

      // rebuild captain list from *all* player names
      cap.innerHTML = '<option value="">Select Captain</option>';
      cards.forEach(c => {
        const name = c.querySelector('[name=player_name]').value;
        if (name) cap.innerHTML += `<option>${name}</option>`;
      });

      // rebuild wicketkeeper list *only* from keeper-role cards
      wk.innerHTML = '<option value="">Select Wicketkeeper</option>';
      cards
        .filter(c => c.querySelector('[name=player_role]').value === 'Wicketkeeper')
        .forEach(c => {
          const name = c.querySelector('[name=player_name]').value;
          wk.innerHTML += `<option>${name}</option>`;
        });
    }

    const EDIT_MODE = {{ 'true' if edit else 'false' }};
    const TEAM_DATA = {{ team | tojson | safe if edit else 'null' }};

    function updateCount() {
      countEl.textContent = `${container.children.length} / ${MAX}`;
      refreshRoleSelectors();
    }


    // Add one player card
    function addPlayer(data) {
      if (container.children.length >= MAX) return;
      const tpl = document.getElementById('player-template').content.cloneNode(true);
      if (data) {
        tpl.querySelector('[name=player_name]').value = data.name;
        tpl.querySelector('[name=player_role]').value = data.role;
        tpl.querySelector('[name=batting_rating]').value = data.bat;
        tpl.querySelector('[name=bowling_rating]').value = data.bowl;
        tpl.querySelector('[name=fielding_rating]').value = data.field;
        tpl.querySelector('[name=batting_hand]').value = data.bhand;
        tpl.querySelector('[name=bowling_type]').value = data.btype;
        tpl.querySelector('[name=bowling_hand]').value = data.bhand2;
      }
      const card = tpl.querySelector('.player-card');
      card.querySelector('.remove').onclick = () => { card.remove(); updateCount(); };
      container.appendChild(card);
      updateCount();
    }

    // Manual add
    document.getElementById('add-player').onclick = () => addPlayer();

    // Bind the generate-team button
    const genBtn = document.getElementById('generate-team');

    genBtn.onclick = () => {
      const current = container.children.length;
      const needed = Math.max(0, MIN - current);

      let roles = [];
      if (![...container.children].some(c => c.querySelector('[name=player_role]').value === 'Wicketkeeper'))
        roles.push("Wicketkeeper");
      while (roles.filter(r => r !== "Wicketkeeper" && r !== "Batsman").length < 6)
        roles.push(rand(["Bowler", "All-rounder"]));
      while (roles.length < needed) roles.push(rand(ROLES));
      roles = roles.sort(() => Math.random() - 0.5);

      roles.forEach(r => {
        const data = {
          name: `${rand(NAMES)} ${randInt(1, 99)}`,
          role: r,
          bat: randInt(40, 95),
          bowl: randInt(40, 95),
          field: randInt(40, 95),
          bhand: rand(HANDS),
          btype: (r === "Bowler" || r === "All-rounder") ? rand(TYPES) : "",
          bhand2: (r === "Bowler" || r === "All-rounder") ? rand(HANDS) : ""
        };
        addPlayer(data);
      });
    };



    // ─── Prefill on Edit Mode ───────────────────────────────────
    if (EDIT_MODE) {
      // 1. Basic fields
      document.getElementById('team_name').value = TEAM_DATA.team_name;
      document.querySelector('[name=short_code]').value = TEAM_DATA.short_code;
      document.querySelector('[name=home_ground]').value = TEAM_DATA.home_ground;
      document.querySelector('[name=pitch_preference]').value = TEAM_DATA.pitch_preference;

      // 2. Color swatch
      document.getElementById('team_color').value = TEAM_DATA.team_color;
      document.getElementById('color-swatch').style.background = TEAM_DATA.team_color;

      // 3. Clear container, then add each player
      container.innerHTML = "";
      TEAM_DATA.players.forEach(p => addPlayer({
        name: p.name,
        role: p.role,
        bat: p.batting_rating,
        bowl: p.bowling_rating,
        field: p.fielding_rating,
        bhand: p.batting_hand,
        btype: p.bowling_type,
        bhand2: p.bowling_hand
      }));

      // ⭐ Step 4: initialize count & selectors
      updateCount();

      // 5. Populate captain & wicketkeeper selects
      document.getElementById('select-captain').value = TEAM_DATA.captain;
      document.getElementById('select-wk').value = TEAM_DATA.wicketkeeper;
    }
    // ──────────────────────────────────────────────────────────

    // Color swatch wiring (replace existing swatch.onclick / oninput)
    const swatch = document.getElementById('color-swatch');
    const colorInput = document.getElementById('team_color');

    // initialize swatch to current value
    swatch.style.background = colorInput.value;

    // open picker when swatch clicked
    swatch.onclick = () => colorInput.click();

    // update on both input and change events
    colorInput.addEventListener('input', e => swatch.style.background = e.target.value);
    colorInput.addEventListener('change', e => swatch.style.background = e.target.value);

  </script>
</body>

</html>