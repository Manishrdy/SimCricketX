<!DOCTYPE html>
<html lang="en">

<head>

  <meta charset="UTF-8">
  <title>{{ "Edit Team" if edit else "Create Team" }} – SimCricketX</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Modern CSS Reset -->
  <link rel="stylesheet" href="https://unpkg.com/modern-css-reset/dist/reset.min.css" />

  <!-- Font Awesome for Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Google Fonts -->
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
    rel="stylesheet">

  <style>
    :root {
      /* Premium Font Stack */
      --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      --font-mono: 'JetBrains Mono', 'Fira Code', monospace;

      /* Light Theme - Clean, Airy, Premium */
      --bg-body: #f8fafc;
      --bg-surface: #ffffff;
      --bg-glass: rgba(255, 255, 255, 0.8);

      --text-main: #0f172a;
      --text-muted: #64748b;
      --text-on-accent: #ffffff;

      --border-light: #e2e8f0;
      --border-focused: #6366f1;

      /* Brand Colors - Indigo/Violet Gradient */
      --brand-primary: #4f46e5;
      --brand-secondary: #818cf8;
      --brand-gradient: linear-gradient(135deg, #4f46e5 0%, #8b5cf6 100%);

      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;

      /* Shadows & Elevation */
      --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
      --shadow-sm: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
      --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --shadow-glow: 0 0 20px rgba(79, 70, 229, 0.3);

      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --radius-full: 9999px;

      --ease-elastic: cubic-bezier(0.4, 0, 0.2, 1);
    }

    [data-theme="dark"] {
      /* Dark Theme - Deep Blue/Slate, Cyberpunk undertones */
      --bg-body: #020617;
      /* Very dark slate */
      --bg-surface: #0f172a;
      --bg-glass: rgba(15, 23, 42, 0.7);

      --text-main: #f8fafc;
      --text-muted: #94a3b8;

      --border-light: #1e293b;
      --border-focused: #818cf8;

      --brand-primary: #6366f1;
      --brand-secondary: #a78bfa;
      --brand-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);

      --shadow-xs: 0 1px 2px 0 rgba(0, 0, 0, 0.5);
      --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
    }

    /* Global Reset & Typography */
    * {
      box-sizing: border-box;
      outline: none;
    }

    body {
      background-color: var(--bg-body);
      color: var(--text-main);
      font-family: var(--font-sans);
      margin: 0;
      padding: 0;
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      transition: background-color 0.3s ease;
      overflow-x: hidden;
    }

    h1,
    h2,
    h3,
    h4 {
      margin: 0;
      font-weight: 700;
      letter-spacing: -0.025em;
    }

    p {
      margin: 0;
    }

    /* Layout Container */
    .main-content {
      max-width: 1100px;
      margin: 0 auto;
      padding: 120px 2rem 100px;
      /* Top padding for fixed header */
    }

    /* ─── Ultra-Premium Navbar ─── */
    .nav-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      height: 72px;
      background: var(--bg-glass);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border-light);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 2rem;
      transition: all 0.3s ease;
    }

    .nav-brand {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-weight: 700;
      color: var(--text-main);
      font-size: 1.25rem;
    }

    .home-btn {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-full);
      background: transparent;
      border: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      text-decoration: none;
      transition: all 0.2s var(--ease-elastic);
    }

    .home-btn:hover {
      background: var(--bg-surface);
      color: var(--brand-primary);
      border-color: var(--brand-primary);
      transform: scale(1.05);
      box-shadow: var(--shadow-sm);
    }

    .theme-toggle {
      background: transparent;
      border: none;
      font-size: 1.25rem;
      cursor: pointer;
      padding: 8px;
      color: var(--text-muted);
      transition: transform 0.3s ease, color 0.3s ease;
    }

    .theme-toggle:hover {
      color: var(--text-main);
      transform: rotate(15deg) scale(1.1);
    }

    /* ─── Page Header & Typography ─── */
    .page-header {
      text-align: center;
      margin-bottom: 4rem;
      animation: fadeUp 0.6s ease-out;
    }

    .dynamic-title {
      font-size: 3.5rem;
      line-height: 1.1;
      font-weight: 800;
      background: var(--brand-gradient);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 1rem;
      letter-spacing: -0.04em;
    }

    .page-subtitle {
      color: var(--text-muted);
      font-size: 1.1rem;
      max-width: 600px;
      margin: 0 auto;
    }

    /* ─── Cards & Sections ─── */
    .glass-card {
      background: var(--bg-surface);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow-md);
      margin-bottom: 2rem;
      /* Overflow visible to allow dropdowns to pop out */
      overflow: visible;
      transition: box-shadow 0.3s ease, transform 0.3s ease;
    }

    .glass-card:hover {
      box-shadow: var(--shadow-lg);
    }

    .section-header {
      padding: 2rem;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      align-items: center;
      gap: 1rem;
      background: linear-gradient(to bottom, var(--bg-surface), rgba(255, 255, 255, 0.02));
    }

    .section-icon {
      width: 48px;
      height: 48px;
      background: var(--brand-gradient);
      border-radius: var(--radius-md);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.25rem;
      box-shadow: var(--shadow-glow);
    }

    .section-title {
      font-size: 1.5rem;
      color: var(--text-main);
    }

    .section-body {
      padding: 2rem;
    }

    /* ─── Form Elements ─── */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 2rem;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 0.6rem;
      position: relative;
    }

    .form-label {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-muted);
    }

    .form-input,
    .form-select {
      background: var(--bg-body);
      border: 2px solid transparent;
      border-radius: var(--radius-md);
      padding: 1rem;
      font-size: 1rem;
      color: var(--text-main);
      font-family: var(--font-sans);
      transition: all 0.2s ease;
      box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    /* Premium Input Interaction */
    .form-input:hover,
    .form-select:hover {
      background: var(--bg-surface);
      border-color: var(--border-light);
    }

    .form-input:focus,
    .form-select:focus {
      background: var(--bg-surface);
      border-color: var(--brand-primary);
      box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
    }

    /* Custom Color Picker */
    .color-picker-wrapper {
      display: flex;
      align-items: center;
      gap: 1rem;
      padding: 0.5rem;
      background: var(--bg-body);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .color-picker-wrapper:hover {
      background: var(--bg-surface);
      box-shadow: 0 0 0 2px var(--border-light);
    }

    .color-swatch {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      border: 2px solid rgba(255, 255, 255, 0.2);
      box-shadow: var(--shadow-sm);
    }

    /* ─── Squad Management / Player Table ─── */
    .squad-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      background: var(--bg-body);
      padding: 1rem;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-light);
    }

    .squad-stats {
      display: flex;
      gap: 1.5rem;
      align-items: center;
    }

    .stat-badge {
      font-family: var(--font-mono);
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-muted);
      background: var(--bg-surface);
      padding: 0.5rem 1rem;
      border-radius: var(--radius-full);
      box-shadow: var(--shadow-xs);
      border: 1px solid var(--border-light);
    }

    .player-counter {
      color: var(--brand-primary);
      font-weight: 700;
    }

    /* Action Buttons */
    .btn-group {
      display: flex;
      gap: 1rem;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.75rem;
      padding: 0.75rem 1.5rem;
      font-weight: 600;
      font-size: 0.95rem;
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all 0.2s var(--ease-elastic);
      border: none;
      text-decoration: none;
      position: relative;
      overflow: hidden;
    }

    /* Primary Gradient Button */
    .btn-primary {
      background: var(--brand-gradient);
      color: white;
      box-shadow: var(--shadow-glow);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px -5px rgba(79, 70, 229, 0.4);
    }

    .btn-primary:active {
      transform: translateY(0);
    }

    /* Secondary Glass Button */
    .btn-secondary {
      background: var(--bg-surface);
      border: 1px solid var(--border-light);
      color: var(--text-main);
    }

    .btn-secondary:hover {
      border-color: var(--brand-primary);
      color: var(--brand-primary);
      transform: translateY(-1px);
      background: var(--bg-body);
    }

    /* ─── Player List Rows ─── */
    .players-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .player-row {
      display: grid;
      /* Mobile layout by default, overridden by media query */
      grid-template-columns: 1fr;
      gap: 1rem;

      background: var(--bg-surface);
      border: 1px solid var(--border-light);
      padding: 1.25rem;
      border-radius: var(--radius-md);
      position: relative;
      transition: all 0.2s ease;
      animation: slideIn 0.3s ease forwards;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .player-row:hover {
      border-color: var(--brand-secondary);
      box-shadow: var(--shadow-sm);
      transform: translateX(4px);
    }

    /* Responsive Desktop Grid for Players */
    @media (min-width: 1024px) {
      .player-row {
        /* Adjusted grid pattern to be tighter and fit within 900-1000px container */
        grid-template-columns: minmax(140px, 1.8fr) minmax(100px, 1.2fr) repeat(3, minmax(60px, 0.7fr)) repeat(3, minmax(80px, 0.9fr)) 40px;
        padding: 0.75rem 1rem;
        align-items: center;
        gap: 0.5rem;
        /* Reduced gap from 0.75rem to 0.5rem */
      }
    }

    /* Horizontal Scroll Wrapper for smaller desktops/tablets */
    .players-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      /* Ensure it doesn't break layout if still too wide */
      overflow-x: auto;
      padding-bottom: 0.5rem;
      /* Space for scrollbar if needed */
      -webkit-overflow-scrolling: touch;
    }

    /* Sleek Inputs inside rows */
    .player-row .form-input,
    .player-row .form-select {
      background: transparent;
      border: 1px solid transparent;
      padding: 0.5rem;
      font-size: 0.9rem;
      border-radius: var(--radius-sm);
      box-shadow: none;
    }

    .player-row .form-input:hover,
    .player-row .form-select:hover {
      background: var(--bg-body);
    }

    .player-row .form-input:focus,
    .player-row .form-select:focus {
      background: var(--bg-body);
      border-color: var(--brand-primary);
      box-shadow: none;
    }

    /* Remove Button */
    .btn-remove {
      width: 32px;
      height: 32px;
      border-radius: var(--radius-full);
      border: none;
      background: rgba(239, 68, 68, 0.1);
      color: var(--danger);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .btn-remove:hover {
      background: var(--danger);
      color: white;
      transform: rotate(90deg);
    }

    /* ─── Sticky Footer ─── */
    .sticky-footer {
      position: fixed;
      bottom: 2rem;
      padding: 1rem 2rem;
      background: rgba(15, 23, 42, 0.9);
      /* Dark background even on light mode for contrast */
      backdrop-filter: blur(12px);
      color: white;
      border-radius: var(--radius-full);
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
      z-index: 900;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 1rem;
      align-items: center;
      border: 1px solid rgba(255, 255, 255, 0.1);
      width: 90%;
      max-width: 600px;
      justify-content: space-between;
    }

    /* Template Helper Dropdown */
    .template-dropdown {
      position: relative;
      display: inline-block;
    }

    .template-card {
      position: absolute;
      top: 100%;
      /* Drop DOWN */
      bottom: auto;
      left: 50%;
      transform: translateX(-50%);
      margin-top: 12px;
      /* Small gap from button */
      width: 340px;
      max-width: 90vw;
      /* Prevent mobile overflow */
      background: var(--bg-surface);
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xl);
      padding: 1.25rem;
      display: none;
      z-index: 1000;
      pointer-events: none;
      opacity: 0;
      transition: all 0.2s ease;
    }

    /* Arrow pointing UP */
    .template-card::after {
      content: '';
      position: absolute;
      bottom: 100%;
      left: 50%;
      margin-left: -6px;
      border-width: 6px;
      border-style: solid;
      border-color: transparent transparent var(--bg-surface) transparent;
    }

    .template-dropdown:hover .template-card {
      display: block;
      pointer-events: auto;
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .code-block {
      background: #1e293b;
      color: #a78bfa;
      font-family: var(--font-mono);
      padding: 1rem;
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      overflow-x: auto;
      margin: 0.5rem 0;
      white-space: pre;
    }

    /* Media Queries */
    @media (max-width: 768px) {
      .dynamic-title {
        font-size: 2.5rem;
      }

      .nav-header {
        padding: 0 1rem;
      }

      .main-content {
        padding: 100px 1rem 120px;
      }

      .form-grid {
        grid-template-columns: 1fr;
      }

      .sticky-footer {
        width: 95%;
        bottom: 1rem;
        flex-direction: column;
        border-radius: var(--radius-lg);
      }

      .btn {
        width: 100%;
      }

      .player-row {
        grid-template-columns: 1fr;
        gap: 0.5rem;
        padding: 1.5rem;
        border-left: 4px solid var(--brand-primary);
      }
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>
  <!-- Navigation Header -->
  <header class="nav-header">
    <div class="nav-brand">
      <a href="{{ url_for('home') }}" class="home-btn" title="Home">
        <i class="fa-solid fa-house"></i>
      </a>
      <span>SimCricket<span style="color:var(--brand-primary)">X</span></span>
    </div>

    <button class="theme-toggle" id="theme-toggle">
      <i class="fa-solid fa-moon"></i>
    </button>
  </header>

  <!-- Main Content -->
  <main class="main-content">
    <!-- Page Header -->
    <div class="page-header">
      <h1 class="dynamic-title" id="dynamic-title">{{ team.team_name if edit else 'Create Team' }}</h1>
      <p class="page-subtitle">Design your championship winning squad with precision and style.</p>
    </div>

    <!-- Error Messages -->
    {% if error %}
    <div class="glass-card" style="border-left: 4px solid var(--danger); padding: 1rem;">
      <div style="color: var(--danger); display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
        <i class="fa-solid fa-circle-exclamation"></i>
        {{ error }}
      </div>
    </div>
    {% endif %}

    <!-- Main Team Form -->
    <form id="team-form" method="POST"
      action="{{ url_for('edit_team', short_code=team.short_code) if edit else url_for('create_team') }}">

      <!-- Team Details Section -->
      <div class="glass-card">
        <div class="section-header">
          <div class="section-icon">
            <i class="fa-solid fa-shield-halved"></i>
          </div>
          <div class="section-title">Team Identity</div>
        </div>

        <div class="section-body">
          <div class="form-grid">
            <div class="form-group">
              <label class="form-label" for="team_name">Team Name</label>
              <input id="team_name" name="team_name" class="form-input" placeholder="e.g. Mumbai Indians" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="short_code">Short Code</label>
              <input name="short_code" class="form-input" placeholder="e.g. MI" minlength="2" maxlength="3" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="home_ground">Home Ground</label>
              <input name="home_ground" class="form-input" placeholder="e.g. Wankhede Stadium" required>
            </div>

            <div class="form-group">
              <label class="form-label" for="pitch_preference">Pitch Preference</label>
              <select name="pitch_preference" class="form-select" required>
                <option value="">Select Surface</option>
                <option>Green</option>
                <option>Flat</option>
                <option>Dry</option>
                <option>Hard</option>
                <option>Dead</option>
              </select>
            </div>

            <div class="form-group">
              <label class="form-label">Team Color</label>
              <div class="color-picker-wrapper" id="color-picker-trigger">
                <div id="color-swatch" class="color-swatch"></div>
                <span style="font-size: 0.9rem; font-weight: 500;">Select Brand Color</span>
                <input type="color" id="team_color" name="team_color" value="#4f46e5" class="color-input" required>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Player Management Section -->
      <div class="glass-card">
        <div class="section-header">
          <div class="section-icon">
            <i class="fa-solid fa-users-line"></i>
          </div>
          <div class="section-title">Squad Roster</div>
        </div>

        <div class="section-body">
          <!-- Toolbar -->
          <div class="squad-toolbar">
            <div class="squad-stats">
              <div class="stat-badge">Squad: <span class="player-counter" id="player-count">0/25</span></div>
              <!-- Future: Add role counts here -->
            </div>

            <div class="btn-group">
              <button type="button" class="btn btn-secondary" id="import-json-btn">
                <i class="fa-solid fa-file-import"></i> Import
              </button>

              <div class="template-dropdown">
                <button type="button" class="btn btn-secondary" id="template-helper-btn">
                  <i class="fa-solid fa-wand-magic-sparkles"></i> AI Prompt
                </button>
                <div class="template-card">
                  <div
                    style="display:flex; justify-content:space-between; margin-bottom:0.5rem; color:var(--text-muted); font-size:0.8rem; text-transform:uppercase; font-weight:700;">
                    <span>JSON Format</span>
                    <span id="copy-feedback" style="color:var(--success);"></span>
                  </div>
                  <div class="code-block" id="json-template-preview">[
                    {
                    "name": "Player Name",
                    "role": "Batsman",
                    "bat": 85,
                    "bowl": 20,
                    "field": 80,
                    "bhand": "Right",
                    "btype": "",
                    "bhand2": ""
                    }
                    ]</div>
                  <button type="button" class="btn btn-primary" style="width:100%; font-size:0.8rem; padding:0.5rem;"
                    id="copy-template-btn">
                    <i class="fa-regular fa-copy"></i> Copy Prompt for AI
                  </button>
                </div>
              </div>

              <button type="button" class="btn btn-primary" id="add-player">
                <i class="fa-solid fa-plus"></i> Add Player
              </button>
            </div>
          </div>

          <!-- Players Grid -->
          <div class="players-list" id="players-container"></div>
        </div>
      </div>

      <!-- Leadership Section -->
      <div class="glass-card">
        <div class="section-header">
          <div class="section-icon">
            <i class="fa-solid fa-chess-king"></i>
          </div>
          <div class="section-title">Leadership Core</div>
        </div>
        <div class="section-body">
          <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
            <div class="form-group">
              <label class="form-label" for="select-captain">Captain</label>
              <select name="captain" id="select-captain" class="form-select" required>
                <option value="">Select Captain</option>
              </select>
            </div>
            <div class="form-group">
              <label class="form-label" for="select-wk">Wicketkeeper</label>
              <select name="wicketkeeper" id="select-wk" class="form-select" required>
                <option value="">Select Wicketkeeper</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Sticky Footer Actions -->
      <div class="sticky-footer">
        <div style="font-size: 0.9rem; opacity: 0.8;">
          {% if edit %}Editing <strong>{{ team.short_code }}</strong>{% else %}Creating New Team{% endif %}
        </div>
        <div class="btn-group">
          {% if edit %}
          <a href="{{ url_for('manage_teams') }}" class="btn btn-secondary"
            style="background: rgba(255,255,255,0.1); color: white; border: none;">
            Cancel
          </a>
          {% else %}
          <button type="button" class="btn btn-secondary" id="clear-draft"
            style="background: rgba(255,255,255,0.1); color: white; border: none;">
            Clear Draft
          </button>
          {% endif %}
          <button type="submit" class="btn btn-primary">
            <i class="fa-solid fa-floppy-disk"></i>
            {{ 'Save Changes' if edit else 'Create Team' }}
          </button>
        </div>
      </div>

    </form>
  </main>

  <!-- Player Row Template -->
  <template id="player-template">
    <div class="player-row">
      <input name="player_name" class="form-input" placeholder="Player Name" required>
      <select name="player_role" class="form-select" required>
        <option value="">Role</option>
        <option>Batsman</option>
        <option>Bowler</option>
        <option>All-rounder</option>
        <option>Wicketkeeper</option>
      </select>

      <input type="number" name="batting_rating" class="form-input" placeholder="Bat" min="0" max="100"
        title="Batting Rating" required>
      <input type="number" name="bowling_rating" class="form-input" placeholder="Bowl" min="0" max="100"
        title="Bowling Rating" required>
      <input type="number" name="fielding_rating" class="form-input" placeholder="Fld" min="0" max="100"
        title="Fielding Rating" required>

      <select name="batting_hand" class="form-select" required>
        <option value="">Bat Hand</option>
        <option>Left</option>
        <option>Right</option>
      </select>

      <select name="bowling_type" class="form-select">
        <option value="">Bowl Type</option>
        <option>Fast</option>
        <option>Fast-medium</option>
        <option>Medium-fast</option>
        <option>Medium</option>
        <option>Off spin</option>
        <option>Leg spin</option>
        <option>Finger spin</option>
        <option>Wrist spin</option>
      </select>

      <select name="bowling_hand" class="form-select">
        <option value="">Bowl Hand</option>
        <option>Left</option>
        <option>Right</option>
      </select>

      <button type="button" class="btn-remove player-remove" title="Remove Player">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>
  </template>

  <script>
    // Dynamic Title
    const teamInput = document.getElementById('team_name');
    const titleEl = document.getElementById('dynamic-title');
    teamInput.oninput = () => {
      titleEl.textContent = teamInput.value || 'Team Creation';
      if (!EDIT_MODE) saveDraft();
    };

    // Player Logic
    const container = document.getElementById('players-container');
    const countEl = document.getElementById('player-count');
    const MAX = 25, MIN = 15;

    // Helpers
    const rand = arr => arr[Math.floor(Math.random() * arr.length)];
    const randInt = (min, max) => Math.floor(Math.random() * (max - min + 1)) + min;

    // Validation function
    function validateForm() {
      const playerCount = container.children.length;
      // Fix: Selector updated to .player-row
      const cards = [...document.querySelectorAll('.player-row')];

      // Check player count (15-25)
      if (playerCount < 15 || playerCount > 25) return false;

      // Check all players have required fields
      for (let card of cards) {
        const name = card.querySelector('[name=player_name]').value.trim();
        const role = card.querySelector('[name=player_role]').value;
        const bat = card.querySelector('[name=batting_rating]').value;
        const bowl = card.querySelector('[name=bowling_rating]').value;
        const field = card.querySelector('[name=fielding_rating]').value;
        const bhand = card.querySelector('[name=batting_hand]').value;

        if (!name || !role || !bat || !bowl || !field || !bhand) return false;
      }

      // Check role requirements
      const wicketkeepers = cards.filter(c => c.querySelector('[name=player_role]').value === 'Wicketkeeper');
      const bowlers = cards.filter(c => ['Bowler', 'All-rounder'].includes(c.querySelector('[name=player_role]').value));

      if (wicketkeepers.length < 1) return false;
      if (bowlers.length < 6) return false;

      // Check basic team info
      const teamName = document.getElementById('team_name').value.trim();
      const shortCode = document.querySelector('[name=short_code]').value.trim();
      const homeGround = document.querySelector('[name=home_ground]').value.trim();
      const pitchPref = document.querySelector('[name=pitch_preference]').value;

      if (!teamName || !shortCode || !homeGround || !pitchPref) return false;

      // Check captain and wicketkeeper selection
      const captain = document.getElementById('select-captain').value;
      const wk = document.getElementById('select-wk').value;

      if (!captain || !wk) return false;

      return true;
    }

    function updateSubmitButtons() {
      const isValid = validateForm();
      const submitButtons = document.querySelectorAll('button[type="submit"]');

      submitButtons.forEach(btn => {
        btn.disabled = !isValid;
        btn.style.opacity = isValid ? '1' : '0.5';
        btn.style.cursor = isValid ? 'pointer' : 'not-allowed';
      });
    }

    // Sample data
    const NAMES = ["Virat", "Rohit", "Dhoni", "Smith", "Warner", "Anderson", "Bumrah", "Jadeja", "Stokes", "Root", "Travis Head", "H Klaasen", "M Starc", "S Iyer", "Spidy Pant"];
    const ROLES = ["Batsman", "Bowler", "All-rounder", "Wicketkeeper"];
    const HANDS = ["Left", "Right"];
    const TYPES = ["Fast", "Fast-medium", "Medium-fast", "Medium", "Off spin", "Leg spin", "Finger spin", "Wrist spin"];

    // Update count
    function updateCount() {
      const current = container.children.length;
      countEl.textContent = `${current} / ${MAX}`;

      // Add color coding
      if (current < MIN) {
        countEl.style.color = '#dc3545'; // red
        countEl.style.background = 'rgba(239, 68, 68, 0.1)';
      } else if (current <= MAX) {
        countEl.style.color = '#10b981'; // green
        countEl.style.background = 'rgba(16, 185, 129, 0.1)';
      } else {
        countEl.style.color = '#f59e0b'; // yellow
        countEl.style.background = 'rgba(245, 158, 11, 0.1)';
      }

      refreshRoleSelectors();
      updateSubmitButtons();
      if (!EDIT_MODE) saveDraft();
    }

    function refreshRoleSelectors() {
      // Fix: Selector updated to .player-row
      const cards = [...document.querySelectorAll('.player-row')];
      const cap = document.getElementById('select-captain');
      const wk = document.getElementById('select-wk');

      // Preserve selection if possible
      const currentCap = cap.value;
      const currentWk = wk.value;

      // rebuild captain list from *all* player names
      cap.innerHTML = '<option value="">Select Captain</option>';
      cards.forEach(c => {
        const name = c.querySelector('[name=player_name]').value;
        if (name) {
          const opt = document.createElement('option');
          opt.value = name;
          opt.textContent = name;
          if (name === currentCap) opt.selected = true;
          cap.appendChild(opt);
        }
      });

      // rebuild wicketkeeper list *only* from keeper-role cards
      wk.innerHTML = '<option value="">Select Wicketkeeper</option>';
      cards
        .filter(c => c.querySelector('[name=player_role]').value === 'Wicketkeeper')
        .forEach(c => {
          const name = c.querySelector('[name=player_name]').value;
          if (name) {
            const opt = document.createElement('option');
            opt.value = name;
            opt.textContent = name;
            if (name === currentWk) opt.selected = true;
            wk.appendChild(opt);
          }
        });
    }
  </script>

  <!-- Data Injection -->
  <script id="edit-mode-data" type="application/json">
      {{ 'true' if edit else 'false' }}
  </script>
  <script id="team-data-json" type="application/json">
      {{ team | tojson | safe if edit else 'null' }}
    </script>

  <script>
    const EDIT_MODE = JSON.parse(document.getElementById('edit-mode-data').textContent);
    let TEAM_DATA = null;
    try {
      TEAM_DATA = JSON.parse(document.getElementById('team-data-json').textContent);
    } catch (e) {
      console.error("Failed to parse team data", e);
    }
  </script>



  <script>
    // Add one player card
    function addPlayer(data, autoUpdate = true) {
      if (container.children.length >= MAX) return;
      const tpl = document.getElementById('player-template').content.cloneNode(true);
      // Correction: Template root class is now 'player-row', not 'player-card'
      const card = tpl.querySelector('.player-row');

      // Fill if data passed (used in generate/edit)
      if (data) {
        card.querySelector('[name=player_name]').value = data.name;
        // Ensure role matches strict Select values
        const validRoles = ["Batsman", "Bowler", "All-rounder", "Wicketkeeper"];
        const role = validRoles.includes(data.role) ? data.role : "Batsman";
        card.querySelector('[name=player_role]').value = role;

        card.querySelector('[name=batting_rating]').value = data.bat;
        card.querySelector('[name=bowling_rating]').value = data.bowl;
        card.querySelector('[name=fielding_rating]').value = data.field;
        card.querySelector('[name=batting_hand]').value = data.bhand;
        card.querySelector('[name=bowling_type]').value = data.btype;
        card.querySelector('[name=bowling_hand]').value = data.bhand2;
      }

      // Hook into name or role changes → refresh captain/WK selectors
      ["player_name", "player_role"].forEach(field => {
        card.querySelector(`[name=${field}]`).addEventListener('input', refreshRoleSelectors);
      });

      // Add validation listeners to all player fields
      ["player_name", "player_role", "batting_rating", "bowling_rating", "fielding_rating", "batting_hand"].forEach(field => {
        const input = card.querySelector(`[name=${field}]`);
        if (input) {
          input.addEventListener('input', updateSubmitButtons);
          input.addEventListener('change', updateSubmitButtons);
          if (!EDIT_MODE) {
            input.addEventListener('input', saveDraft);
            input.addEventListener('change', saveDraft);
          }
        }
      });

      card.querySelector('.player-remove').onclick = () => {
        card.style.transform = 'translateX(20px)';
        card.style.opacity = '0';
        setTimeout(() => {
          card.remove();
          updateCount();
        }, 300);
      };

      container.appendChild(card);
      if (autoUpdate) updateCount();
    }

    // Manual add
    document.getElementById('add-player').onclick = () => addPlayer();

    // Import JSON Handler
    document.getElementById('import-json-btn').onclick = () => {
      const jsonStr = prompt("Paste your Team JSON object here:");
      if (!jsonStr) return;

      try {
        const data = JSON.parse(jsonStr);
        if (!Array.isArray(data)) throw new Error("JSON must be an array of player objects");

        if (container.children.length > 0) {
          if (!confirm("This will replace current players. Continue?")) return;
        }

        container.innerHTML = "";

        // Add all players without triggering updateCount 15-20 times
        data.forEach(p => {
          addPlayer({
            name: p.name || "Player",
            role: p.role || "Batsman",
            bat: p.bat || p.batting_rating || 50,
            bowl: p.bowl || p.bowling_rating || 50,
            field: p.field || p.fielding_rating || 50,
            bhand: p.bhand || p.batting_hand || "Right",
            btype: p.btype || p.bowling_type || "",
            bhand2: p.bhand2 || p.bowling_hand || ""
          }, false); // Pass false to skip updateCount inside loop
        });

        // Single update at the end
        updateCount();
        alert("Team imported successfully! Please select your Captain and Wicketkeeper.");

      } catch (e) {
        alert("Invalid JSON: " + e.message);
      }
    };

    // Copy Template Handler
    document.getElementById('copy-template-btn').onclick = () => {
      // 1. Gather Current Context
      const teamName = document.getElementById('team_name').value || "[Team Name]";
      const shortCode = document.querySelector('[name=short_code]').value || "[Short Code]";
      const homeGround = document.querySelector('[name=home_ground]').value || "[Venue Name]";
      const pitchPref = document.querySelector('[name=pitch_preference]').value || "Balanced";
      const teamColor = document.getElementById('team_color').value || "Blue";

      // 2. Construct the Rich Prompt
      const templateText = document.getElementById('json-template-preview').innerText;

      const promptText = `I need you to generate a JSON dataset for a Cricket Team named "${teamName}" (${shortCode}).
      
**Context:**
- **Home Ground:** ${homeGround}
- **Pitch Type:** ${pitchPref}
- **Team Color:** ${teamColor}

**Constraints:**
1. The JSON must be a STRICT array of player objects.
2. Total Players: 15-20.
3. Roles Distribution:
   - At least 5 Batsmen
   - At least 1 Wicketkeeper
   - At least 6 Bowlers/All-rounders separate from batsmen
4. Ratings (0-100):
   - Star players: 85-95
   - Regulars: 75-84
   - Youngsters: 60-70

**Required JSON Format:**
${templateText}

Please generate the full JSON array only, no other text.`;

      navigator.clipboard.writeText(promptText).then(() => {
        const btn = document.getElementById('copy-template-btn');
        const originalContent = btn.innerHTML;
        btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied AI Prompt!';
        btn.classList.remove('btn-primary');
        btn.classList.add('btn-secondary'); // Visual feedback

        setTimeout(() => {
          btn.innerHTML = originalContent;
          btn.classList.add('btn-primary');
          btn.classList.remove('btn-secondary');
        }, 2000);
      }).catch(err => {
        console.error('Failed to copy: ', err);
        alert("Failed to copy to clipboard");
      });
    };

    // ─── Prefill on Edit Mode ───────────────────────────────────
    if (EDIT_MODE) {
      // 1. Basic fields
      document.getElementById('team_name').value = TEAM_DATA.team_name;
      document.querySelector('[name=short_code]').value = TEAM_DATA.short_code;
      document.querySelector('[name=home_ground]').value = TEAM_DATA.home_ground;
      document.querySelector('[name=pitch_preference]').value = TEAM_DATA.pitch_preference;

      // 2. Color swatch
      document.getElementById('team_color').value = TEAM_DATA.team_color;
      document.getElementById('color-swatch').style.background = TEAM_DATA.team_color;

      // 3. Clear container, then add each player
      container.innerHTML = "";
      TEAM_DATA.players.forEach(p => addPlayer({
        name: p.name,
        role: p.role,
        bat: p.batting_rating,
        bowl: p.bowling_rating,
        field: p.fielding_rating,
        bhand: p.batting_hand,
        btype: p.bowling_type,
        bhand2: p.bowling_hand
      }));

      // ⭐ Step 4: initialize count & selectors
      updateCount();

      // 5. Populate captain & wicketkeeper selects
      document.getElementById('select-captain').value = TEAM_DATA.captain;
      document.getElementById('select-wk').value = TEAM_DATA.wicketkeeper;
    }
    // ──────────────────────────────────────────────────────────

    // Color swatch wiring
    const swatch = document.getElementById('color-swatch');
    const colorInput = document.getElementById('team_color');

    // initialize swatch to current value
    swatch.style.background = colorInput.value;

    // open picker when swatch clicked
    swatch.onclick = () => colorInput.click();

    // update on both input and change events
    colorInput.addEventListener('input', e => swatch.style.background = e.target.value);
    colorInput.addEventListener('change', e => swatch.style.background = e.target.value);

    // Add validation listeners to team info fields
    ['team_name', 'short_code', 'home_ground', 'pitch_preference'].forEach(name => {
      const field = document.querySelector(`[name="${name}"], #${name}`);
      if (field) {
        field.addEventListener('input', updateSubmitButtons);
        field.addEventListener('change', updateSubmitButtons);
        if (!EDIT_MODE) {
          field.addEventListener('input', saveDraft);
          field.addEventListener('change', saveDraft);
        }
      }
    });

    // Add listeners to captain/wicketkeeper selects
    document.getElementById('select-captain').addEventListener('change', updateSubmitButtons);
    document.getElementById('select-wk').addEventListener('change', updateSubmitButtons);
    if (!EDIT_MODE) {
      document.getElementById('select-captain').addEventListener('change', saveDraft);
      document.getElementById('select-wk').addEventListener('change', saveDraft);
    }

    // Initial validation check
    updateSubmitButtons();
  </script>
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const root = document.documentElement;
      const toggleBtn = document.getElementById('theme-toggle');
      const icon = toggleBtn.querySelector('i');

      // 1. Initialize
      const savedTheme = localStorage.getItem('theme') || 'light';
      root.setAttribute('data-theme', savedTheme);
      updateIcon(savedTheme);

      // 2. Toggle Handler
      toggleBtn.addEventListener('click', () => {
        const current = root.getAttribute('data-theme');
        const next = current === 'dark' ? 'light' : 'dark';

        root.setAttribute('data-theme', next);
        localStorage.setItem('theme', next);
        updateIcon(next);
      });

      function updateIcon(theme) {
        if (theme === 'dark') {
          icon.classList.remove('fa-moon');
          icon.classList.add('fa-sun');
        } else {
          icon.classList.remove('fa-sun');
          icon.classList.add('fa-moon');
        }
      }
    });

    // ─── Draft Management (LocalStorage) ────────────────────────
    const DRAFT_KEY = 'team_create_draft';
    const clearDraftBtn = document.getElementById('clear-draft');

    // Save Draft
    function saveDraft() {
      if (EDIT_MODE) return; // Don't overwrite drafts with edit data or interfere

      const players = [...container.children].map(card => ({
        name: card.querySelector('[name=player_name]').value,
        role: card.querySelector('[name=player_role]').value,
        bat: card.querySelector('[name=batting_rating]').value,
        bowl: card.querySelector('[name=bowling_rating]').value,
        field: card.querySelector('[name=fielding_rating]').value,
        bhand: card.querySelector('[name=batting_hand]').value,
        btype: card.querySelector('[name=bowling_type]').value,
        bhand2: card.querySelector('[name=bowling_hand]').value
      }));

      const draft = {
        team_name: document.getElementById('team_name').value,
        short_code: document.querySelector('[name=short_code]').value,
        home_ground: document.querySelector('[name=home_ground]').value,
        pitch_preference: document.querySelector('[name=pitch_preference]').value,
        team_color: document.getElementById('team_color').value,
        captain: document.getElementById('select-captain').value,
        wicketkeeper: document.getElementById('select-wk').value,
        players: players,
        timestamp: Date.now()
      };

      localStorage.setItem(DRAFT_KEY, JSON.stringify(draft));
    }

    // Load Draft
    function loadDraft() {
      if (EDIT_MODE) return;

      const raw = localStorage.getItem(DRAFT_KEY);
      if (!raw) return;

      try {
        const draft = JSON.parse(raw);

        document.getElementById('team_name').value = draft.team_name || "";
        document.querySelector('[name=short_code]').value = draft.short_code || "";
        document.querySelector('[name=home_ground]').value = draft.home_ground || "";
        document.querySelector('[name=pitch_preference]').value = draft.pitch_preference || "";

        if (draft.team_color) {
          document.getElementById('team_color').value = draft.team_color;
          document.getElementById('color-swatch').style.background = draft.team_color;
        }

        // Players
        container.innerHTML = "";
        if (draft.players && draft.players.length > 0) {
          draft.players.forEach(p => addPlayer(p));
        }

        updateCount();

        // Leadership
        setTimeout(() => {
          if (draft.captain) document.getElementById('select-captain').value = draft.captain;
          if (draft.wicketkeeper) document.getElementById('select-wk').value = draft.wicketkeeper;
          updateSubmitButtons();
        }, 100);

      } catch (e) {
        console.error("Error loading draft", e);
      }
    }

    // Clear Draft
    if (clearDraftBtn) {
      clearDraftBtn.onclick = () => {
        if (confirm("Are you sure you want to clear the form? This cannot be undone.")) {
          localStorage.removeItem(DRAFT_KEY);
          location.reload();
        }
      };
    }

    // Attach Draft Listeners (Load & Clear on Submit)
    if (!EDIT_MODE) {
      document.getElementById('team-form').addEventListener('submit', () => {
        localStorage.removeItem(DRAFT_KEY);
      });

      // Load on startup
      loadDraft();
    }
  </script>

</body>

</html>