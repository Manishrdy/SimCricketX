<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Simulate Match – SimCricketX</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />

    <!-- Google Fonts -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1️⃣ Grab root & restore saved theme (or default to light)
            const root = document.documentElement;
            const saved = localStorage.getItem('theme') || 'light';
            window.appTheme = saved;
            root.setAttribute('data-theme', saved);

            // 2️⃣ If Prototype (Shadow), re-apply the last-picked variant colors
            if (saved === 'prototype') {
                const primary = localStorage.getItem('prototypePrimary');
                const light = localStorage.getItem('prototypeLight');
                if (primary && light) {
                    root.style.setProperty('--accent', primary);
                    root.style.setProperty('--accent-hover', light);
                    root.style.setProperty('--accent-light', `${primary}1a`);
                    root.style.setProperty('--icon-color', primary);
                    root.style.setProperty(
                        '--gradient',
                        `linear-gradient(135deg, ${primary}, ${light})`
                    );
                    root.style.setProperty(
                        '--gradient-accent',
                        `linear-gradient(45deg, ${primary}, #ffffff)`
                    );
                }
            }

            // 3️⃣ Wire up the toggle button
            const ttl = document.getElementById('theme-toggle');
            // Set its initial icon
            ttl.textContent = saved === 'dark' ? '☀️' : '🌙';

            // Function to apply & persist a theme (and Prototype variant colors)
            function applyTheme(t) {
                root.setAttribute('data-theme', t);
                ttl.textContent = t === 'dark' ? '☀️' : '🌙';
                localStorage.setItem('theme', t);

                if (t === 'prototype') {
                    const primary = localStorage.getItem('prototypePrimary');
                    const light = localStorage.getItem('prototypeLight');
                    if (primary && light) {
                        root.style.setProperty('--accent', primary);
                        root.style.setProperty('--accent-hover', light);
                        root.style.setProperty('--accent-light', `${primary}1a`);
                        root.style.setProperty('--icon-color', primary);
                        root.style.setProperty(
                            '--gradient',
                            `linear-gradient(135deg, ${primary}, ${light})`
                        );
                        root.style.setProperty(
                            '--gradient-accent',
                            `linear-gradient(45deg, ${primary}, #ffffff)`
                        );
                    }
                }
            }

            // 4️⃣ Initialize on load
            applyTheme(window.appTheme);

            // 5️⃣ Toggle handler (dark ↔ light; leaves Prototype untouched)
            ttl.addEventListener('click', () => {
                const next = window.appTheme === 'dark' ? 'light' : window.appTheme;
                window.appTheme = next;
                applyTheme(next);
            });
        });
    </script>

    <style>
        :root {
            --bg: #fafbfc;
            --bg-secondary: #f5f6f8;
            --fg: #1a1d23;
            --fg-secondary: #6b7280;
            --card-bg: #ffffff;
            --card-border: #e5e7eb;
            --accent: #3b82f6;
            --accent-hover: #2563eb;
            --accent-light: #dbeafe;
            --shadow: rgba(0, 0, 0, 0.04);
            --shadow-hover: rgba(0, 0, 0, 0.08);
            --shadow-strong: rgba(0, 0, 0, 0.12);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-accent: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            --icon-color: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --border-radius: 16px;
            --border-radius-sm: 8px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --bg: #0f1419;
            --bg-secondary: #1a1f2e;
            --fg: #f9fafb;
            --fg-secondary: #9ca3af;
            --card-bg: #1e293b;
            --card-border: #334155;
            --accent: #60a5fa;
            --accent-hover: #3b82f6;
            --accent-light: #1e3a8a;
            --shadow: rgba(0, 0, 0, 0.2);
            --shadow-hover: rgba(0, 0, 0, 0.3);
            --shadow-strong: rgba(0, 0, 0, 0.4);
            --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-accent: linear-gradient(135deg, #60a5fa 0%, #a78bfa 100%);
            --icon-color: #60a5fa;
        }

        /* Shadow / Prototype theme */
        :root[data-theme="prototype"] {
            --bg: linear-gradient(135deg, #0f0f0f, #1a1a1a);
            --bg-secondary: rgba(255, 255, 255, 0.02);
            --fg: #e0e0e0;
            --fg-secondary: #a0a0a0;
            --card-bg: rgba(255, 255, 255, 0.03);
            --card-border: rgba(255, 255, 255, 0.1);
            --accent: #00d4aa;
            --accent-hover: #00b894;
            --accent-light: rgba(0, 212, 170, 0.1);
            --icon-color: #00d4aa;
            --shadow: rgba(0, 0, 0, 0.3);
            --shadow-hover: rgba(0, 0, 0, 0.4);
            --shadow-strong: rgba(0, 0, 0, 0.5);
            --gradient: linear-gradient(135deg, #00d4aa, #00b894);
            --gradient-accent: linear-gradient(45deg, #00d4aa, #ffffff);
        }


        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg);
            color: var(--fg);
            line-height: 1.6;
            transition: var(--transition);
        }

        a {
            color: inherit;
            text-decoration: none;
        }

        button {
            font: inherit;
        }

        /* Navigation Header */
        .page-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: var(--card-bg);
            border-bottom: 1px solid var(--card-border);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            z-index: 1000;
            padding: 1rem 2rem;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
        }

        .nav-center {
            display: flex;
            align-items: center;
            gap: 1.5rem;
        }

        .home {
            color: var(--accent);
            font-size: 1.5rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background: var(--bg-secondary);
        }

        .home:hover {
            background: var(--accent-light);
            transform: scale(1.1);
        }

        #page-title {
            font-size: 1.5rem;
            font-weight: 700;
            background: var(--gradient-accent);
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            margin: 0;
        }

        .theme-toggle {
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            cursor: pointer;
            font-size: 1.2rem;
            color: var(--fg);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            position: absolute;
            right: 2rem;
            top: 50%;
            transform: translateY(-50%);
        }

        .theme-toggle:hover {
            background: var(--accent-light);
            border-color: var(--accent);
            transform: scale(1.05);
        }

        /* Main Content */
        .main-content {
            padding-top: 100px;
            padding-bottom: 2rem;
        }

        /* Flash Messages */
        .flash {
            margin: 2rem;
            padding: 1rem 1.25rem;
            border-radius: var(--border-radius-sm);
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border: 1px solid rgba(239, 68, 68, 0.2);
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            animation: slideDown 0.3s ease;
            line-height: 1.5;
        }

        @keyframes slideDown {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* Team Selection Section */
        .teams-section {
            display: flex;
            flex-direction: column;
            gap: 2rem;
            padding: 2rem;
        }

        .section-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .section-title {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--fg);
            margin-bottom: 0.5rem;
        }

        .section-subtitle {
            color: var(--fg-secondary);
            font-size: 1rem;
        }

        .teams-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .team-card {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .team-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-accent);
            transform: scaleX(0);
            transition: var(--transition);
        }

        .team-card:hover::before {
            transform: scaleX(1);
        }

        .team-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px var(--shadow-hover);
            border-color: var(--accent);
        }

        .team-card.selected {
            border-color: var(--accent);
            background: var(--accent-light);
            transform: translateY(-4px);
            box-shadow: 0 12px 32px var(--shadow-hover);
        }

        .team-card.selected::before {
            transform: scaleX(1);
        }

        .team-card h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--fg);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .color-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--card-border);
            transition: var(--transition);
        }

        .team-card:hover .color-dot {
            border-color: var(--accent);
            transform: scale(1.1);
        }

        .team-card label {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--fg-secondary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .team-select {
            width: 18px;
            height: 18px;
            accent-color: var(--accent);
        }

        .next-btn-container {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }

        #next-btn {
            padding: 1rem 2.5rem;
            font-size: 1.1rem;
            background: var(--gradient-accent);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            opacity: 0.5;
            transform: scale(0.95);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        #next-btn.enabled {
            opacity: 1;
            transform: scale(1);
        }

        #next-btn.enabled:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        /* XI Section */
        #xi-section {
            display: none;
            flex-direction: column;
            gap: 2rem;
            padding: 2rem;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .xi-header {
            text-align: center;
            margin-bottom: 1rem;
        }

        .xi-header h2 {
            font-size: 1.75rem;
            font-weight: 600;
            color: var(--fg);
            margin-bottom: 0.5rem;
        }

        .xi-header p {
            color: var(--fg-secondary);
            font-size: 1rem;
        }

        .xi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(560px, 1fr));
            gap: 2rem;
            max-width: 1960px;
            margin: 0 auto;
        }

        .pane {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .pane h3 {
            text-align: center;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--fg);
            margin: 0;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--card-border);
        }

        .sub-header {
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--fg-secondary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin: 0.5rem 0;
        }

        .bars {
            min-height: 180px;
            max-height: 450px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            padding: 1rem;
            border: 2px dashed var(--card-border);
            border-radius: var(--border-radius-sm);
            background: var(--bg-secondary);
            transition: var(--transition);
        }

        .bars.drag-over {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.1);
        }

        .player-bar {
            padding: 0.875rem 1rem;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius-sm);
            box-shadow: 0 2px 8px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: grab;
            transition: var(--transition);
            font-size: 0.875rem;
        }

        .player-bar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow-hover);
            border-color: var(--accent);
        }

        .player-bar.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .player-bar .info {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }

        .player-bar .controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .player-bar .controls label {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            font-size: 0.8rem;
            color: var(--fg-secondary);
            cursor: pointer;
        }

        .will-bowl {
            width: 14px;
            height: 14px;
            accent-color: var(--accent);
        }

        /* Bottom Controls */
        .bottom-controls {
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            padding: 2rem;
            margin: 2rem auto;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            gap: 2rem;
            align-items: center;
        }

        .controls-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            width: 100%;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }

        .control-label {
            font-weight: 600;
            font-size: 1rem;
            color: var(--accent);
            text-align: center;
        }

        .pitch-section select {
            padding: 0.75rem 1rem;
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius-sm);
            background: var(--bg-secondary);
            color: var(--fg);
            font-size: 0.95rem;
            min-width: 150px;
            transition: var(--transition);
        }

        .pitch-section select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .toss-options {
            display: flex;
            gap: 1.5rem;
        }

        .toss-options label {
            cursor: pointer;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1rem;
            border-radius: var(--border-radius-sm);
            transition: var(--transition);
            background: var(--bg-secondary);
            border: 1px solid var(--card-border);
        }

        .toss-options label:hover {
            background: var(--accent-light);
            border-color: var(--accent);
        }

        .toss-options input[type="radio"] {
            accent-color: var(--accent);
            width: 16px;
            height: 16px;
        }

        .rain-control {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
        }

        .rain-slider {
            width: 200px;
            height: 6px;
            border-radius: 3px;
            background: var(--bg-secondary);
            outline: none;
            appearance: none;
            -webkit-appearance: none;
        }

        .rain-slider::-webkit-slider-thumb {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            box-shadow: 0 2px 6px var(--shadow);
        }

        .rain-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 6px var(--shadow);
        }

        #rain-display {
            font-weight: 600;
            color: var(--accent);
        }

        #simulate-btn {
            padding: 1.25rem 3rem;
            font-size: 1.1rem;
            background: var(--gradient-accent);
            color: white;
            border: none;
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            opacity: 0.5;
            transform: scale(0.95);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        #simulate-btn.enabled {
            opacity: 1;
            transform: scale(1);
        }

        #simulate-btn.enabled:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.4);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .page-header {
                padding: 1rem;
            }

            .nav-center {
                gap: 1rem;
            }

            .theme-toggle {
                right: 1rem;
            }

            #page-title {
                font-size: 1.25rem;
            }

            .teams-grid {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            .xi-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .controls-grid {
                grid-template-columns: 1fr;
                gap: 1.5rem;
            }

            .toss-options {
                flex-direction: column;
                gap: 1rem;
            }

            .toss-options label {
                justify-content: center;
            }

            .bottom-controls {
                margin: 1rem;
                padding: 1.5rem;
            }

            .teams-section {
                padding: 1rem;
            }

            #xi-section {
                padding: 1rem;
            }

            .bars {
                min-height: 150px;
                max-height: 350px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding-top: 80px;
            }

            .team-card {
                padding: 1.25rem;
            }

            .pane {
                padding: 1.25rem;
            }

            .bars {
                min-height: 120px;
                max-height: 280px;
            }

            .rain-slider {
                width: 150px;
            }
        }

        /* Loading state */
        .loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .loading #simulate-btn {
            background: var(--fg-secondary);
        }
    </style>
</head>

<body>
    <!-- Navigation Header -->
    <div class="page-header">
        <div class="nav-center">
            <a href="{{ url_for('home') }}" class="home"><i class="fa fa-home"></i></a>
            <h1 id="page-title">Select Teams</h1>
        </div>
        <div id="theme-toggle" class="theme-toggle">🌙</div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Team Selection Section -->
        <div class="teams-section">
            <div class="section-header">
                <h2 class="section-title">Choose Your Teams</h2>
                <p class="section-subtitle">Select exactly 2 teams to set up your cricket match</p>
            </div>

            <div class="teams-grid">
                {% for team in teams %}
                <div class="team-card" data-index="{{ loop.index0 }}">
                    <h3>
                        <span class="color-dot" style="background: {{ team.team_color }}"></span>
                        {{ team.team_name }}
                    </h3>
                    <label>
                        <input type="checkbox" class="team-select" />
                        <span>Select Team</span>
                    </label>
                </div>
                {% endfor %}
            </div>

            <div class="next-btn-container">
                <button id="next-btn" disabled>
                    <i class="fa fa-users"></i>
                    Pick Playing XI
                </button>
            </div>
        </div>

        <!-- Playing XI Section -->
        <div id="xi-section">
            <div class="xi-header">
                <h2>Configure Playing XI</h2>
                <p>Drag players between sections. Each team needs exactly 11 players in Playing XI and 1-5 substitutes.
                </p>
            </div>

            <div class="xi-grid">
                <!-- Home Team Pane -->
                <div class="pane" id="home-pane">
                    <h3 id="home-name"></h3>

                    <h4 class="sub-header">Playing XI (<span id="home-selected-count">0</span>/11)</h4>
                    <div class="bars" id="home-selected" ondrop="dropHandler(event)" ondragover="dragOverHandler(event)"
                        ondragenter="dragEnterHandler(event)" ondragleave="dragLeaveHandler(event)">
                    </div>

                    <h4 class="sub-header">Substitutes (<span id="home-substitutes-count">0</span>/5)</h4>
                    <div class="bars" id="home-substitutes" ondrop="dropHandler(event)"
                        ondragover="dragOverHandler(event)" ondragenter="dragEnterHandler(event)"
                        ondragleave="dragLeaveHandler(event)">
                    </div>

                    <h4 class="sub-header">Available Players</h4>
                    <div class="bars" id="home-available" ondrop="dropHandler(event)"
                        ondragover="dragOverHandler(event)" ondragenter="dragEnterHandler(event)"
                        ondragleave="dragLeaveHandler(event)">
                    </div>
                </div>

                <!-- Away Team Pane -->
                <div class="pane" id="away-pane">
                    <h3 id="away-name"></h3>

                    <h4 class="sub-header">Playing XI (<span id="away-selected-count">0</span>/11)</h4>
                    <div class="bars" id="away-selected" ondrop="dropHandler(event)" ondragover="dragOverHandler(event)"
                        ondragenter="dragEnterHandler(event)" ondragleave="dragLeaveHandler(event)">
                    </div>

                    <h4 class="sub-header">Substitutes (<span id="away-substitutes-count">0</span>/5)</h4>
                    <div class="bars" id="away-substitutes" ondrop="dropHandler(event)"
                        ondragover="dragOverHandler(event)" ondragenter="dragEnterHandler(event)"
                        ondragleave="dragLeaveHandler(event)">
                    </div>

                    <h4 class="sub-header">Available Players</h4>
                    <div class="bars" id="away-available" ondrop="dropHandler(event)"
                        ondragover="dragOverHandler(event)" ondragenter="dragEnterHandler(event)"
                        ondragleave="dragLeaveHandler(event)">
                    </div>
                </div>
            </div>

            <!-- Match Configuration -->
            <div class="bottom-controls">
                <div class="controls-grid">
                    <!-- Pitch Selection -->
                    <div class="control-group">
                        <div class="control-label">Pitch Type</div>
                        <div class="pitch-section">
                            <select id="pitch-select"></select>
                        </div>
                    </div>

                    <!-- Toss Choice -->
                    <div class="control-group">
                        <div class="control-label" id="toss-label">Toss Choice</div>
                        <div class="toss-options">
                            <label>
                                <input type="radio" name="toss" value="Heads">
                                <i class="fa fa-coins"></i>
                                Heads
                            </label>
                            <label>
                                <input type="radio" name="toss" value="Tails">
                                <i class="fa fa-coins"></i>
                                Tails
                            </label>
                        </div>
                    </div>

                    <!-- Rain Probability -->
                    <div class="control-group">
                        <div class="control-label">
                            Rain Probability: <span id="rain-display">0%</span>
                        </div>
                        <div class="rain-control">
                            <input type="range" id="rain-probability" class="rain-slider" min="0" max="0.1" step="0.001"
                                value="0" oninput="updateRainDisplay(this.value)">
                        </div>
                    </div>
                </div>

                <button id="simulate-btn" disabled>
                    <i class="fa fa-rocket"></i>
                    Simulate Match
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
        function updateRainDisplay(value) {
            const percentage = Math.round(parseFloat(value) * 100);
            document.getElementById('rain-display').textContent = `${percentage}%`;
        }

        // Teams JSON
        const TEAMS = {{ teams| tojson }};

        // Team selection logic (locks after XI)
        const cards = document.querySelectorAll('.team-card'),
            nextBtn = document.getElementById('next-btn'),
            pageTitle = document.getElementById('page-title');
        let selected = [];

        cards.forEach(card => {
            const cb = card.querySelector('.team-select');
            card.onclick = e => {
                if (document.getElementById('xi-section').style.display === 'flex') return;
                if (e.target !== cb) {
                    if (!cb.checked && selected.length >= 2) return;
                    cb.checked = !cb.checked;
                }
                const idx = +card.dataset.index;
                cb.checked ? selected.push(idx) : selected.splice(selected.indexOf(idx), 1);
                cards.forEach((c, i) => c.classList.toggle('selected', selected.includes(i)));
                nextBtn.disabled = selected.length !== 2;
                nextBtn.classList.toggle('enabled', selected.length === 2);
                if (selected.length === 2) {
                    const t1 = cards[selected[0]].querySelector('h3').textContent.trim();
                    const t2 = cards[selected[1]].querySelector('h3').textContent.trim();
                    pageTitle.textContent = `${t1} vs ${t2}`;
                } else {
                    pageTitle.textContent = 'Select Teams';
                }
            };
        });

        // Show XI & render players
        nextBtn.onclick = () => {
            if (selected.length !== 2) return;
            cards.forEach(c => c.style.pointerEvents = 'none');
            document.getElementById('xi-section').style.display = 'flex';
            const [h, a] = selected.map(i => TEAMS[i]);
            document.getElementById('home-name').textContent = h.team_name;
            document.getElementById('away-name').textContent = a.team_name;
            document.getElementById('toss-label').textContent = `${a.team_name} Toss Choice`;

            // Pitch options
            const psel = document.getElementById('pitch-select');
            psel.innerHTML = `<option>${h.pitch_preference}</option>` +
                ['Green', 'Flat', 'Dry', 'Hard', 'Dead']
                    .filter(x => x !== h.pitch_preference)
                    .map(x => `<option>${x}</option>`).join('');

            // Icons mapping
            const roleIcons = {
                'Batsman': '🏏',
                'Bowler': '🎳',
                'Wicketkeeper': '🧤',
                'All-rounder': '🏏🎳'
            };

            ['home', 'away'].forEach(side => {
                const team = side === 'home' ? h : a;
                const avail = document.getElementById(`${side}-available`);
                avail.innerHTML = '';
                team.players.forEach(p => {
                    const bar = document.createElement('div');
                    bar.className = 'player-bar';
                    bar.draggable = true;
                    bar.dataset.playerName = p.name;
                    bar.dataset.role = p.role;
                    bar.innerHTML = `<span class="info">${roleIcons[p.role] || ''} ${p.name}</span>` +
                        ((['Bowler', 'All-rounder'].includes(p.role))
                            ? `<span class="controls">
                                   <label>
                                     <input type="checkbox" class="will-bowl">
                                     <i class="fa fa-dot-circle"></i> Bowl
                                   </label>
                               </span>`
                            : '');
                    bar.addEventListener('dragstart', () => bar.classList.add('dragging'));
                    bar.addEventListener('dragend', () => { bar.classList.remove('dragging'); validateAll(); });
                    avail.appendChild(bar);
                });
            });

            updatePlayerCounts();
            validateAll();
        };

        // Drag & drop handlers
        function dragEnterHandler(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
        function dragLeaveHandler(e) { e.preventDefault(); e.currentTarget.classList.remove('drag-over'); }
        function dragOverHandler(e) { e.preventDefault(); }
        function dropHandler(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            const bar = document.querySelector('.player-bar.dragging');
            if (!bar) return;
            const dst = e.currentTarget;
            const after = getDragAfterElement(dst, e.clientY);
            after ? dst.insertBefore(bar, after) : dst.appendChild(bar);
            updatePlayerCounts();
            validateAll();
        }
        function getDragAfterElement(container, y) {
            return [...container.querySelectorAll('.player-bar:not(.dragging)')]
                .reduce((closest, child) => {
                    const box = child.getBoundingClientRect();
                    const offset = y - box.top - box.height / 2;
                    return (offset < 0 && offset > closest.offset)
                        ? { offset, element: child }
                        : closest;
                }, { offset: -Infinity }).element;
        }

        // Live selected count
        function updatePlayerCounts() {
            ['home', 'away'].forEach(side => {
                const selectedCount = document.getElementById(`${side}-selected`).querySelectorAll('.player-bar').length;
                const substitutesCount = document.getElementById(`${side}-substitutes`).querySelectorAll('.player-bar').length;
                document.getElementById(`${side}-selected-count`).textContent = selectedCount;
                document.getElementById(`${side}-substitutes-count`).textContent = substitutesCount;
            });
        }

        // Validation (show all rules)
        const tosses = document.getElementsByName('toss'),
            simBtn = document.getElementById('simulate-btn');

        function validateAll() {

            if (!selected || selected.length !== 2) {
                simulateBtn.disabled = true;
                return;
            }

            const errors = [];

            ['home', 'away'].forEach((side, i) => {
                const teamData = TEAMS[selected[i]];
                const teamName = teamData.team_name;

                // Validate Playing XI
                const playingXI = document.getElementById(`${side}-selected`).querySelectorAll('.player-bar');
                if (playingXI.length !== 11) {
                    errors.push(`${teamName}: Need exactly 11 players in Playing XI (${playingXI.length}/11).`);
                }
                if ([...playingXI].filter(b => b.dataset.role === 'Wicketkeeper').length < 1) {
                    errors.push(`${teamName}: Need at least 1 Wicketkeeper in Playing XI.`);
                }
                if ([...playingXI].filter(b => b.querySelector('.will-bowl')?.checked).length < 5) {
                    errors.push(`${teamName}: Need at least 5 bowlers in Playing XI.`);
                }

                // Validate Substitutes
                const substitutes = document.getElementById(`${side}-substitutes`).querySelectorAll('.player-bar');
                if (substitutes.length < 1 || substitutes.length > 5) {
                    errors.push(`${teamName}: Need 1 to 5 substitute players (${substitutes.length} selected).`);
                }
            });

            if (![...tosses].some(r => r.checked)) {
                errors.push('Select toss choice (Heads or Tails).');
            }

            const old = document.querySelector('.flash');
            if (old) old.remove();

            if (errors.length) {
                const div = document.createElement('div');
                div.className = 'flash';
                div.innerHTML = `<i class="fa fa-exclamation-triangle"></i> `
                    + errors.join('<br><i class="fa fa-exclamation-triangle"></i> ');
                document.getElementById('xi-section').prepend(div);
                simBtn.disabled = true;
                simBtn.classList.remove('enabled');
            } else {
                simBtn.disabled = false;
                simBtn.classList.add('enabled');
            }
        }
        tosses.forEach(r => r.addEventListener('change', validateAll));

        // FINAL: Handle "Simulate Match" click
        const simulateBtn = document.getElementById('simulate-btn');
        simulateBtn.addEventListener('click', async () => {
            // Add loading state
            document.body.classList.add('loading');
            simulateBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> Setting up match...';

            try {
                // 1️⃣ Gather data
                const [hIdx, aIdx] = selected;
                const home = TEAMS[hIdx], away = TEAMS[aIdx];
                const payload = {
                    team_home: `${home.short_code}_${home.created_by_email}`,
                    team_away: `${away.short_code}_${away.created_by_email}`,
                    stadium: home.home_ground,
                    pitch: document.getElementById('pitch-select').value,
                    rain_probability: parseFloat(document.getElementById('rain-probability').value),
                    playing_xi: {
                        home: [...document.getElementById('home-selected').querySelectorAll('.player-bar')]
                            .map(bar => ({
                                name: bar.dataset.playerName,
                                role: bar.dataset.role,
                                will_bowl: Boolean(bar.querySelector('.will-bowl')?.checked)
                            })),
                        away: [...document.getElementById('away-selected').querySelectorAll('.player-bar')]
                            .map(bar => ({
                                name: bar.dataset.playerName,
                                role: bar.dataset.role,
                                will_bowl: Boolean(bar.querySelector('.will-bowl')?.checked)
                            }))
                    },
                    substitutes: {
                        home: [...document.getElementById('home-substitutes').querySelectorAll('.player-bar')]
                            .map(bar => ({
                                name: bar.dataset.playerName,
                                role: bar.dataset.role,
                                will_bowl: Boolean(bar.querySelector('.will-bowl')?.checked)
                            })),
                        away: [...document.getElementById('away-substitutes').querySelectorAll('.player-bar')]
                            .map(bar => ({
                                name: bar.dataset.playerName,
                                role: bar.dataset.role,
                                will_bowl: Boolean(bar.querySelector('.will-bowl')?.checked)
                            }))
                    },
                    toss: document.querySelector('input[name="toss"]:checked').value
                };

                // 2️⃣ POST
                const res = await fetch("/match/setup", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                // 3️⃣ Redirect or alert
                if (res.ok) {
                    const { match_id } = await res.json();
                    window.location.href = `/match/${match_id}`;
                } else {
                    const err = await res.json();
                    alert("❌ " + (err.error || "Could not save match"));

                    // Reset button state
                    document.body.classList.remove('loading');
                    simulateBtn.innerHTML = '<i class="fa fa-rocket"></i> Simulate Match';
                }
            } catch (error) {
                console.error('Error setting up match:', error);
                alert("❌ Network error. Please try again.");

                // Reset button state
                document.body.classList.remove('loading');
                simulateBtn.innerHTML = '<i class="fa fa-rocket"></i> Simulate Match';
            }
        });

        // Add smooth scroll to XI section when it becomes visible
        const xiSection = document.getElementById('xi-section');
        const observer = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'attributes' && mutation.attributeName === 'style') {
                    if (xiSection.style.display === 'flex') {
                        setTimeout(() => {
                            xiSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                        }, 100);
                    }
                }
            });
        });
        observer.observe(xiSection, { attributes: true });
    </script>
</body>

</html>