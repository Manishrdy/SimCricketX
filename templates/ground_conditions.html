{% extends "layout.html" %}
{% block title %}Ground Conditions — SimCricketX{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/ground_conditions.css') }}">
{% endblock %}

{% block content %}
<!-- Header -->
<div class="gc-header">
    <h1 class="gc-title">Ground Conditions</h1>
    <p class="gc-subtitle">Configure pitch profiles, game modes, and simulation engine parameters</p>
</div>

<!-- Game Mode Selector -->
<section class="gc-modes">
    <div class="gc-modes-label"><i class="fa-solid fa-gamepad"></i> Game Mode</div>
    <div class="gc-modes-row" id="gcModesRow">
        {% for key, mode in (config.get('game_modes') or {}).items() %}
        <div class="gc-mode-card{% if key == config.get('active_game_mode', 'natural_game') %} active{% endif %}"
            data-mode="{{ key }}" onclick="setGameMode('{{ key }}')">
            <div class="gc-mode-glow"></div>
            <div class="gc-mode-check"><i class="fa-solid fa-check"></i></div>
            <div class="gc-mode-icon"><i class="fa-solid {{ mode.get('icon', 'fa-circle') }}"></i></div>
            <div class="gc-mode-name">{{ mode.get('label', key) }}</div>
            <div class="gc-mode-desc">{{ mode.get('description', '') }}</div>
            <div class="gc-mode-badge">
                {% if key == 'natural_game' %}
                <span class="gc-badge-tag">All x1.0</span>
                {% elif key == 'aggressive' %}
                <span class="gc-badge-tag gc-badge-up">6s +40%</span>
                <span class="gc-badge-tag gc-badge-up">W +25%</span>
                {% elif key == 'defensive' %}
                <span class="gc-badge-tag gc-badge-down">6s -40%</span>
                <span class="gc-badge-tag gc-badge-up">Dots +20%</span>
                {% elif key == 'flat_track_bully' %}
                <span class="gc-badge-tag gc-badge-up">6s +50%</span>
                <span class="gc-badge-tag gc-badge-down">W -40%</span>
                {% elif key == 'bowlers_day' %}
                <span class="gc-badge-tag gc-badge-up">W +50%</span>
                <span class="gc-badge-tag gc-badge-down">6s -50%</span>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Pitch Profile Tiles -->
<section>
    <div class="gc-section-header">
        <i class="fa-solid fa-mountain-sun"></i>
        <span class="gc-section-title">Pitch Profiles</span>
    </div>
    <div class="gc-pitch-grid" id="gcPitchGrid">
        {% for pitch_name, profile in (config.get('pitch_profiles') or {}).items() %}
        {% set sm = profile.get('scoring_matrix', {}) %}
        <div class="gc-pitch-card" data-pitch="{{ pitch_name }}">
            <!-- ── Compact Tile (always visible) ── -->
            <div class="gc-pitch-summary" onclick="openPitchEditor('{{ pitch_name }}')">
                <div class="gc-pitch-top">
                    <div class="gc-pitch-identity">
                        <span class="gc-pitch-dot"></span>
                        <span class="gc-pitch-name">{{ pitch_name }}</span>
                    </div>
                    <span class="gc-pitch-rf-pill">RF {{ profile.get('run_factor', 1.0) }}</span>
                </div>
                <div class="gc-pitch-tagline">{{ profile.get('description', '') }}</div>

                <!-- DNA Stacked Bar -->
                <div class="gc-dna-wrap">
                    <div class="gc-dna-bar">
                        {% for outcome, value in sm.items() %}
                        <div class="gc-dna-seg" data-type="{{ outcome }}" style="width:{{ (value * 100) | round(1) }}%"
                            title="{{ outcome }}: {{ (value * 100) | round(1) }}%"></div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Quick Stats -->
                <div class="gc-pitch-stats">
                    <span class="gc-stat-pill gc-stat-dot">Dot {{ (sm.get('Dot', 0) * 100) | round(0) | int }}%</span>
                    <span class="gc-stat-pill gc-stat-bnd">Bnd {{ ((sm.get('Four', 0) + sm.get('Six', 0)) * 100) |
                        round(0) | int }}%</span>
                    <span class="gc-stat-pill gc-stat-wkt">W {{ (sm.get('Wicket', 0) * 100) | round(1) }}%</span>
                </div>

                <!-- Wicket Factor Highlights -->
                <div class="gc-pitch-wf-pills">
                    {% for style, wf_val in (profile.get('wicket_factors') or {}).items() %}
                    <span
                        class="gc-wf-pill {% if wf_val >= 1.2 %}gc-wf-hot{% elif wf_val <= 0.7 %}gc-wf-cold{% endif %}">{{
                        style }} {{ wf_val }}x</span>
                    {% endfor %}
                </div>

                <div class="gc-pitch-configure-btn">
                    <i class="fa-solid fa-sliders"></i> Configure
                </div>
            </div>

            <!-- Hidden edit body (moved into modal via JS) -->
            <div class="gc-pitch-body" style="display:none;">
                <div class="gc-editor-container">

                    <!-- ── Top Row: Run Factor & Totals ── -->
                    <div class="gc-editor-header-row">
                        <div class="gc-rf-widget">
                            <label class="gc-label-sm">Run Factor (Scoring Pace)</label>
                            <div class="gc-rf-control">
                                <i class="fa-solid fa-gauge-high"></i>
                                <input type="range" class="gc-rf-range" step="0.05" min="0.5" max="2.0"
                                    value="{{ profile.get('run_factor', 1.0) }}"
                                    oninput="this.nextElementSibling.value = parseFloat(this.value).toFixed(2); this.parentElement.querySelector('.gc-factor-input').value = this.value;">
                                <output>{{ "%.2f"|format(profile.get('run_factor', 1.0)) }}</output>
                                <!-- Source of Truth Input -->
                                <input type="number" class="gc-factor-input hidden-input" step="0.01" min="0" max="3"
                                    value="{{ profile.get('run_factor', 1.0) }}" data-pitch="{{ pitch_name }}"
                                    data-field="run_factor">
                            </div>
                        </div>

                        <div class="gc-editor-meta">
                            <div class="gc-total-display valid" id="total-{{ pitch_name }}">
                                <span class="gc-label-sm">Probability Sum</span>
                                <span class="val">1.000</span>
                            </div>
                            <button class="gc-btn-normalize" onclick="normalizePitch('{{ pitch_name }}')">
                                <i class="fa-solid fa-scale-balanced"></i> Normalize
                            </button>
                        </div>
                    </div>

                    <!-- ── Scoring Probabilities ── -->
                    <div class="gc-editor-section">
                        <div class="gc-section-label">Outcome Probabilities</div>
                        <div class="gc-matrix-grid">
                            {% for outcome, value in sm.items() %}
                            <div class="gc-matrix-tile" data-type="{{ outcome }}">
                                <div class="gc-tile-header">
                                    <span class="gc-outcome-name">{{ outcome }}</span>
                                    <span class="gc-outcome-val">{{ (value * 100)|round(1) }}%</span>
                                </div>
                                <div class="gc-slider-wrapper" style="--val: {{ value * 100 }}%">
                                    <input type="range" class="gc-matrix-range" step="0.001" min="0" max="1"
                                        value="{{ value }}" oninput="
                                            const val = parseFloat(this.value);
                                            this.parentElement.style.setProperty('--val', (val * 100) + '%');
                                            this.parentNode.previousElementSibling.querySelector('.gc-outcome-val').textContent = (val * 100).toFixed(1) + '%';
                                            const realInput = this.parentElement.querySelector('.gc-matrix-input');
                                            realInput.value = val;
                                            onMatrixChange(realInput);
                                           ">
                                    <!-- Source of Truth Input -->
                                    <input type="number" class="gc-matrix-input hidden-input" step="0.005" min="0"
                                        max="1" value="{{ value }}" data-pitch="{{ pitch_name }}"
                                        data-outcome="{{ outcome }}" oninput="onMatrixChange(this)">
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- ── Wicket Factors ── -->
                    <div class="gc-editor-section">
                        <div class="gc-section-label">Wicket Multipliers (Risk)</div>
                        <div class="gc-wf-grid-modern">
                            {% for style, wf_val in (profile.get('wicket_factors') or {}).items() %}
                            <div class="gc-wf-tile">
                                <div class="gc-wf-icon">
                                    {% if 'Pace' in style %}<i class="fa-solid fa-fire-flame-curved"></i>
                                    {% elif 'Spin' in style %}<i class="fa-solid fa-hurricane"></i>
                                    {% else %}<i class="fa-solid fa-bullseye"></i>{% endif %}
                                </div>
                                <div class="gc-wf-info">
                                    <div class="gc-wf-name">{{ style }}</div>
                                    <div class="gc-stepper">
                                        <button class="gc-step-btn" onclick="adjustWF(this, -0.05)">-</button>
                                        <input type="number" class="gc-wf-input" step="0.05" min="0" max="3"
                                            value="{{ wf_val }}" data-pitch="{{ pitch_name }}" data-wf="{{ style }}">
                                        <button class="gc-step-btn" onclick="adjustWF(this, 0.05)">+</button>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</section>

<!-- Pitch Editor Modal -->
<div class="gc-pitch-modal-overlay" id="gcPitchEditorModal">
    <div class="gc-pitch-modal" data-pitch="">
        <div class="gc-pitch-modal-header">
            <div class="gc-pitch-modal-title">
                <span class="gc-pitch-dot"></span>
                <span id="gcPitchModalName"></span>
            </div>
            <button class="gc-pitch-modal-close" onclick="closePitchEditor()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
        <div class="gc-pitch-modal-body" id="gcPitchModalBody">
            <!-- .gc-pitch-body gets DOM-moved here -->
        </div>
    </div>
</div>

<!-- Phase Boosts (Collapsible) -->
<section class="gc-phase-section">
    <button class="gc-phase-toggle" onclick="togglePhase(this)" aria-expanded="false">
        <span><i class="fa-solid fa-bolt" style="color:var(--accent);margin-right:0.5rem;"></i> Phase Boosts</span>
        <i class="fa-solid fa-chevron-down chevron"></i>
    </button>
    <div class="gc-phase-body" id="gcPhaseBody">
        {% set pb = config.get('phase_boosts', {}) %}
        {% set pp = pb.get('powerplay', {}) %}
        {% set death = pb.get('death_overs', {}) %}
        {% set inn2 = pb.get('second_innings_death', {}) %}

        <div class="gc-factor-label" style="margin-bottom:0.75rem;">Powerplay (Overs {{ pp.get('overs_start', 0)+1 }}-{{
            pp.get('overs_end', 5)+1 }})</div>
        <div class="gc-phase-grid" style="margin-bottom:1.5rem;">
            <div class="gc-phase-item">
                <label>Boundary Multiplier</label>
                <input type="number" step="0.05" min="0" max="5" value="{{ pp.get('boundary_multiplier', 1.25) }}"
                    id="pp-boundary">
            </div>
        </div>

        <div class="gc-factor-label" style="margin-bottom:0.75rem;">Death Overs (Overs {{ death.get('overs_start', 16)+1
            }}-{{ death.get('overs_end', 19)+1 }})</div>
        <div class="gc-phase-grid" style="margin-bottom:1.5rem;">
            <div class="gc-phase-item">
                <label>Boundary Boost (Batting Pitch)</label>
                <input type="number" step="0.1" min="0" max="5"
                    value="{{ death.get('boundary_boost_batting_pitch', 2.2) }}" id="death-bat-boundary">
            </div>
            <div class="gc-phase-item">
                <label>Boundary Boost (Bowling Pitch)</label>
                <input type="number" step="0.1" min="0" max="5"
                    value="{{ death.get('boundary_boost_bowling_pitch', 1.8) }}" id="death-bowl-boundary">
            </div>
            <div class="gc-phase-item">
                <label>Wicket Boost</label>
                <input type="number" step="0.1" min="0" max="5" value="{{ death.get('wicket_boost', 1.6) }}"
                    id="death-wicket">
            </div>
        </div>

        <div class="gc-factor-label" style="margin-bottom:0.75rem;">2nd Innings Death Overs</div>
        <div class="gc-phase-grid">
            <div class="gc-phase-item">
                <label>Scoring Boost</label>
                <input type="number" step="0.05" min="0" max="5" value="{{ inn2.get('scoring_boost', 1.15) }}"
                    id="inn2-scoring">
            </div>
            <div class="gc-phase-item">
                <label>Wicket Boost</label>
                <input type="number" step="0.05" min="0" max="5" value="{{ inn2.get('wicket_boost', 1.1) }}"
                    id="inn2-wicket">
            </div>
        </div>
    </div>
</section>

<!-- Blending Weights -->
<section class="gc-blending">
    <div class="gc-section-header" style="border-bottom:none;margin-bottom:0;padding-bottom:0;">
        <i class="fa-solid fa-sliders"></i>
        <span class="gc-section-title">Blending Weights</span>
    </div>
    {% set bl = config.get('blending', {}) %}
    <div class="gc-blend-row">
        <span class="gc-blend-label">Pitch</span>
        <input type="range" class="gc-blend-slider" id="blendPitch" min="0" max="100"
            value="{{ ((bl.get('pitch_weight', 0.6)) * 100) | int }}" oninput="onBlendChange(this)">
        <span class="gc-blend-value" id="blendPitchVal">{{ ((bl.get('pitch_weight', 0.6)) * 100) | int }}%</span>
    </div>
    <div class="gc-blend-row">
        <span class="gc-blend-label">Skill</span>
        <input type="range" class="gc-blend-slider" id="blendSkill" min="0" max="100"
            value="{{ ((bl.get('skill_weight', 0.4)) * 100) | int }}" oninput="onBlendChange(this)">
        <span class="gc-blend-value" id="blendSkillVal">{{ ((bl.get('skill_weight', 0.4)) * 100) | int }}%</span>
    </div>
</section>

<!-- Action Bar -->
<div class="gc-actions">
    <button class="gc-btn gc-btn-reset" onclick="confirmReset()">
        <i class="fa-solid fa-rotate-left"></i> Reset to Defaults
    </button>
    <button class="gc-btn gc-btn-save" id="btnSaveAll" onclick="saveAll()">
        <i class="fa-solid fa-floppy-disk"></i> Save All
    </button>
</div>

<!-- Guide FAB -->
<a href="/ground-conditions/guide" target="_blank" class="gc-guide-fab" title="Open Ground Conditions Guide">
    <i class="fa-solid fa-book-open"></i>
    <span>Guide</span>
</a>

<!-- Toast -->
<div class="gc-toast" id="gcToast"></div>

<!-- Reset Confirmation Modal -->
<div class="gc-modal-overlay" id="gcResetModal">
    <div class="gc-modal">
        <div class="gc-modal-icon"><i class="fa-solid fa-triangle-exclamation"></i></div>
        <h3>Reset to Defaults?</h3>
        <p>This will revert all pitch profiles, game modes, and phase boosts to their factory settings.</p>
        <div class="gc-modal-actions">
            <button class="gc-btn gc-btn-reset" onclick="closeResetModal()"
                style="border-color:var(--card-border);color:var(--fg-secondary);">Cancel</button>
            <button class="gc-btn gc-btn-save" onclick="doReset()">
                <i class="fa-solid fa-rotate-left"></i> Reset
            </button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="application/json" id="gc-config-data">
{{ config | tojson | safe }}
</script>
<script>
    (function () {
        // ── State ──
        const CONFIG = JSON.parse(document.getElementById('gc-config-data').textContent);

        // ── Toast ──
        function showToast(msg, type) {
            const t = document.getElementById('gcToast');
            t.textContent = msg;
            t.className = 'gc-toast ' + type + ' show';
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // ── Game Mode ──
        window.setGameMode = async function (mode) {
            try {
                const resp = await fetch('/ground-conditions/mode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ mode })
                });
                const data = await resp.json();
                if (resp.ok) {
                    document.querySelectorAll('.gc-mode-card').forEach(c => {
                        c.classList.toggle('active', c.dataset.mode === mode);
                    });
                    CONFIG.active_game_mode = mode;
                    // Pulse animation on the newly active card
                    const activeCard = document.querySelector(`.gc-mode-card[data-mode="${mode}"]`);
                    if (activeCard) {
                        activeCard.classList.add('gc-mode-pulse');
                        activeCard.addEventListener('animationend', () => {
                            activeCard.classList.remove('gc-mode-pulse');
                        }, { once: true });
                    }
                    showToast(data.message, 'success');
                } else {
                    showToast(data.error || 'Failed to set mode', 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        };

        // ── Pitch Editor Modal ──
        let activePitchCard = null;

        window.openPitchEditor = function (pitch) {
            const card = document.querySelector(`.gc-pitch-card[data-pitch="${pitch}"]`);
            if (!card) return;

            const body = card.querySelector('.gc-pitch-body');
            const modal = document.getElementById('gcPitchEditorModal');
            const modalPanel = modal.querySelector('.gc-pitch-modal');
            const modalBody = document.getElementById('gcPitchModalBody');

            // Set pitch context on modal
            modalPanel.dataset.pitch = pitch;
            document.getElementById('gcPitchModalName').textContent = pitch + ' Pitch';

            // DOM-move the edit body into the modal
            modalBody.appendChild(body);
            body.style.display = '';

            // Show modal
            modal.classList.add('show');
            document.body.style.overflow = 'hidden';
            activePitchCard = card;

            // Re-init bar widths (they may not have been set while hidden)
            body.querySelectorAll('.gc-bar-fill[data-width]').forEach(bar => {
                bar.style.width = bar.dataset.width + '%';
            });
        };

        window.closePitchEditor = function () {
            const modal = document.getElementById('gcPitchEditorModal');
            const modalBody = document.getElementById('gcPitchModalBody');
            const body = modalBody.querySelector('.gc-pitch-body');

            if (activePitchCard && body) {
                // DOM-move back into the card (keeps inputs + values for buildConfig)
                body.style.display = 'none';
                activePitchCard.appendChild(body);
            }

            modal.classList.remove('show');
            document.body.style.overflow = '';
            activePitchCard = null;
        };

        // Close modal on backdrop click
        document.getElementById('gcPitchEditorModal').addEventListener('click', function (e) {
            if (e.target === this) closePitchEditor();
        });

        // ── Matrix Input Change ──
        window.onMatrixChange = function (input) {
            // Sync range slider if this came from the numeric input (rare/hidden)
            const tile = input.closest('.gc-matrix-tile');
            if (tile) {
                const wrapper = tile.querySelector('.gc-slider-wrapper');
                if (wrapper) {
                    wrapper.style.setProperty('--val', (input.value * 100) + '%');
                }
                // Update numeric disply
                const disp = tile.querySelector('.gc-outcome-val');
                if (disp) disp.textContent = (input.value * 100).toFixed(1) + '%';

                // Sync range input value itself
                const range = tile.querySelector('.gc-matrix-range');
                if (range) range.value = input.value;
            }
            updateTotal(input.dataset.pitch);
        };

        function updateTotal(pitch) {
            const inputs = document.querySelectorAll(`.gc-matrix-input[data-pitch="${pitch}"]`);
            let total = 0;
            inputs.forEach(inp => total += parseFloat(inp.value) || 0);
            const el = document.getElementById('total-' + pitch);
            if (el) {
                // Find the value span inside if it exists, or just set text content
                const valSpan = el.querySelector('.val');
                if (valSpan) valSpan.textContent = total.toFixed(3);
                else el.textContent = 'Total: ' + total.toFixed(3);

                el.className = 'gc-total-display ' + (Math.abs(total - 1.0) < 0.005 ? 'valid' : 'invalid');
            }
        }

        // ── Wicket Factor Adjust ──
        window.adjustWF = function (btn, delta) {
            const input = btn.parentElement.querySelector('input');
            let val = parseFloat(input.value) || 0;
            val = Math.max(0, Math.min(3, val + delta));
            input.value = val.toFixed(2);
        };

        // ── Normalize ──
        window.normalizePitch = function (pitch) {
            const inputs = document.querySelectorAll(`.gc-matrix-input[data-pitch="${pitch}"]`);
            let total = 0;
            inputs.forEach(inp => total += parseFloat(inp.value) || 0);
            if (total <= 0) return;

            inputs.forEach(inp => {
                const normalized = (parseFloat(inp.value) || 0) / total;
                inp.value = normalized.toFixed(4);

                // Update UI
                const tile = inp.closest('.gc-matrix-tile');
                if (tile) {
                    const wrapper = tile.querySelector('.gc-slider-wrapper');
                    if (wrapper) {
                        wrapper.style.setProperty('--val', (normalized * 100) + '%');
                    }
                    const range = tile.querySelector('.gc-matrix-range');
                    if (range) range.value = normalized;

                    const disp = tile.querySelector('.gc-outcome-val');
                    if (disp) disp.textContent = (normalized * 100).toFixed(1) + '%';
                }
            });
            updateTotal(pitch);
        };
        // ── Blending ──
        // ── Blending ──
        window.onBlendChange = function (slider) {
            let pitchVal, skillVal;

            if (slider.id === 'blendPitch') {
                pitchVal = parseInt(slider.value);
                skillVal = 100 - pitchVal;
                document.getElementById('blendSkill').value = skillVal;
            } else {
                skillVal = parseInt(slider.value);
                pitchVal = 100 - skillVal;
                document.getElementById('blendPitch').value = pitchVal;
            }

            document.getElementById('blendPitchVal').textContent = pitchVal + '%';
            document.getElementById('blendSkillVal').textContent = skillVal + '%';
        };

        // ── Phase Toggle ──
        window.togglePhase = function (btn) {
            const body = document.getElementById('gcPhaseBody');
            const expanded = btn.getAttribute('aria-expanded') === 'true';
            btn.setAttribute('aria-expanded', !expanded);
            body.classList.toggle('open');
        };

        // ── Build config from UI ──
        function buildConfig() {
            const cfg = JSON.parse(JSON.stringify(CONFIG));

            // Pitch profiles — query globally by data-pitch since inputs
            // may be inside the editor modal rather than the card
            document.querySelectorAll('.gc-pitch-card').forEach(card => {
                const pName = card.dataset.pitch;
                if (!cfg.pitch_profiles[pName]) cfg.pitch_profiles[pName] = {};
                const profile = cfg.pitch_profiles[pName];

                // Scoring matrix
                profile.scoring_matrix = {};
                document.querySelectorAll(`.gc-matrix-input[data-pitch="${pName}"]`).forEach(inp => {
                    profile.scoring_matrix[inp.dataset.outcome] = parseFloat(inp.value) || 0;
                });

                // Run factor
                const rfInp = document.querySelector(`.gc-factor-input[data-pitch="${pName}"][data-field="run_factor"]`);
                if (rfInp) profile.run_factor = parseFloat(rfInp.value) || 1.0;

                // Wicket factors
                profile.wicket_factors = {};
                document.querySelectorAll(`.gc-wf-input[data-pitch="${pName}"]`).forEach(inp => {
                    profile.wicket_factors[inp.dataset.wf] = parseFloat(inp.value) || 1.0;
                });
            });

            // Phase boosts
            cfg.phase_boosts = cfg.phase_boosts || {};
            cfg.phase_boosts.powerplay = cfg.phase_boosts.powerplay || {};
            cfg.phase_boosts.powerplay.boundary_multiplier = parseFloat(document.getElementById('pp-boundary').value) || 1.25;
            cfg.phase_boosts.powerplay.overs_start = 0;
            cfg.phase_boosts.powerplay.overs_end = 5;

            cfg.phase_boosts.death_overs = cfg.phase_boosts.death_overs || {};
            cfg.phase_boosts.death_overs.boundary_boost_batting_pitch = parseFloat(document.getElementById('death-bat-boundary').value) || 2.2;
            cfg.phase_boosts.death_overs.boundary_boost_bowling_pitch = parseFloat(document.getElementById('death-bowl-boundary').value) || 1.8;
            cfg.phase_boosts.death_overs.wicket_boost = parseFloat(document.getElementById('death-wicket').value) || 1.6;
            cfg.phase_boosts.death_overs.overs_start = 16;
            cfg.phase_boosts.death_overs.overs_end = 19;

            cfg.phase_boosts.second_innings_death = cfg.phase_boosts.second_innings_death || {};
            cfg.phase_boosts.second_innings_death.scoring_boost = parseFloat(document.getElementById('inn2-scoring').value) || 1.15;
            cfg.phase_boosts.second_innings_death.wicket_boost = parseFloat(document.getElementById('inn2-wicket').value) || 1.1;

            // Blending
            const pitchW = parseInt(document.getElementById('blendPitch').value) / 100;
            cfg.blending = { pitch_weight: pitchW, skill_weight: 1 - pitchW };

            return cfg;
        }

        // ── Save All ──
        window.saveAll = async function () {
            const btn = document.getElementById('btnSaveAll');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

            try {
                const cfg = buildConfig();
                const resp = await fetch('/ground-conditions/save', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(cfg)
                });
                const data = await resp.json();
                if (resp.ok) {
                    showToast(data.message, 'success');
                } else {
                    showToast(data.error || 'Save failed', 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }

            btn.disabled = false;
            btn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save All';
        };

        // ── Reset ──
        window.confirmReset = function () {
            document.getElementById('gcResetModal').classList.add('show');
        };
        window.closeResetModal = function () {
            document.getElementById('gcResetModal').classList.remove('show');
        };
        window.doReset = async function () {
            closeResetModal();
            try {
                const resp = await fetch('/ground-conditions/reset', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                });
                const data = await resp.json();
                if (resp.ok) {
                    showToast('Reset to defaults — reloading...', 'success');
                    setTimeout(() => location.reload(), 800);
                } else {
                    showToast(data.error || 'Reset failed', 'error');
                }
            } catch (e) {
                showToast('Network error', 'error');
            }
        };

        // Close modal on backdrop click / Escape
        document.getElementById('gcResetModal').addEventListener('click', function (e) {
            if (e.target === this) closeResetModal();
        });
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                if (document.getElementById('gcPitchEditorModal').classList.contains('show')) {
                    closePitchEditor();
                } else {
                    closeResetModal();
                }
            }
        });

        // ── Init: Set bar widths and update totals ──
        document.querySelectorAll('.gc-bar-fill[data-width]').forEach(bar => {
            bar.style.width = bar.dataset.width + '%';
        });
        document.querySelectorAll('.gc-pitch-card').forEach(card => {
            updateTotal(card.dataset.pitch);
        });
    })();
</script>
{% endblock %}