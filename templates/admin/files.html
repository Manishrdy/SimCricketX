{% extends "admin/layout.html" %}

{% block admin_content %}
<div class="admin-page-header">
    <div>
        <h1 class="admin-page-title">File Explorer</h1>
        <p class="admin-page-subtitle">View project files and directories</p>
    </div>
    <div class="admin-page-actions">
        <button id="refresh-btn" class="a-btn a-btn-secondary"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>
</div>

<div class="a-section">
    <!-- Breadcrumb -->
    <div class="a-card-flat"
        style="margin-bottom: 1rem; padding: 0.75rem 1rem; display: flex; align-items: center; gap: 0.5rem; background: var(--bg-secondary);">
        <button id="up-dir-btn" class="a-btn a-btn-ghost a-btn-sm" title="Go up"><i
                class="fas fa-level-up-alt"></i></button>
        <div id="breadcrumb" style="font-family: monospace; font-size: 0.9rem; color: var(--fg);">
            /
        </div>
    </div>

    <!-- File List -->
    <div class="a-table-wrap">
        <table class="a-table" id="file-table">
            <thead>
                <tr>
                    <th style="width: 40px;"></th>
                    <th>Name</th>
                    <th style="width: 120px;">Size</th>
                    <th style="width: 180px;">Modified</th>
                </tr>
            </thead>
            <tbody id="file-list-body">
                <tr>
                    <td colspan="4" class="a-empty">Loading...</td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
    let currentPath = '';

    document.addEventListener('DOMContentLoaded', () => {
        loadpath('');

        document.getElementById('refresh-btn').addEventListener('click', () => {
            loadpath(currentPath);
        });

        document.getElementById('up-dir-btn').addEventListener('click', () => {
            // Logic handled by API response parent_path, but as a fallback/quick action:
            if (currentPath) {
                // Simple string manipulation fallback if state not yet loaded
                const parts = currentPath.split('/');
                parts.pop();
                loadpath(parts.join('/'));
            }
        });
    });

    async function loadpath(path) {
        const tbody = document.getElementById('file-list-body');
        tbody.innerHTML = '<tr><td colspan="4" class="a-empty"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

        try {
            const res = await fetch(`/admin/api/files?path=${encodeURIComponent(path)}`);
            if (!res.ok) {
                const err = await res.json();
                throw new Error(err.error || 'Failed to load files');
            }
            const data = await res.json();
            renderFiles(data);
        } catch (error) {
            tbody.innerHTML = `<tr><td colspan="4" class="a-empty" style="color: var(--danger);"><i class="fas fa-exclamation-circle"></i> ${error.message}</td></tr>`;
        }
    }

    function renderFiles(data) {
        const tbody = document.getElementById('file-list-body');
        const breadcrumb = document.getElementById('breadcrumb');
        const upBtn = document.getElementById('up-dir-btn');

        currentPath = data.current_path;

        // Update Breadcrumb
        // Format: Root > Folder > Subfolder
        if (!data.current_path) {
            breadcrumb.innerHTML = '<span style="font-weight:bold;">Root</span>';
            upBtn.disabled = true;
            upBtn.style.opacity = '0.5';
        } else {
            const parts = data.current_path.split('/');
            let html = '<span class="breadcrumb-link" onclick="loadpath(\'\')" style="cursor:pointer; color:var(--accent);">Root</span>';
            let builtPath = '';
            parts.forEach((part, index) => {
                builtPath += (builtPath ? '/' : '') + part;
                if (index === parts.length - 1) {
                    html += ` <i class="fas fa-chevron-right" style="font-size:0.7em; opacity:0.5; margin:0 0.3rem;"></i> <span>${part}</span>`;
                } else {
                    html += ` <i class="fas fa-chevron-right" style="font-size:0.7em; opacity:0.5; margin:0 0.3rem;"></i> <span class="breadcrumb-link" onclick="loadpath('${builtPath}')" style="cursor:pointer; color:var(--accent);">${part}</span>`;
                }
            });
            breadcrumb.innerHTML = html;
            upBtn.disabled = false;
            upBtn.style.opacity = '1';
            upBtn.onclick = () => loadpath(data.parent_path);
        }

        // Update Table
        if (data.items.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="a-empty">This folder is empty</td></tr>';
            return;
        }

        tbody.innerHTML = data.items.map(item => {
            const iconClass = item.is_dir ? 'fa-folder' : getFileIcon(item.name);
            const iconColor = item.is_dir ? '#fbbf24' : 'var(--fg-secondary)'; // Folder yellow
            const nameStyle = item.is_dir ? 'font-weight:600; cursor:pointer; color:var(--fg);' : 'color:var(--fg);';
            const clickAction = item.is_dir ? `onclick="loadpath('${item.path}')"` : '';

            return `
                <tr ${item.is_dir ? 'style="cursor:pointer;" class="folder-row"' : ''} ${clickAction}>
                    <td style="text-align:center;"><i class="fas ${iconClass}" style="color:${iconColor}; font-size:1.1rem;"></i></td>
                    <td>
                        <div style="${nameStyle}">${item.name}</div>
                    </td>
                    <td style="font-family:monospace; font-size:0.85rem; color:var(--fg-secondary);">${formatSize(item.size)}</td>
                    <td style="font-size:0.85rem; color:var(--fg-secondary); display:flex; justify-content:space-between; align-items:center;">
                        ${item.modified}
                        ${!item.is_dir ? `<button onclick="deleteFile('${item.path}', '${item.name}', event)" class="a-btn a-btn-ghost a-btn-sm" style="color:var(--danger); padding:0.1rem 0.4rem;" title="Delete File"><i class="fas fa-trash-alt"></i></button>` : ''}
                    </td>
                </tr>
            `;
        }).join('');
    }

    async function deleteFile(path, name, event) {
        event.stopPropagation(); // Prevent row click

        if (!confirm(`Are you sure you want to delete "${name}"?\nThis action cannot be undone.`)) {
            return;
        }

        try {
            const res = await fetch(`/admin/api/files?path=${encodeURIComponent(path)}`, {
                method: 'DELETE',
                headers: {
                    'X-CSRFToken': document.querySelector('meta[name="csrf-token"]')?.content
                }
            });

            if (res.ok) {
                // Refresh current view
                loadpath(currentPath);
                // Optionally show success toast/alert
            } else {
                const data = await res.json();
                alert(`Error deleting file: ${data.error}`);
            }
        } catch (error) {
            alert(`Error deleting file: ${error.message}`);
        }
    }

    function formatSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        switch (ext) {
            case 'py': return 'fa-python';
            case 'html': return 'fa-html5';
            case 'css': return 'fa-css3-alt';
            case 'js': return 'fa-js';
            case 'json': return 'fa-code';
            case 'db': return 'fa-database';
            case 'md': return 'fa-file-alt';
            case 'txt': return 'fa-file-alt';
            case 'jpg': case 'jpeg': case 'png': case 'gif': case 'webp': return 'fa-image';
            case 'zip': case 'rar': case '7z': return 'fa-file-archive';
            default: return 'fa-file';
        }
    }
</script>

<style>
    .folder-row:hover {
        background-color: var(--accent-light) !important;
    }

    .breadcrumb-link:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}