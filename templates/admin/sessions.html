{% extends "admin/layout.html" %}
{% block admin_content %}
<div class="admin-page-header">
    <div>
        <h1 class="admin-page-title">Active Sessions</h1>
        <p class="admin-page-subtitle">{{ sessions|length }} active session{{ 's' if sessions|length != 1 }}</p>
    </div>
    <div class="admin-page-actions">
        <button onclick="cleanupSessions()" class="a-btn a-btn-secondary"><i class="fas fa-broom"></i> Cleanup Stale</button>
    </div>
</div>

<div id="alertContainer"></div>

<div class="a-table-wrap">
    <table class="a-table">
        <thead>
            <tr>
                <th>User</th>
                <th>IP Address</th>
                <th>Login Time</th>
                <th>Last Active</th>
                <th>User Agent</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for s in sessions %}
            <tr id="session-{{ s.id }}">
                <td style="font-weight: 600;">{{ s.user_id }}</td>
                <td><code style="font-size: 0.8rem;">{{ s.ip_address or 'Unknown' }}</code></td>
                <td>{{ s.login_at | localtime if s.login_at else 'N/A' }}</td>
                <td>{{ s.last_active | localtime if s.last_active else 'N/A' }}</td>
                <td style="max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; font-size: 0.78rem;">
                    {{ s.user_agent or 'Unknown' }}
                </td>
                <td>
                    <button onclick="terminateSession({{ s.id }})" class="a-btn a-btn-danger a-btn-sm">
                        <i class="fas fa-times"></i> Kill
                    </button>
                </td>
            </tr>
            {% else %}
            <tr><td colspan="6" class="a-empty"><p>No active sessions</p></td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<script>
function showAlert(msg, type) {
    const c = document.getElementById('alertContainer');
    c.innerHTML = `<div class="a-alert a-alert-${type}" style="display:block">${msg}</div>`;
    setTimeout(() => c.innerHTML = '', 4000);
}
async function terminateSession(id) {
    if (!confirm('Terminate this session? The user will be logged out.')) return;
    const res = await fetch(`/admin/sessions/${id}/terminate`, { method: 'POST' });
    const data = await res.json();
    if (res.ok) { document.getElementById('session-' + id)?.remove(); showAlert(data.message, 'success'); }
    else showAlert(data.error, 'error');
}
async function cleanupSessions() {
    const res = await fetch('/admin/sessions/cleanup', { method: 'POST' });
    const data = await res.json();
    if (res.ok) { showAlert(data.message, 'success'); setTimeout(() => location.reload(), 1500); }
    else showAlert(data.error, 'error');
}
</script>
{% endblock %}
