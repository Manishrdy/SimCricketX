{% extends "admin/layout.html" %}

{% block admin_content %}
<div class="admin-page-header">
    <div>
        <h1 class="admin-page-title">Retention Cohorts</h1>
        <p class="admin-page-subtitle">User retention and activation by signup month</p>
    </div>
</div>

<div class="a-stats-grid" style="margin-bottom:1.5rem;">
    <div class="a-stat-card">
        <div class="a-stat-icon"><i class="fas fa-users"></i></div>
        <div class="a-stat-label">Total Users</div>
        <div class="a-stat-value">{{ total_users }}</div>
    </div>
    <div class="a-stat-card">
        <div class="a-stat-icon"><i class="fas fa-signal"></i></div>
        <div class="a-stat-label">Active (30d)</div>
        <div class="a-stat-value">{{ active_users_30d }}</div>
    </div>
    <div class="a-stat-card">
        <div class="a-stat-icon"><i class="fas fa-percentage"></i></div>
        <div class="a-stat-label">30d Retention</div>
        <div class="a-stat-value">{{ (active_users_30d / total_users * 100)|round(1) if total_users else 0 }}%</div>
    </div>
    <div class="a-stat-card">
        <div class="a-stat-icon"><i class="fas fa-calendar"></i></div>
        <div class="a-stat-label">Cohorts</div>
        <div class="a-stat-value">{{ cohorts|length }}</div>
    </div>
</div>

{% if cohorts %}
<div class="a-table-wrap">
    <table class="a-table">
        <thead>
            <tr>
                <th>Cohort Month</th>
                <th>Signups</th>
                <th>Played Match</th>
                <th>Activation Rate</th>
                <th>Active 30d</th>
                <th>Retention 30d</th>
                <th>Active 7d</th>
                <th>Retention 7d</th>
            </tr>
        </thead>
        <tbody>
            {% for c in cohorts|reverse %}
            <tr>
                <td style="font-weight:600;">{{ c.month }}</td>
                <td>{{ c.signups }}</td>
                <td>{{ c.played_match }}</td>
                <td>
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        <div style="width:60px;height:6px;background:var(--bg-secondary);border-radius:3px;overflow:hidden;">
                            <div style="width:{{ c.activation_rate }}%;height:100%;background:#22c55e;border-radius:3px;"></div>
                        </div>
                        <span style="font-size:0.82rem;">{{ c.activation_rate }}%</span>
                    </div>
                </td>
                <td>{{ c.active_30d }}</td>
                <td>
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        <div style="width:60px;height:6px;background:var(--bg-secondary);border-radius:3px;overflow:hidden;">
                            <div style="width:{{ c.retention_30d }}%;height:100%;background:{% if c.retention_30d >= 50 %}#22c55e{% elif c.retention_30d >= 20 %}#f59e0b{% else %}#dc2626{% endif %};border-radius:3px;"></div>
                        </div>
                        <span style="font-size:0.82rem;">{{ c.retention_30d }}%</span>
                    </div>
                </td>
                <td>{{ c.active_7d }}</td>
                <td>
                    <div style="display:flex;align-items:center;gap:0.5rem;">
                        <div style="width:60px;height:6px;background:var(--bg-secondary);border-radius:3px;overflow:hidden;">
                            <div style="width:{{ c.retention_7d }}%;height:100%;background:{% if c.retention_7d >= 30 %}#22c55e{% elif c.retention_7d >= 10 %}#f59e0b{% else %}#dc2626{% endif %};border-radius:3px;"></div>
                        </div>
                        <span style="font-size:0.82rem;">{{ c.retention_7d }}%</span>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
<div style="font-size:0.78rem;color:var(--fg-secondary);margin-top:0.75rem;">
    <i class="fas fa-info-circle"></i>
    Retention is based on login activity recorded since the login history feature was enabled.
    Cohorts with no login records will show 0% retention even if users are active.
</div>
{% else %}
<div class="a-card-flat">
    <div class="a-empty"><i class="fas fa-chart-line"></i><p>No cohort data available yet.</p></div>
</div>
{% endif %}
{% endblock %}
