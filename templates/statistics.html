{% extends "layout.html" %}

{% block title %}Statistics Hub - SimCricketX{% endblock %}

{% block extra_css %}
<link
    href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700;800;900&display=swap"
    rel="stylesheet">

<style>
    /* ===== PREMIUM STATISTICS HUB STYLES ===== */

    /* Override font for this page */
    .stats-page {
        font-family: 'Outfit', 'Inter', sans-serif;
    }

    /* Utility Classes */
    .hidden {
        display: none !important;
    }

    /* Animated Background Gradient */
    @keyframes gradientShift {

        0%,
        100% {
            background-position: 0% 50%;
        }

        50% {
            background-position: 100% 50%;
        }
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0) rotate(0deg);
        }

        50% {
            transform: translateY(-20px) rotate(5deg);
        }
    }

    @keyframes pulse {

        0%,
        100% {
            opacity: 0.5;
            transform: scale(1);
        }

        50% {
            opacity: 0.8;
            transform: scale(1.05);
        }
    }

    @keyframes shimmer {
        0% {
            background-position: -200% center;
        }

        100% {
            background-position: 200% center;
        }
    }

    @keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(30px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    @keyframes countUp {
        from {
            opacity: 0;
            transform: scale(0.5);
        }

        to {
            opacity: 1;
            transform: scale(1);
        }
    }

    @keyframes glowPulse {

        0%,
        100% {
            box-shadow: 0 0 20px rgba(99, 102, 241, 0.2);
        }

        50% {
            box-shadow: 0 0 40px rgba(99, 102, 241, 0.4);
        }
    }

    /* Hero Section Enhanced */
    .stats-hero {
        position: relative;
        text-align: center;
        padding: 5rem 2rem 4rem;
        margin-bottom: 3rem;
        overflow: hidden;
        background: linear-gradient(135deg,
                rgba(99, 102, 241, 0.03) 0%,
                rgba(168, 85, 247, 0.03) 50%,
                rgba(236, 72, 153, 0.03) 100%);
        border-radius: 32px;
        border: 1px solid var(--card-border);
    }

    .stats-hero::before {
        content: '';
        position: absolute;
        inset: 0;
        background:
            radial-gradient(circle at 20% 80%, rgba(99, 102, 241, 0.08) 0%, transparent 40%),
            radial-gradient(circle at 80% 20%, rgba(168, 85, 247, 0.08) 0%, transparent 40%),
            radial-gradient(circle at 50% 50%, rgba(236, 72, 153, 0.05) 0%, transparent 60%);
        animation: pulse 8s ease-in-out infinite;
        z-index: 0;
    }

    /* Floating Decorative Elements */
    .float-element {
        position: absolute;
        border-radius: 50%;
        opacity: 0.1;
        z-index: 0;
        pointer-events: none;
    }

    .float-1 {
        width: 120px;
        height: 120px;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        top: 10%;
        right: 10%;
        animation: float 8s ease-in-out infinite;
    }

    .float-2 {
        width: 80px;
        height: 80px;
        background: linear-gradient(135deg, #ec4899, #f472b6);
        bottom: 20%;
        left: 8%;
        animation: float 10s ease-in-out infinite 1s;
    }

    .float-3 {
        width: 60px;
        height: 60px;
        background: linear-gradient(135deg, #10b981, #34d399);
        top: 30%;
        left: 15%;
        animation: float 7s ease-in-out infinite 0.5s;
    }

    .hero-badge {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.5rem 1.25rem;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
        border: 1px solid rgba(99, 102, 241, 0.2);
        border-radius: 100px;
        font-size: 0.8rem;
        font-weight: 600;
        color: #6366f1;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        margin-bottom: 1.5rem;
        position: relative;
        z-index: 2;
        backdrop-filter: blur(10px);
    }

    [data-theme="dark"] .hero-badge {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.2), rgba(168, 85, 247, 0.2));
        color: #818cf8;
    }

    .hero-badge i {
        font-size: 0.9rem;
    }

    .stats-hero-title {
        font-size: 2.4rem;
        font-weight: 800;
        margin-bottom: 1rem;
        background: linear-gradient(135deg, #1a1a2e 0%, #4a4a6a 50%, #1a1a2e 100%);
        background-size: 200% auto;
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        animation: shimmer 4s linear infinite;
        position: relative;
        z-index: 2;
        letter-spacing: -0.02em;
    }

    @media (max-width: 900px) {
        .stats-hero-title {
            font-size: 2rem;
        }
    }

    @media (max-width: 600px) {
        .stats-hero-title {
            font-size: 1.8rem;
        }
    }

    [data-theme="dark"] .stats-hero-title {
        background: linear-gradient(135deg, #e2e8f0 0%, #94a3b8 50%, #e2e8f0 100%);
        background-size: 200% auto;
        -webkit-background-clip: text;
        background-clip: text;
    }

    .stats-hero-subtitle {
        font-size: 1.15rem;
        color: var(--fg-secondary);
        max-width: 600px;
        margin: 0 auto;
        position: relative;
        z-index: 2;
        font-weight: 400;
        line-height: 1.7;
    }

    /* === Insights Widgets === */
    .insights-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-top: 1.5rem;
    }

    .insight-card {
        background: var(--bg-secondary);
        border: 1px solid var(--card-border);
        border-radius: 20px;
        padding: 1.5rem;
        position: relative;
        overflow: hidden;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
    }

    .insight-card::after {
        content: '';
        position: absolute;
        inset: 0;
        background: radial-gradient(circle at 10% 10%, rgba(99, 102, 241, 0.08), transparent 45%);
        opacity: 0.6;
        pointer-events: none;
    }

    .insight-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1.25rem;
        font-weight: 700;
        font-size: 1rem;
    }

    .insight-subtitle {
        font-size: 0.8rem;
        color: var(--fg-secondary);
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    .insight-list {
        display: flex;
        flex-direction: column;
        gap: 0.9rem;
        position: relative;
        z-index: 1;
    }

    .insight-item {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
    }

    .insight-player {
        display: flex;
        flex-direction: column;
    }

    .insight-player .player-name {
        font-weight: 600;
        font-size: 0.95rem;
        color: var(--fg);
    }

    .insight-player .player-team {
        font-size: 0.8rem;
        color: var(--fg-secondary);
    }

    .impact-dots {
        display: inline-flex;
        gap: 6px;
        align-items: center;
    }

    .impact-dots span {
        width: 7px;
        height: 7px;
        border-radius: 50%;
        background: rgba(99, 102, 241, 0.2);
        box-shadow: 0 0 10px rgba(99, 102, 241, 0.1);
    }

    .impact-dots span.is-hot {
        background: linear-gradient(135deg, #6366f1, #ec4899);
        box-shadow: 0 0 12px rgba(236, 72, 153, 0.35);
    }

    .form-group {
        margin-bottom: 1rem;
    }

    .form-title {
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: var(--fg-secondary);
        margin-bottom: 0.75rem;
        display: flex;
        align-items: center;
        gap: 0.4rem;
    }

    .form-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 1rem;
        margin-bottom: 0.85rem;
    }

    .sparkline {
        width: 110px;
        height: 36px;
    }

    .sparkline path {
        fill: none;
        stroke: url(#sparkGradient);
        stroke-width: 2.5;
    }

    .sparkline circle {
        fill: #ec4899;
    }

    .conditions-grid {
        display: grid;
        gap: 1rem;
        padding-bottom: 0.75rem;
        padding-right: 0.5rem;
        position: relative;
        z-index: 1;
    }

    .conditions-title {
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        color: var(--fg-secondary);
        letter-spacing: 0.08em;
        margin-bottom: 0.6rem;
    }

    .condition-row {
        display: grid;
        grid-template-columns: 1fr auto;
        align-items: center;
        gap: 0.75rem;
        padding-right: 0.25rem;
    }

    .condition-meta {
        font-size: 0.75rem;
        color: var(--fg-secondary);
    }

    .venue-ring {
        width: 42px;
        height: 42px;
        border-radius: 50%;
        background: conic-gradient(#6366f1 0deg, rgba(99, 102, 241, 0.15) 0deg);
        display: grid;
        place-items: center;
        font-size: 0.6rem;
        color: var(--fg);
        border: 1px solid rgba(99, 102, 241, 0.25);
    }

    .venue-ring span {
        font-weight: 600;
    }

    .pitch-bar {
        width: 100%;
        height: 10px;
        border-radius: 999px;
        background: rgba(148, 163, 184, 0.2);
        overflow: hidden;
        position: relative;
    }

    .pitch-bar-fill {
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, #10b981, #22d3ee);
        position: relative;
    }

    .pitch-bar-fill::after {
        content: '';
        position: absolute;
        inset: 0;
        background-image: repeating-linear-gradient(135deg,
                rgba(255, 255, 255, 0.2),
                rgba(255, 255, 255, 0.2) 6px,
                transparent 6px,
                transparent 12px);
        opacity: 0.5;
    }

    /* Dashboard Control Panel - Glassmorphism */
    .stats-controls {
        background: rgba(255, 255, 255, 0.7);
        backdrop-filter: blur(20px);
        -webkit-backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.3);
        border-radius: 24px;
        padding: 2rem;
        margin-bottom: 3rem;
        box-shadow:
            0 4px 24px rgba(0, 0, 0, 0.06),
            0 1px 2px rgba(0, 0, 0, 0.04);
        animation: slideInUp 0.6s ease-out;
    }

    [data-theme="dark"] .stats-controls {
        background: rgba(30, 30, 46, 0.8);
        border: 1px solid rgba(255, 255, 255, 0.08);
        box-shadow:
            0 4px 24px rgba(0, 0, 0, 0.3),
            0 0 0 1px rgba(255, 255, 255, 0.05) inset;
    }

    .controls-header {
        font-size: 0.85rem;
        font-weight: 600;
        margin-bottom: 1.25rem;
        color: var(--fg-secondary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
    }

    .controls-header i {
        color: #6366f1;
    }

    /* Toggle Button Group */
    .view-toggle {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
        background: var(--bg-secondary);
        padding: 0.375rem;
        border-radius: 16px;
        width: fit-content;
    }

    .view-btn {
        padding: 0.875rem 1.75rem;
        border: none;
        border-radius: 12px;
        background: transparent;
        color: var(--fg-secondary);
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 0.9rem;
        display: flex;
        align-items: center;
        gap: 0.625rem;
        position: relative;
        overflow: hidden;
    }

    .view-btn::before {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        opacity: 0;
        transition: opacity 0.3s ease;
        z-index: 0;
    }

    .view-btn span,
    .view-btn i {
        position: relative;
        z-index: 1;
    }

    .view-btn:hover:not(.active) {
        color: var(--fg);
        background: var(--card-bg);
    }

    .view-btn.active {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.4);
    }

    .view-btn.active:hover {
        transform: translateY(-1px);
        box-shadow: 0 6px 20px rgba(99, 102, 241, 0.5);
    }

    .view-btn:disabled {
        opacity: 0.4;
        cursor: not-allowed;
        pointer-events: none;
    }

    /* Format Pill Selector */
    .format-toggle {
        display: flex;
        gap: 0.375rem;
        flex-wrap: wrap;
        align-items: center;
    }

    .fmt-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.3rem;
        padding: 0.3rem 0.85rem;
        border-radius: 999px;
        border: 1.5px solid var(--card-border);
        background: var(--card-bg);
        color: var(--fg-secondary);
        font-size: 0.78rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.18s ease;
        white-space: nowrap;
    }

    .fmt-btn:hover {
        transform: translateY(-1px);
        color: var(--fg);
    }

    .fmt-btn.active {
        color: #fff;
        border-color: transparent;
    }

    .fmt-btn.format-all {
        border-color: rgba(99, 102, 241, 0.35);
        color: #4f46e5;
        background: rgba(99, 102, 241, 0.12);
    }

    .fmt-btn.format-all:hover {
        border-color: rgba(99, 102, 241, 0.55);
        background: rgba(99, 102, 241, 0.2);
    }

    .fmt-btn.format-all.active {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        box-shadow: 0 2px 10px rgba(99, 102, 241, 0.45);
    }

    .fmt-btn.format-t20 {
        border-color: rgba(2, 132, 199, 0.38);
        color: #0369a1;
        background: rgba(14, 165, 233, 0.14);
    }

    .fmt-btn.format-t20:hover {
        border-color: rgba(2, 132, 199, 0.6);
        background: rgba(14, 165, 233, 0.24);
    }

    .fmt-btn.format-t20.active {
        background: linear-gradient(135deg, #0284c7, #0ea5e9);
        box-shadow: 0 2px 10px rgba(2, 132, 199, 0.45);
    }

    .fmt-btn.format-lista {
        border-color: rgba(202, 138, 4, 0.4);
        color: #a16207;
        background: rgba(234, 179, 8, 0.16);
    }

    .fmt-btn.format-lista:hover {
        border-color: rgba(202, 138, 4, 0.62);
        background: rgba(234, 179, 8, 0.24);
    }

    .fmt-btn.format-lista.active {
        background: linear-gradient(135deg, #ca8a04, #f59e0b);
        box-shadow: 0 2px 10px rgba(202, 138, 4, 0.45);
    }

    .fmt-btn.format-fc {
        border-color: rgba(124, 58, 237, 0.38);
        color: #6d28d9;
        background: rgba(167, 139, 250, 0.16);
    }

    .fmt-btn.format-fc:hover {
        border-color: rgba(124, 58, 237, 0.58);
        background: rgba(167, 139, 250, 0.26);
    }

    .fmt-btn.format-fc.active {
        background: linear-gradient(135deg, #7c3aed, #a855f7);
        box-shadow: 0 2px 10px rgba(124, 58, 237, 0.45);
    }

    [data-theme="dark"] .fmt-btn.format-all {
        color: #a5b4fc;
        background: rgba(99, 102, 241, 0.22);
    }

    [data-theme="dark"] .fmt-btn.format-t20 {
        color: #7dd3fc;
        background: rgba(14, 165, 233, 0.24);
    }

    [data-theme="dark"] .fmt-btn.format-lista {
        color: #facc15;
        background: rgba(234, 179, 8, 0.26);
    }

    [data-theme="dark"] .fmt-btn.format-fc {
        color: #c4b5fd;
        background: rgba(124, 58, 237, 0.26);
    }

    /* Tournament Selector */
    .tournament-selector-wrapper {
        display: flex;
        flex-direction: column;
        gap: 0.625rem;
        animation: slideInUp 0.4s ease-out;
    }

    .tournament-selector-wrapper label {
        font-size: 0.85rem;
        font-weight: 500;
        color: var(--fg-secondary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .tournament-select {
        padding: 1rem 1.5rem;
        padding-right: 3rem;
        border: 2px solid var(--card-border);
        border-radius: 14px;
        background: var(--card-bg);
        color: var(--fg);
        font-size: 0.95rem;
        font-family: inherit;
        font-weight: 500;
        transition: all 0.3s ease;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='24' height='24' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 1rem center;
        background-size: 1.25rem;
        max-width: 400px;
    }

    .tournament-select:hover {
        border-color: #6366f1;
    }

    .tournament-select:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.15);
    }

    /* ===== LEADERBOARD SECTION ===== */
    .leaderboard-section {
        margin-bottom: 4rem;
        animation: slideInUp 0.6s ease-out 0.1s backwards;
    }

    .section-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        flex-wrap: wrap;
        gap: 1rem;
    }

    .section-title {
        font-size: 1.5rem;
        font-weight: 700;
        color: var(--fg);
        display: flex;
        align-items: center;
        gap: 0.75rem;
        margin: 0;
    }

    .section-title i {
        color: #f59e0b;
        font-size: 1.3rem;
    }

    .section-subtitle {
        font-size: 0.9rem;
        color: var(--fg-secondary);
    }

    /* Leaderboard Grid */
    .leaderboard-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
        gap: 1.5rem;
    }

    /* Premium Leaderboard Cards */
    .leaderboard-card {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 20px;
        padding: 0;
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
        transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .leaderboard-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 100%;
        background: linear-gradient(180deg, transparent 0%, rgba(99, 102, 241, 0.02) 100%);
        opacity: 0;
        transition: opacity 0.4s ease;
        pointer-events: none;
    }

    .leaderboard-card:hover {
        transform: translateY(-6px);
        box-shadow:
            0 20px 40px rgba(0, 0, 0, 0.08),
            0 0 0 1px rgba(99, 102, 241, 0.1);
        border-color: rgba(99, 102, 241, 0.3);
    }

    [data-theme="dark"] .leaderboard-card:hover {
        box-shadow:
            0 20px 40px rgba(0, 0, 0, 0.4),
            0 0 40px rgba(99, 102, 241, 0.1);
    }

    .leaderboard-card:hover::before {
        opacity: 1;
    }

    .leaderboard-header {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 1.5rem 1.75rem;
        background: linear-gradient(135deg, var(--bg-secondary) 0%, var(--card-bg) 100%);
        border-bottom: 1px solid var(--card-border);
    }

    .leaderboard-icon-wrapper {
        width: 48px;
        height: 48px;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.25rem;
        transition: all 0.3s ease;
    }

    .leaderboard-card:nth-child(1) .leaderboard-icon-wrapper {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        color: #d97706;
    }

    .leaderboard-card:nth-child(2) .leaderboard-icon-wrapper {
        background: linear-gradient(135deg, #ede9fe, #ddd6fe);
        color: #7c3aed;
    }

    .leaderboard-card:nth-child(3) .leaderboard-icon-wrapper {
        background: linear-gradient(135deg, #fee2e2, #fecaca);
        color: #dc2626;
    }

    .leaderboard-card:nth-child(4) .leaderboard-icon-wrapper {
        background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        color: #059669;
    }

    [data-theme="dark"] .leaderboard-card:nth-child(1) .leaderboard-icon-wrapper {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.2));
    }

    [data-theme="dark"] .leaderboard-card:nth-child(2) .leaderboard-icon-wrapper {
        background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(124, 58, 237, 0.2));
    }

    [data-theme="dark"] .leaderboard-card:nth-child(3) .leaderboard-icon-wrapper {
        background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
    }

    [data-theme="dark"] .leaderboard-card:nth-child(4) .leaderboard-icon-wrapper {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(5, 150, 105, 0.2));
    }

    .leaderboard-card:hover .leaderboard-icon-wrapper {
        transform: scale(1.1) rotate(5deg);
    }

    .leaderboard-title {
        font-size: 1rem;
        font-weight: 700;
        margin: 0;
        color: var(--fg);
    }

    /* Leaderboard List */
    .leaderboard-list {
        list-style: none;
        padding: 0.75rem;
        margin: 0;
        display: flex;
        flex-direction: column;
        gap: 0.375rem;
    }

    .leaderboard-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.875rem 1rem;
        background: var(--bg-secondary);
        border-radius: 12px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        overflow: hidden;
    }

    .leaderboard-item::before {
        content: '';
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        width: 3px;
        background: linear-gradient(180deg, #6366f1, #8b5cf6);
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .leaderboard-item:hover {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.08), rgba(139, 92, 246, 0.05));
        transform: translateX(4px);
    }

    .leaderboard-item:hover::before {
        opacity: 1;
    }


    /* Rank Badges */
    .leaderboard-item:first-child .rank-badge {
        background: linear-gradient(135deg, #fbbf24, #f59e0b);
        color: white;
        box-shadow: 0 2px 8px rgba(251, 191, 36, 0.4);
    }

    .leaderboard-item:nth-child(2) .rank-badge {
        background: linear-gradient(135deg, #9ca3af, #6b7280);
        color: white;
        box-shadow: 0 2px 8px rgba(156, 163, 175, 0.4);
    }

    .leaderboard-item:nth-child(3) .rank-badge {
        background: linear-gradient(135deg, #d97706, #b45309);
        color: white;
        box-shadow: 0 2px 8px rgba(217, 119, 6, 0.4);
    }

    .rank-badge {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.75rem;
        font-weight: 700;
        background: var(--card-border);
        color: var(--fg-secondary);
        flex-shrink: 0;
    }

    .player-info {
        display: flex;
        align-items: center;
        gap: 0.875rem;
        flex: 1;
        min-width: 0;
    }

    .player-details {
        display: flex;
        flex-direction: column;
        min-width: 0;
    }

    .player-name {
        font-weight: 600;
        font-size: 0.9rem;
        color: var(--fg);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .player-team {
        font-size: 0.75rem;
        color: var(--fg-secondary);
        margin-top: 0.125rem;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .stat-value {
        font-weight: 700;
        font-family: 'JetBrains Mono', monospace;
        font-size: 1.1rem;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
        padding-left: 1rem;
        flex-shrink: 0;
    }

    .compare-table td {
        vertical-align: middle;
    }

    .compare-cell {
        display: flex;
        flex-direction: column;
        gap: 0.35rem;
    }

    .compare-value {
        font-weight: 600;
    }

    .compare-bar {
        position: relative;
        height: 6px;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.12);
        overflow: hidden;
    }

    .compare-bar-fill {
        position: absolute;
        left: 0;
        top: 0;
        height: 100%;
        border-radius: 999px;
        background: linear-gradient(90deg, #6366f1, #8b5cf6);
    }

    .compare-bar-fill.is-secondary {
        background: linear-gradient(90deg, #f59e0b, #f97316);
    }

    /* ===== DETAILED STATS SECTION ===== */
    .detailed-stats {
        background: var(--card-bg);
        border: 1px solid var(--card-border);
        border-radius: 24px;
        padding: 2rem;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.04);
        animation: slideInUp 0.6s ease-out 0.2s backwards;
    }

    [data-theme="dark"] .detailed-stats {
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.2);
    }

    /* Premium Tab Design */
    .stats-tabs-wrapper {
        margin-bottom: 2rem;
    }

    .stats-tabs {
        display: flex;
        gap: 0.375rem;
        background: var(--bg-secondary);
        padding: 0.375rem;
        border-radius: 16px;
        overflow-x: auto;
        scrollbar-width: none;
        -ms-overflow-style: none;
        width: fit-content;
    }

    .stats-tabs::-webkit-scrollbar {
        display: none;
    }

    .tab-btn {
        padding: 0.875rem 1.75rem;
        cursor: pointer;
        background: transparent;
        border: none;
        font-size: 0.925rem;
        font-weight: 600;
        color: var(--fg-secondary);
        border-radius: 12px;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        position: relative;
    }

    .tab-btn i {
        font-size: 0.9rem;
        transition: transform 0.3s ease;
    }

    .tab-btn:hover:not(.active) {
        color: var(--fg);
        background: var(--card-bg);
    }

    .tab-btn.active {
        background: white;
        color: #6366f1;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    [data-theme="dark"] .tab-btn.active {
        background: var(--card-bg);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }

    .tab-btn.active i {
        transform: scale(1.15);
    }

    .tab-panel {
        display: none;
        animation: slideInUp 0.4s ease-out;
    }

    .tab-panel.active {
        display: block;
    }

    /* Export Controls */
    .export-controls {
        display: flex;
        gap: 0.75rem;
        margin-bottom: 1.5rem;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .export-btns {
        display: flex;
        gap: 0.625rem;
        flex-wrap: wrap;
    }

    .team-filter-inline {
        display: flex;
        align-items: center;
        gap: 0.625rem;
    }

    .team-filter-label {
        font-size: 0.8rem;
        font-weight: 600;
        color: var(--fg-secondary);
        white-space: nowrap;
        display: flex;
        align-items: center;
        gap: 0.35rem;
    }

    .team-filter-label i {
        color: #6366f1;
        font-size: 0.75rem;
    }

    .team-filter-select {
        padding: 0.65rem 2.25rem 0.65rem 0.875rem;
        border: 1px solid var(--card-border);
        border-radius: 12px;
        background: var(--bg-secondary);
        color: var(--fg);
        font-size: 0.875rem;
        font-family: 'Outfit', sans-serif;
        font-weight: 500;
        cursor: pointer;
        appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='%236366f1' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 0.625rem center;
        background-color: var(--bg-secondary);
        outline: none;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .team-filter-select:hover {
        border-color: #6366f1;
    }

    .team-filter-select:focus {
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.12);
    }

    .btn-export {
        padding: 0.75rem 1.375rem;
        background: var(--bg-secondary);
        color: var(--fg);
        border: 1px solid var(--card-border);
        border-radius: 12px;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 0.5rem;
        font-size: 0.875rem;
    }

    .btn-export:hover {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border-color: transparent;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.35);
    }

    .btn-export i {
        font-size: 0.9rem;
    }

    /* Premium Table Styling */
    .table-wrapper {
        overflow-x: auto;
        border-radius: 16px;
        border: 1px solid var(--card-border);
        background: var(--bg-secondary);
    }

    .table-wrapper::-webkit-scrollbar {
        height: 8px;
    }

    .table-wrapper::-webkit-scrollbar-thumb {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        border-radius: 4px;
    }

    .table-wrapper::-webkit-scrollbar-track {
        background: var(--bg-secondary);
        border-radius: 4px;
    }

    .stats-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        font-size: 0.875rem;
    }

    .stats-table thead {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .stats-table th {
        background: linear-gradient(180deg, var(--card-bg) 0%, var(--bg-secondary) 100%);
        padding: 1rem 0.875rem;
        font-weight: 700;
        text-align: left;
        white-space: nowrap;
        color: var(--fg);
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 2px solid var(--card-border);
    }

    .stats-table th:first-child {
        border-top-left-radius: 16px;
        padding-left: 1.25rem;
    }

    .stats-table th:last-child {
        border-top-right-radius: 16px;
        padding-right: 1.25rem;
    }

    .stats-table td {
        padding: 1rem 0.875rem;
        border-bottom: 1px solid var(--card-border);
        font-family: 'JetBrains Mono', monospace;
        font-size: 0.85rem;
        color: var(--fg);
        background: var(--card-bg);
        transition: all 0.2s ease;
    }

    .stats-table td:first-child {
        padding-left: 1.25rem;
    }

    .stats-table td:last-child {
        padding-right: 1.25rem;
    }

    .stats-table tbody tr {
        transition: all 0.2s ease;
    }

    .stats-table tbody tr:hover td {
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.05), rgba(139, 92, 246, 0.03));
    }

    .stats-table tbody tr:last-child td {
        border-bottom: none;
    }

    .stats-table tbody tr:last-child td:first-child {
        border-bottom-left-radius: 16px;
    }

    .stats-table tbody tr:last-child td:last-child {
        border-bottom-right-radius: 16px;
    }

    /* Player Name Column */
    .stats-table td:first-child,
    .stats-table td:nth-child(2) {
        font-family: 'Outfit', sans-serif;
        font-weight: 600;
    }

    /* Highlight Key Stats */
    .stats-table td:nth-child(5) {
        color: #6366f1;
        font-weight: 600;
    }

    /* Empty State */
    .empty-state {
        text-align: center;
        padding: 6rem 2rem;
        animation: slideInUp 0.6s ease-out;
    }

    .empty-icon-wrapper {
        width: 120px;
        height: 120px;
        margin: 0 auto 2rem;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.1), rgba(168, 85, 247, 0.1));
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        animation: pulse 4s ease-in-out infinite;
    }

    .empty-icon {
        font-size: 3.5rem;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        -webkit-background-clip: text;
        background-clip: text;
        color: transparent;
    }

    .empty-title {
        font-size: 1.75rem;
        font-weight: 700;
        margin-bottom: 0.75rem;
        color: var(--fg);
    }

    .empty-subtitle {
        color: var(--fg-secondary);
        margin-bottom: 2.5rem;
        font-size: 1.05rem;
        max-width: 400px;
        margin-left: auto;
        margin-right: auto;
        line-height: 1.6;
    }

    .btn-primary {
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 14px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 16px rgba(99, 102, 241, 0.3);
        display: inline-flex;
        align-items: center;
        gap: 0.625rem;
    }

    .btn-primary:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 24px rgba(99, 102, 241, 0.45);
    }

    .btn-primary i {
        font-size: 1rem;
    }

    /* No Data Message */
    .no-data-message {
        text-align: center;
        padding: 4rem 2rem;
        color: var(--fg-secondary);
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 0.75rem;
    }

    .no-data-message i {
        font-size: 2.5rem;
        opacity: 0.4;
        margin-bottom: 0.5rem;
    }

    /* Responsive */
    @media (max-width: 768px) {
        .stats-hero {
            padding: 3rem 1.5rem;
            border-radius: 20px;
            margin-bottom: 2rem;
        }

        .stats-hero-title {
            font-size: 2.25rem;
        }

        .stats-hero-subtitle {
            font-size: 1rem;
        }

        .float-element {
            display: none;
        }

        .stats-controls {
            padding: 1.5rem;
            border-radius: 20px;
        }

        .view-toggle {
            flex-direction: column;
            width: 100%;
        }

        .view-btn {
            justify-content: center;
            width: 100%;
        }

        .leaderboard-grid {
            grid-template-columns: 1fr;
        }

        .detailed-stats {
            padding: 1.5rem;
            border-radius: 20px;
        }

        .stats-tabs {
            width: 100%;
        }

        .tab-btn {
            flex: 1;
            justify-content: center;
            padding: 0.75rem 1rem;
        }

        .stats-table {
            font-size: 0.75rem;
        }

        .stats-table th,
        .stats-table td {
            padding: 0.625rem 0.5rem;
        }

        .export-controls {
            flex-direction: column;
        }

        .btn-export {
            width: 100%;
            justify-content: center;
        }

        .section-title {
            font-size: 1.25rem;
        }
    }

    /* Animation delay utilities */
    .delay-1 {
        animation-delay: 0.1s;
    }

    .delay-2 {
        animation-delay: 0.2s;
    }

    .delay-3 {
        animation-delay: 0.3s;
    }

    .delay-4 {
        animation-delay: 0.4s;
    }

    /* ===== REDESIGNED CONDITIONS LENS ===== */
    .conditions-lens-body {
        display: flex;
        flex-direction: column;
        gap: 1.25rem;
        position: relative;
        z-index: 1;
    }

    .conditions-section-title {
        font-size: 0.72rem;
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 0.1em;
        color: var(--fg-secondary);
        margin-bottom: 0.625rem;
        display: flex;
        align-items: center;
        gap: 0.375rem;
        padding-bottom: 0.5rem;
        border-bottom: 1px solid var(--card-border);
    }

    .venue-item {
        display: flex;
        align-items: center;
        gap: 0.625rem;
        padding: 0.45rem 0;
        border-bottom: 1px solid rgba(148, 163, 184, 0.08);
    }

    .venue-item:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }

    .venue-icon {
        width: 28px;
        height: 28px;
        border-radius: 7px;
        background: linear-gradient(135deg, rgba(99, 102, 241, 0.12), rgba(139, 92, 246, 0.08));
        display: flex;
        align-items: center;
        justify-content: center;
        color: #6366f1;
        font-size: 0.75rem;
        flex-shrink: 0;
    }

    .venue-info {
        flex: 1;
        min-width: 0;
    }

    .venue-name {
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--fg);
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .venue-meta {
        font-size: 0.68rem;
        color: var(--fg-secondary);
        margin-top: 0.1rem;
    }

    .venue-runs-badge {
        padding: 0.2rem 0.55rem;
        background: linear-gradient(135deg, #6366f1, #8b5cf6);
        color: white;
        border-radius: 100px;
        font-size: 0.72rem;
        font-weight: 700;
        white-space: nowrap;
        flex-shrink: 0;
        font-family: 'JetBrains Mono', monospace;
    }

    .pitch-item {
        margin-bottom: 0.6rem;
    }

    .pitch-item:last-child {
        margin-bottom: 0;
    }

    .pitch-header-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.3rem;
    }

    .pitch-label {
        font-size: 0.82rem;
        font-weight: 600;
        color: var(--fg);
    }

    .pitch-runs-label {
        font-size: 0.72rem;
        color: var(--fg-secondary);
        font-family: 'JetBrains Mono', monospace;
    }

    /* Filter summary bar */
    .filter-summary {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 1rem;
        padding: 0.6rem 1rem;
        background: var(--bg-secondary);
        border-radius: 10px;
        border: 1px solid var(--card-border);
        font-size: 0.83rem;
        color: var(--fg-secondary);
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .filter-summary-count {
        font-weight: 500;
        color: var(--fg-secondary);
    }

    .filter-summary-count strong {
        color: #6366f1;
        font-weight: 700;
    }

    .btn-clear-filters {
        padding: 0.3rem 0.75rem;
        background: rgba(239, 68, 68, 0.08);
        color: #ef4444;
        border: 1px solid rgba(239, 68, 68, 0.2);
        border-radius: 7px;
        cursor: pointer;
        font-size: 0.75rem;
        font-weight: 600;
        transition: all 0.2s ease;
        display: none;
        align-items: center;
        gap: 0.35rem;
        font-family: 'Outfit', sans-serif;
    }

    .btn-clear-filters:hover {
        background: rgba(239, 68, 68, 0.15);
    }

    /* Sortable headers */
    .sortable {
        cursor: pointer;
        user-select: none;
        white-space: nowrap;
    }

    .sortable:hover {
        color: #6366f1 !important;
    }

    .sortable .sort-icon {
        opacity: 0.3;
        font-size: 0.65rem;
        margin-left: 0.25rem;
        transition: opacity 0.2s ease;
    }

    .sortable:hover .sort-icon,
    .sortable.sort-asc .sort-icon,
    .sortable.sort-desc .sort-icon {
        opacity: 1;
        color: #6366f1;
    }

    /* Tab count badges */
    .tab-count {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: rgba(99, 102, 241, 0.1);
        color: #6366f1;
        font-size: 0.68rem;
        font-weight: 700;
        border-radius: 100px;
        padding: 0.1rem 0.45rem;
        min-width: 20px;
        transition: all 0.3s ease;
    }

    .tab-btn.active .tab-count {
        background: rgba(255, 255, 255, 0.2);
        color: white;
    }

    /* Redesigned detailed stats section */
    .detailed-stats-inner-header {
        display: flex;
        align-items: center;
        gap: 1.5rem;
        margin-bottom: 1.5rem;
        flex-wrap: wrap;
    }

    .stats-tabs-wrapper {
        flex: 1;
    }
</style>
{% endblock %}

{% block content %}
<div class="stats-page">

    <!-- Hero Section -->
    <div class="stats-hero">
        <div class="float-element float-1"></div>
        <div class="float-element float-2"></div>
        <div class="float-element float-3"></div>

        <div class="hero-badge">
            <i class="fas fa-chart-line"></i>
            <span>Real-Time Analytics</span>
        </div>
        <h1 class="stats-hero-title">Statistics Hub</h1>
        <p class="stats-hero-subtitle">Track performance, analyze trends, and discover your top performers with
            comprehensive cricket statistics</p>
    </div>

    <!-- Stats Controls -->
    <div class="stats-controls">
        <div class="controls-header">
            <i class="fas fa-sliders-h"></i>
            <span>Dashboard View</span>
        </div>

        <div class="view-toggle">
            <button class="view-btn {% if view_type == 'overall' or not view_type %}active{% endif %}"
                onclick="switchView('overall')">
                <i class="fas fa-globe"></i>
                <span>Overall Statistics</span>
            </button>
            <button class="view-btn {% if view_type == 'tournament' %}active{% endif %}"
                onclick="switchView('tournament')"
                {% if not tournaments %}disabled title="Create a tournament first to use this view"{% endif %}>
                <i class="fas fa-trophy"></i>
                <span>Tournament Stats</span>
            </button>
        </div>

        <!-- Format Selector -->
        <div class="format-toggle">
            <button class="fmt-btn format-all {% if not match_format %}active{% endif %}"
                onclick="selectFormat('')">
                <i class="fas fa-layer-group"></i><span>All</span>
            </button>
            <button class="fmt-btn format-t20 {% if match_format == 'T20' %}active{% endif %}"
                onclick="selectFormat('T20')">
                <span>T20</span>
            </button>
            <button class="fmt-btn format-lista {% if match_format == 'ListA' %}active{% endif %}"
                onclick="selectFormat('ListA')">
                <span>List A</span>
            </button>
            <button class="fmt-btn format-fc {% if match_format == 'FirstClass' %}active{% endif %}"
                onclick="selectFormat('FirstClass')">
                <span>FC</span>
            </button>
        </div>

        {% if view_type == 'tournament' or tournaments %}
        <div class="tournament-selector-wrapper{% if view_type != 'tournament' %} hidden{% endif %}"
            id="tournament-selector">
            <label for="tournament-select">
                <i class="fas fa-filter"></i> Select Tournament
            </label>
            <select id="tournament-select" class="tournament-select" onchange="selectTournament(this.value)">
                <option value="">Choose a tournament...</option>
                {% for t in tournaments %}
                <option value="{{ t.id }}" {% if tournament_id==t.id %}selected{% endif %}>
                    {{ t.name }}
                </option>
                {% endfor %}
            </select>
        </div>
        {% endif %}
    </div>

    {% if not has_stats %}
    <!-- Empty State -->
    <div class="empty-state">
        <div class="empty-icon-wrapper">
            <i class="fas fa-chart-line empty-icon"></i>
        </div>
        <h2 class="empty-title">No Statistics Available</h2>
        <p class="empty-subtitle">
            {% if view_type == 'tournament' and not tournament_id %}
            Please select a tournament to view statistics.
            {% elif view_type == 'tournament' %}
            This tournament doesn't have any match data yet. Simulate some matches to see statistics!
            {% else %}
            Start by simulating matches or creating tournaments to generate statistics.
            {% endif %}
        </p>
        <a href="{{ url_for('home') }}" class="btn-primary">
            <i class="fas fa-home"></i>
            <span>Go to Dashboard</span>
        </a>
    </div>

    {% else %}

    <!-- Leaderboards -->
    {% if leaderboards and (leaderboards.most_runs or leaderboards.most_wickets or leaderboards.best_bowling_figures or
    leaderboards.highest_sr or
    leaderboards.best_average) %}
    <section class="leaderboard-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-crown"></i>
                Top Performers
            </h2>
            <span class="section-subtitle">Leading players across all categories</span>
        </div>

        <div class="leaderboard-grid">
            {% if leaderboards.most_runs %}
            <div class="leaderboard-card">
                <div class="leaderboard-header">
                    <div class="leaderboard-icon-wrapper">
                        <i class="fa-solid fa-trophy"></i>
                    </div>
                    <h3 class="leaderboard-title">Top Run Scorers</h3>
                </div>
                <ul class="leaderboard-list">
                    {% for p in leaderboards.most_runs %}
                    <li class="leaderboard-item">
                        <div class="player-info">
                            <span class="rank-badge">{{ loop.index }}</span>
                            <div class="player-details">
                                <span class="player-name">{{ p.player }}</span>
                                <span class="player-team">{{ p.team }}</span>
                            </div>
                        </div>
                        <span class="stat-value">{{ p.runs }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if leaderboards.most_wickets %}
            <div class="leaderboard-card">
                <div class="leaderboard-header">
                    <div class="leaderboard-icon-wrapper">
                        <i class="fa-solid fa-medal"></i>
                    </div>
                    <h3 class="leaderboard-title">Top Wicket Takers</h3>
                </div>
                <ul class="leaderboard-list">
                    {% for p in leaderboards.most_wickets %}
                    <li class="leaderboard-item">
                        <div class="player-info">
                            <span class="rank-badge">{{ loop.index }}</span>
                            <div class="player-details">
                                <span class="player-name">{{ p.player }}</span>
                                <span class="player-team">{{ p.team }}</span>
                            </div>
                        </div>
                        <span class="stat-value">{{ p.wickets }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if leaderboards.best_bowling_figures %}
            <div class="leaderboard-card">
                <div class="leaderboard-header">
                    <div class="leaderboard-icon-wrapper">
                        <i class="fa-solid fa-fire"></i>
                    </div>
                    <h3 class="leaderboard-title">Best Bowling Figures</h3>
                </div>
                <ul class="leaderboard-list">
                    {% for fig in leaderboards.best_bowling_figures %}
                    <li class="leaderboard-item">
                        <div class="player-info">
                            <span class="rank-badge">{{ loop.index }}</span>
                            <div class="player-details">
                                <span class="player-name">{{ fig.player }}</span>
                                <span class="player-team">{{ fig.team }} · vs {{ fig.opponent }} · {{ fig.match_date
                                    }}</span>
                            </div>
                        </div>
                        <span class="stat-value">{{ fig.figures }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if leaderboards.highest_sr %}
            <div class="leaderboard-card">
                <div class="leaderboard-header">
                    <div class="leaderboard-icon-wrapper">
                        <i class="fa-solid fa-bolt"></i>
                    </div>
                    <h3 class="leaderboard-title">Highest Strike Rates</h3>
                    <span class="leaderboard-subtitle"
                        style="font-size: 0.75rem; color: var(--fg-secondary); margin-top: 0.25rem;">Min 50 balls
                        faced</span>
                </div>
                <ul class="leaderboard-list">
                    {% for p in leaderboards.highest_sr %}
                    <li class="leaderboard-item">
                        <div class="player-info">
                            <span class="rank-badge">{{ loop.index }}</span>
                            <div class="player-details">
                                <span class="player-name">{{ p.player }}</span>
                                <span class="player-team">{{ p.team }}</span>
                            </div>
                        </div>
                        <span class="stat-value">{{ p.sr }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            {% if leaderboards.best_average %}
            <div class="leaderboard-card">
                <div class="leaderboard-header">
                    <div class="leaderboard-icon-wrapper">
                        <i class="fa-solid fa-star"></i>
                    </div>
                    <h3 class="leaderboard-title">Best Averages</h3>
                </div>
                <ul class="leaderboard-list">
                    {% for p in leaderboards.best_average %}
                    <li class="leaderboard-item">
                        <div class="player-info">
                            <span class="rank-badge">{{ loop.index }}</span>
                            <div class="player-details">
                                <span class="player-name">{{ p.player }}</span>
                                <span class="player-team">{{ p.team }}</span>
                            </div>
                        </div>
                        <span class="stat-value">{{ p.average }}</span>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}
        </div>
    </section>
    {% endif %}

    {% if insights and (insights.impact or insights.form.batting or insights.form.bowling or insights.conditions.venues
    or insights.conditions.pitches) %}
    <section class="leaderboard-section" id="insights-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-chart-line"></i>
                Advanced Insights
            </h2>
            <span class="section-subtitle">Form pulse, impact index, and conditions lens</span>
        </div>

        <div class="insights-grid">
            <div class="insight-card">
                <div class="insight-header">
                    <span>Impact Index</span>
                    <span class="insight-subtitle">Runs + Wkts + Fielding</span>
                </div>
                {% if insights.impact %}
                <div class="insight-list">
                    {% for p in insights.impact %}
                    <div class="insight-item">
                        <div class="insight-player">
                            <span class="player-name">{{ p.player }}</span>
                            <span class="player-team">{{ p.team }}</span>
                        </div>
                        <div class="impact-dots" data-impact="{{ p.impact }}"></div>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="no-data-message"><i class="fas fa-chart-pie"></i>
                    <p>No impact data yet</p>
                </div>
                {% endif %}
            </div>

            <div class="insight-card">
                <div class="insight-header">
                    <span>Form Pulse</span>
                    <span class="insight-subtitle">Last 5 innings</span>
                </div>
                {% if insights.form.batting or insights.form.bowling %}
                <div class="form-group">
                    <div class="form-title"><i class="fas fa-cricket-bat"></i> Batting Form</div>
                    {% if insights.form.batting %}
                    {% for p in insights.form.batting %}
                    <div class="form-row">
                        <div class="insight-player">
                            <span class="player-name">{{ p.player }}</span>
                            <span class="player-team">{{ p.team }}</span>
                        </div>
                        <svg class="sparkline" data-series="{{ p.series|join(',') }}" viewBox="0 0 110 36"
                            preserveAspectRatio="none"></svg>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="no-data-message">
                        <p>No batting form yet</p>
                    </div>
                    {% endif %}
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <div class="form-title"><i class="fas fa-bowling-ball"></i> Bowling Form</div>
                    {% if insights.form.bowling %}
                    {% for p in insights.form.bowling %}
                    <div class="form-row">
                        <div class="insight-player">
                            <span class="player-name">{{ p.player }}</span>
                            <span class="player-team">{{ p.team }}</span>
                        </div>
                        <svg class="sparkline" data-series="{{ p.series|join(',') }}" viewBox="0 0 110 36"
                            preserveAspectRatio="none"></svg>
                    </div>
                    {% endfor %}
                    {% else %}
                    <div class="no-data-message">
                        <p>No bowling form yet</p>
                    </div>
                    {% endif %}
                </div>
                {% else %}
                <div class="no-data-message"><i class="fas fa-chart-line"></i>
                    <p>No form data yet</p>
                </div>
                {% endif %}
            </div>

            <div class="insight-card">
                <div class="insight-header">
                    <span>Conditions Lens</span>
                    <span class="insight-subtitle">Venue &amp; pitch snapshots</span>
                </div>
                <div class="conditions-lens-body">
                    <!-- Venues -->
                    <div>
                        <div class="conditions-section-title">
                            <i class="fas fa-map-marker-alt"></i>
                            Venues (Avg Runs)
                        </div>
                        {% if insights.conditions.venues %}
                        {% for v in insights.conditions.venues %}
                        <div class="venue-item">
                            <div class="venue-icon"><i class="fas fa-landmark"></i></div>
                            <div class="venue-info">
                                <div class="venue-name" title="{{ v.label }}">{{ v.label }}</div>
                                <div class="venue-meta">{{ v.matches }} match{{ 'es' if v.matches != 1 else '' }}</div>
                            </div>
                            <div class="venue-runs-badge">{{ v.avg_runs }}</div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="no-data-message"><p>No venue data yet</p></div>
                        {% endif %}
                    </div>
                    <!-- Pitches -->
                    <div>
                        <div class="conditions-section-title">
                            <i class="fas fa-layer-group"></i>
                            Pitches (Avg Runs)
                        </div>
                        {% if insights.conditions.pitches %}
                        {% for p in insights.conditions.pitches %}
                        <div class="pitch-item">
                            <div class="pitch-header-row">
                                <span class="pitch-label">{{ p.label }}</span>
                                <span class="pitch-runs-label">{{ p.avg_runs }} runs</span>
                            </div>
                            <div class="pitch-bar">
                                <div class="pitch-bar-fill" data-value="{{ p.avg_runs }}"></div>
                            </div>
                        </div>
                        {% endfor %}
                        {% else %}
                        <div class="no-data-message"><p>No pitch data yet</p></div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- Best Partnerships Section -->
    <section class="leaderboard-section" id="partnerships-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-user-friends"></i>
                Best Partnerships
            </h2>
        </div>
        <div id="partnerships-container" class="loading">
            <div style="text-align: center; padding: 3rem;">
                <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--accent);"></i>
                <p style="margin-top: 1rem; color: var(--fg-secondary);">Loading partnerships...</p>
            </div>
        </div>
    </section>

    <!-- Player Comparison Tool Section -->
    <section class="leaderboard-section" id="player-comparison-section">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-balance-scale"></i>
                Player Comparison Tool
            </h2>
        </div>

        <div class="detailed-stats" style="margin-bottom: 0;">
            <!-- Role Filter -->
            <div style="margin-bottom: 2rem;">
                <label
                    style="font-size: 0.9rem; font-weight: 600; color: var(--fg); margin-bottom: 0.75rem; display: block;">
                    <i class="fas fa-filter"></i> Compare By Role
                </label>
                <div class="view-toggle">
                    <button class="view-btn active" onclick="selectComparisonRole('batsman')">
                        <i class="fas fa-cricket-bat"></i>
                        <span>Batsmen</span>
                    </button>
                    <button class="view-btn" onclick="selectComparisonRole('bowler')">
                        <i class="fas fa-bowling-ball"></i>
                        <span>Bowlers</span>
                    </button>
                </div>
            </div>

            <!-- Player Selection -->
            <div
                style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-bottom: 2rem;">
                <div>
                    <label for="player1-select"
                        style="font-size: 0.85rem; font-weight: 500; color: var(--fg-secondary); display: block; margin-bottom: 0.625rem;">
                        <i class="fas fa-user"></i> Player 1
                    </label>
                    <select id="player1-select" class="tournament-select" style="max-width: 100%;">
                        <option value="">Select Player 1...</option>
                    </select>
                </div>
                <div>
                    <label for="player2-select"
                        style="font-size: 0.85rem; font-weight: 500; color: var(--fg-secondary); display: block; margin-bottom: 0.625rem;">
                        <i class="fas fa-user"></i> Player 2
                    </label>
                    <select id="player2-select" class="tournament-select" style="max-width: 100%;">
                        <option value="">Select Player 2...</option>
                    </select>
                </div>
            </div>

            <!-- Compare Button -->
            <div style="text-align: center; margin-bottom: 2rem;">
                <button onclick="comparePlayers()" id="compare-btn" class="btn-primary" disabled>
                    <i class="fas fa-balance-scale"></i>
                    <span>Compare Players</span>
                </button>
            </div>

            <!-- Comparison Results -->
            <div id="comparison-results" style="display: none;"></div>
        </div>
    </section>


    <!-- Detailed Statistics -->
    <section class="detailed-stats">
        <div class="section-header">
            <h2 class="section-title">
                <i class="fas fa-table"></i>
                Detailed Statistics
            </h2>
            <span class="section-subtitle">Filter, sort, and export player stats by category</span>
        </div>

        <div class="stats-tabs-wrapper">
            <div class="stats-tabs">
                <button class="tab-btn active" data-tab="batting">
                    <i class="fas fa-baseball-ball"></i>
                    <span>Batting</span>
                    {% if batting_stats %}<span class="tab-count">{{ batting_stats|length }}</span>{% endif %}
                </button>
                <button class="tab-btn" data-tab="bowling">
                    <i class="fas fa-bowling-ball"></i>
                    <span>Bowling</span>
                    {% if bowling_stats %}<span class="tab-count">{{ bowling_stats|length }}</span>{% endif %}
                </button>
                <button class="tab-btn" data-tab="fielding">
                    <i class="fas fa-hand-paper"></i>
                    <span>Fielding</span>
                    {% if fielding_stats %}<span class="tab-count">{{ fielding_stats|length }}</span>{% endif %}
                </button>
            </div>
        </div>

        <!-- Batting Table -->
        <div id="batting" class="tab-panel active">
            {% if batting_stats %}
            <div class="export-controls">
                <div class="team-filter-inline">
                    <span class="team-filter-label"><i class="fas fa-filter"></i> Team</span>
                    <select class="team-filter-select" onchange="applyFilter('batting')">
                        <option value="">All Teams</option>
                    </select>
                </div>
                <div class="export-btns">
                    <button class="btn-export" onclick="exportFiltered('batting', 'csv')">
                        <i class="fas fa-file-csv"></i>
                        <span>Export CSV</span>
                    </button>
                    <button class="btn-export" onclick="exportFiltered('batting', 'txt')">
                        <i class="fas fa-file-alt"></i>
                        <span>Export TXT</span>
                    </button>
                    <button class="btn-export" onclick="exportImage('batting', 'png', this)">
                        <i class="fas fa-image"></i>
                        <span>Export PNG</span>
                    </button>
                </div>
            </div>
            <div class="filter-summary" id="batting-filter-summary" data-total="{{ batting_stats|length }}">
                <span class="filter-summary-count">Showing <strong id="batting-visible-count">{{ batting_stats|length }}</strong> of {{ batting_stats|length }} players</span>
                <button class="btn-clear-filters" id="batting-clear-btn" onclick="clearFilters('batting')">
                    <i class="fas fa-times"></i> Clear Filters
                </button>
            </div>
            <div class="table-wrapper">
                <table class="stats-table" id="batting-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="handleSort('batting-table',0)">Player <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',1)">Team <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',2)">M <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',3)">Inn <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',4)">Runs <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',5)">Balls <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',6)">NO <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',7)">SR <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',8)">Avg <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',9)">0s <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',10)">1s <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',11)">2s <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',12)">3s <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',13)">4s <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',14)">6s <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',15)">30s <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',16)">50s <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('batting-table',17)">100s <span class="sort-icon">⇕</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in batting_stats %}
                        <tr>
                            <td>{{ row.player }}</td>
                            <td>{{ row.team }}</td>
                            <td>{{ row.matches }}</td>
                            <td>{{ row.innings }}</td>
                            <td>{{ row.runs }}</td>
                            <td>{{ row.balls }}</td>
                            <td>{{ row.not_outs }}</td>
                            <td>{{ row.strike_rate }}</td>
                            <td>{{ row.average }}</td>
                            <td>{{ row.zeros }}</td>
                            <td>{{ row.ones }}</td>
                            <td>{{ row.twos }}</td>
                            <td>{{ row.threes }}</td>
                            <td>{{ row.fours }}</td>
                            <td>{{ row.sixes }}</td>
                            <td>{{ row.thirties }}</td>
                            <td>{{ row.fifties }}</td>
                            <td>{{ row.hundreds }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="no-data-message">
                <i class="fas fa-info-circle"></i>
                <p>No batting data available</p>
            </div>
            {% endif %}
        </div>

        <!-- Bowling Table -->
        <div id="bowling" class="tab-panel">
            {% if bowling_stats %}
            <div class="export-controls">
                <div class="team-filter-inline">
                    <span class="team-filter-label"><i class="fas fa-filter"></i> Team</span>
                    <select class="team-filter-select" onchange="applyFilter('bowling')">
                        <option value="">All Teams</option>
                    </select>
                </div>
                <div class="export-btns">
                    <button class="btn-export" onclick="exportFiltered('bowling', 'csv')">
                        <i class="fas fa-file-csv"></i>
                        <span>Export CSV</span>
                    </button>
                    <button class="btn-export" onclick="exportFiltered('bowling', 'txt')">
                        <i class="fas fa-file-alt"></i>
                        <span>Export TXT</span>
                    </button>
                    <button class="btn-export" onclick="exportImage('bowling', 'png', this)">
                        <i class="fas fa-image"></i>
                        <span>Export PNG</span>
                    </button>
                </div>
            </div>
            <div class="filter-summary" id="bowling-filter-summary" data-total="{{ bowling_stats|length }}">
                <span class="filter-summary-count">Showing <strong id="bowling-visible-count">{{ bowling_stats|length }}</strong> of {{ bowling_stats|length }} bowlers</span>
                <button class="btn-clear-filters" id="bowling-clear-btn" onclick="clearFilters('bowling')">
                    <i class="fas fa-times"></i> Clear Filters
                </button>
            </div>
            <div class="table-wrapper">
                <table class="stats-table" id="bowling-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="handleSort('bowling-table',0)">Team <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',1)">Player <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',2)">M <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',3)">Inn <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',4)">Overs <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',5)">Runs <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',6)">Wkts <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',7)">Best <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',8)">Avg <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',9)">Eco <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',10)">Dots <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',11)">Bowled <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',12)">LBW <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',13)">Byes <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',14)">LB <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',15)">Wides <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('bowling-table',16)">NB <span class="sort-icon">⇕</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in bowling_stats %}
                        <tr>
                            <td>{{ row.team }}</td>
                            <td>{{ row.player }}</td>
                            <td>{{ row.matches }}</td>
                            <td>{{ row.innings }}</td>
                            <td>{{ row.overs }}</td>
                            <td>{{ row.runs }}</td>
                            <td>{{ row.wickets }}</td>
                            <td>{{ row.best }}</td>
                            <td>{{ row.average }}</td>
                            <td>{{ row.economy }}</td>
                            <td>{{ row.dots }}</td>
                            <td>{{ row.bowled }}</td>
                            <td>{{ row.lbw }}</td>
                            <td>{{ row.byes }}</td>
                            <td>{{ row.leg_byes }}</td>
                            <td>{{ row.wides }}</td>
                            <td>{{ row.no_balls }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="no-data-message">
                <i class="fas fa-info-circle"></i>
                <p>No bowling data available</p>
            </div>
            {% endif %}
        </div>

        <!-- Fielding Table -->
        <div id="fielding" class="tab-panel">
            {% if fielding_stats %}
            <div class="export-controls">
                <div class="team-filter-inline">
                    <span class="team-filter-label"><i class="fas fa-filter"></i> Team</span>
                    <select class="team-filter-select" onchange="applyFilter('fielding')">
                        <option value="">All Teams</option>
                    </select>
                </div>
                <div class="export-btns">
                    <button class="btn-export" onclick="exportFiltered('fielding', 'csv')">
                        <i class="fas fa-file-csv"></i>
                        <span>Export CSV</span>
                    </button>
                    <button class="btn-export" onclick="exportFiltered('fielding', 'txt')">
                        <i class="fas fa-file-alt"></i>
                        <span>Export TXT</span>
                    </button>
                    <button class="btn-export" onclick="exportImage('fielding', 'png', this)">
                        <i class="fas fa-image"></i>
                        <span>Export PNG</span>
                    </button>
                </div>
            </div>
            <div class="filter-summary" id="fielding-filter-summary" data-total="{{ fielding_stats|length }}">
                <span class="filter-summary-count">Showing <strong id="fielding-visible-count">{{ fielding_stats|length }}</strong> of {{ fielding_stats|length }} players</span>
                <button class="btn-clear-filters" id="fielding-clear-btn" onclick="clearFilters('fielding')">
                    <i class="fas fa-times"></i> Clear Filters
                </button>
            </div>
            <div class="table-wrapper">
                <table class="stats-table" id="fielding-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="handleSort('fielding-table',0)">Player <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('fielding-table',1)">Team <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('fielding-table',2)">Matches <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('fielding-table',3)">Catches <span class="sort-icon">⇕</span></th>
                            <th class="sortable" onclick="handleSort('fielding-table',4)">Run Outs <span class="sort-icon">⇕</span></th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in fielding_stats %}
                        <tr>
                            <td>{{ row.player }}</td>
                            <td>{{ row.team }}</td>
                            <td>{{ row.matches }}</td>
                            <td>{{ row.catches }}</td>
                            <td>{{ row.run_outs }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% else %}
            <div class="no-data-message">
                <i class="fas fa-info-circle"></i>
                <p>No fielding data available yet</p>
            </div>
            {% endif %}
        </div>
    </section>

    {% endif %}

</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous"></script>
<script>
    // ======= TAB SWITCHING =======
    document.querySelectorAll('.tab-btn').forEach(button => {
        button.addEventListener('click', () => {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            button.classList.add('active');
            const tabId = button.getAttribute('data-tab');
            document.getElementById(tabId).classList.add('active');
        });
    });

    // ======= VIEW SWITCHING =======
    function switchView(view) {
        const params = new URLSearchParams(window.location.search);
        params.set('view', view);
        if (view === 'tournament') {
            document.getElementById('tournament-selector').classList.remove('hidden');
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.textContent.includes('Tournament'));
            });
        } else {
            params.delete('tournament_id');
            window.location.href = '/statistics?' + params.toString();
        }
    }

    function selectTournament(tournamentId) {
        if (tournamentId) {
            const params = new URLSearchParams(window.location.search);
            params.set('view', 'tournament');
            params.set('tournament_id', tournamentId);
            window.location.href = '/statistics?' + params.toString();
        }
    }

    function selectFormat(fmt) {
        const params = new URLSearchParams(window.location.search);
        if (fmt) {
            params.set('match_format', fmt);
        } else {
            params.delete('match_format');
        }
        window.location.href = '/statistics?' + params.toString();
    }

    // ======= FILTER SYSTEM =======
    function applyFilter(type) {
        const table = document.getElementById(type + '-table');
        if (!table) return;

        const teamSelect = document.querySelector(`#${type} .team-filter-select`);
        const teamVal = teamSelect ? teamSelect.value : '';
        const teamColIdx = type === 'bowling' ? 0 : 1;

        const rows = Array.from(table.querySelectorAll('tbody tr'));
        let visibleCount = 0;

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const cellText = (cells[teamColIdx]?.textContent || '').trim();
            const visible = !teamVal || cellText.toLowerCase() === teamVal.toLowerCase();
            row.style.display = visible ? '' : 'none';
            if (visible) visibleCount++;
        });

        const countEl = document.getElementById(type + '-visible-count');
        if (countEl) countEl.textContent = visibleCount;

        const clearBtn = document.getElementById(type + '-clear-btn');
        if (clearBtn) clearBtn.style.display = teamVal ? 'flex' : 'none';
    }

    function clearFilters(type) {
        const teamSelect = document.querySelector(`#${type} .team-filter-select`);
        if (teamSelect) teamSelect.selectedIndex = 0;
        applyFilter(type);
    }

    // ======= TEAM DROPDOWN POPULATION =======
    function initTeamDropdowns() {
        const configs = [
            { type: 'batting', teamColIdx: 1 },
            { type: 'bowling', teamColIdx: 0 },
            { type: 'fielding', teamColIdx: 1 }
        ];
        configs.forEach(({ type, teamColIdx }) => {
            const table = document.getElementById(type + '-table');
            if (!table) return;

            const teams = new Set();
            table.querySelectorAll('tbody tr').forEach(row => {
                const cell = row.querySelectorAll('td')[teamColIdx];
                if (cell) teams.add(cell.textContent.trim());
            });

            const teamSelect = document.querySelector(`#${type} .team-filter-select`);
            if (!teamSelect) return;

            Array.from(teams).sort().forEach(team => {
                const opt = document.createElement('option');
                opt.value = team;
                opt.textContent = team;
                teamSelect.appendChild(opt);
            });
        });
    }

    // ======= SORT SYSTEM =======
    const sortState = {};

    function handleSort(tableId, colIdx) {
        const key = tableId + '-' + colIdx;
        const currentDir = sortState[key] || 'none';
        const newDir = currentDir === 'asc' ? 'desc' : 'asc';
        sortState[key] = newDir;

        const table = document.getElementById(tableId);
        table.querySelectorAll('thead tr:first-child th.sortable').forEach((th, i) => {
            th.classList.remove('sort-asc', 'sort-desc');
            const icon = th.querySelector('.sort-icon');
            if (icon) icon.textContent = '⇕';
            if (i === colIdx) {
                th.classList.add(newDir === 'asc' ? 'sort-asc' : 'sort-desc');
                if (icon) icon.textContent = newDir === 'asc' ? '↑' : '↓';
            }
        });

        const tbody = table.querySelector('tbody');
        const rows = Array.from(tbody.querySelectorAll('tr'));
        rows.sort((a, b) => {
            const aText = (a.querySelectorAll('td')[colIdx]?.textContent || '').trim();
            const bText = (b.querySelectorAll('td')[colIdx]?.textContent || '').trim();
            const aNum = parseFloat(aText);
            const bNum = parseFloat(bText);
            if (!isNaN(aNum) && !isNaN(bNum)) {
                return newDir === 'asc' ? aNum - bNum : bNum - aNum;
            }
            return newDir === 'asc' ? aText.localeCompare(bText) : bText.localeCompare(aText);
        });
        rows.forEach(row => tbody.appendChild(row));
    }

    // ======= CLIENT-SIDE EXPORT (respects filters) =======
    function exportFiltered(type, format) {
        const table = document.getElementById(type + '-table');
        if (!table) return;

        const headers = Array.from(table.querySelectorAll('thead tr:first-child th'))
            .map(th => th.textContent.replace(/[⇕↑↓]/g, '').trim());

        const visibleRows = Array.from(table.querySelectorAll('tbody tr'))
            .filter(tr => tr.style.display !== 'none')
            .map(tr => Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim()));

        if (format === 'csv') {
            let csv = headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + '\n';
            visibleRows.forEach(row => {
                csv += row.map(cell => `"${cell.replace(/"/g, '""')}"`).join(',') + '\n';
            });
            downloadBlob(csv, `${type}_stats.csv`, 'text/csv');
        } else if (format === 'txt') {
            const colWidths = headers.map((h, i) => {
                const maxData = visibleRows.reduce((m, r) => Math.max(m, (r[i] || '').length), 0);
                return Math.max(h.length, maxData) + 2;
            });
            const sep = colWidths.map(w => '-'.repeat(w)).join('+');
            const fmtRow = cols => cols.map((c, i) => (c || '').padEnd(colWidths[i])).join('|');

            let txt = `${type.toUpperCase()} STATISTICS\n`;
            txt += `Generated: ${new Date().toLocaleString()}\n`;
            txt += `Records: ${visibleRows.length}\n\n`;
            txt += sep + '\n' + fmtRow(headers) + '\n' + sep + '\n';
            visibleRows.forEach(row => { txt += fmtRow(row) + '\n'; });
            txt += sep + '\n';
            downloadBlob(txt, `${type}_stats.txt`, 'text/plain');
        }
    }

    function downloadBlob(content, filename, mimeType) {
        const blob = new Blob(['\uFEFF' + content], { type: mimeType + ';charset=utf-8;' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = filename;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    }

    // ======= IMAGE EXPORT =======
    function exportImage(type, format, btn) {
        const panel = document.getElementById(type);
        const tableWrapper = panel?.querySelector('.table-wrapper');
        if (!tableWrapper || typeof html2canvas === 'undefined') {
            alert('Image export is not available. Please try CSV or TXT instead.');
            return;
        }

        const origHTML = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        btn.disabled = true;

        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const bgColor = isDark ? '#1e1e2e' : '#ffffff';
        const fgColor = isDark ? '#e2e8f0' : '#1a1a2e';
        const borderColor = isDark ? '#2d2d44' : '#e2e8f0';
        const headBg = isDark ? '#16213e' : '#f8fafc';

        html2canvas(tableWrapper, {
            backgroundColor: bgColor,
            scale: 2,
            logging: false,
            useCORS: true,
            allowTaint: true,
            onclone: (clonedDoc) => {
                // Apply resolved colors for proper rendering
                clonedDoc.querySelectorAll('.stats-table td').forEach(td => {
                    td.style.backgroundColor = bgColor;
                    td.style.color = fgColor;
                    td.style.borderColor = borderColor;
                });
                clonedDoc.querySelectorAll('.stats-table th').forEach(th => {
                    th.style.backgroundColor = headBg;
                    th.style.color = fgColor;
                    th.style.borderColor = borderColor;
                });
                clonedDoc.querySelectorAll('.stats-table tbody tr:hover td').forEach(td => {
                    td.style.background = 'none';
                });
                // Resolve JetBrains Mono font fallback
                clonedDoc.querySelectorAll('.stats-table td').forEach(td => {
                    td.style.fontFamily = 'monospace';
                });
            }
        }).then(canvas => {
            const mime = format === 'png' ? 'image/png' : 'image/jpeg';
            const quality = format === 'jpg' ? 0.92 : undefined;
            const dateStr = new Date().toISOString().slice(0, 10);
            const link = document.createElement('a');
            link.download = `${type}_stats_${dateStr}.${format}`;
            link.href = canvas.toDataURL(mime, quality);
            link.click();
            btn.innerHTML = origHTML;
            btn.disabled = false;
        }).catch(err => {
            console.error('Image export error:', err);
            btn.innerHTML = origHTML;
            btn.disabled = false;
            alert('Image export failed. Please try CSV or TXT format.');
        });
    }

    // ======= DOMContentLoaded INIT =======
    document.addEventListener('DOMContentLoaded', () => {
        // Leaderboard entrance animations
        document.querySelectorAll('.leaderboard-item').forEach((item, index) => {
            item.style.opacity = '0';
            item.style.transform = 'translateX(-20px)';
            setTimeout(() => {
                item.style.transition = 'all 0.4s cubic-bezier(0.4, 0, 0.2, 1)';
                item.style.opacity = '1';
                item.style.transform = 'translateX(0)';
            }, 100 + (index * 50));
        });

        // Init table features
        initTeamDropdowns();

        // Load async data
        loadPartnerships();
        loadPlayersForComparison('batsman');
        renderInsightsVisuals();
    });

    // Global variables for player comparison
    let currentComparisonRole = 'batsman';
    let allPlayers = [];

    function formatOrdinal(n) {
        const num = parseInt(n, 10);
        if (Number.isNaN(num)) return n;
        const mod100 = num % 100;
        if (mod100 >= 11 && mod100 <= 13) return num + 'th';
        switch (num % 10) {
            case 1: return num + 'st';
            case 2: return num + 'nd';
            case 3: return num + 'rd';
            default: return num + 'th';
        }
    }

    // Load partnerships
    function loadPartnerships() {
        const urlParams = new URLSearchParams(window.location.search);
        const view = urlParams.get('view') || 'overall';
        const tournamentId = urlParams.get('tournament_id') || '';

        let url = view === 'tournament' && tournamentId
            ? '/api/tournament/' + tournamentId + '/partnerships?limit=10'
            : '/api/partnerships?limit=10';

        fetch(url)
            .then(res => res.json())
            .then(data => {
                const container = document.getElementById('partnerships-container');
                if (data.success && data.data && data.data.length > 0) {
                    let html = '<div class="table-wrapper"><table class="stats-table">';
                    html += '<thead><tr><th>Rank</th><th>Partnership</th><th>Runs</th><th>Balls</th><th>Wicket</th>';
                    if (view === 'overall') html += '<th>Tournament</th>';
                    html += '</tr></thead><tbody>';

                    data.data.forEach((p, index) => {
                        html += '<tr>';
                        html += '<td><span class="rank-badge">' + (index + 1) + '</span></td>';
                        html += '<td class="player-name">' + p.batsman1.split(' ').pop() + ' & ' + p.batsman2.split(' ').pop() + '</td>';
                        html += '<td class="stat-value">' + p.runs + '</td>';
                        html += '<td>' + p.balls + '</td>';
                        html += '<td>' + formatOrdinal(p.wicket) + '</td>';
                        if (view === 'overall') html += '<td>' + (p.tournament || 'N/A') + '</td>';
                        html += '</tr>';
                    });

                    html += '</tbody></table></div>';
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="no-data-message"><i class="fas fa-user-friends"></i><p>No partnerships available yet</p></div>';
                }
            })
            .catch(err => {
                console.error('Error loading partnerships:', err);
                document.getElementById('partnerships-container').innerHTML = '<div class="no-data-message"><i class="fas fa-exclamation-circle"></i><p>Error loading data</p></div>';
            });
    }

    // Load players for comparison based on role
    function loadPlayersForComparison(role) {
        fetch('/api/compare-players?player_ids=')
            .then(res => res.json())
            .then(data => {
                if (data.success && data.available_players) {
                    allPlayers = data.available_players;
                    filterPlayersByRole(role);
                }
            })
            .catch(err => console.error('Error loading players:', err));
    }

    // Filter players by role
    function filterPlayersByRole(role) {
        const player1Select = document.getElementById('player1-select');
        const player2Select = document.getElementById('player2-select');

        // Filter players based on role
        const filteredPlayers = allPlayers.filter(p => {
            const playerRole = (p.role || '').toLowerCase();
            if (role === 'batsman') {
                return playerRole.includes('batsman') || playerRole.includes('all-rounder') || playerRole.includes('wicket-keeper');
            } else {
                return playerRole.includes('bowler') || playerRole.includes('all-rounder');
            }
        });

        // Update dropdowns
        player1Select.innerHTML = '<option value="">Select Player 1...</option>';
        player2Select.innerHTML = '<option value="">Select Player 2...</option>';

        filteredPlayers.forEach(p => {
            player1Select.innerHTML += '<option value="' + p.id + '">' + p.name + ' (' + (p.team || 'Unknown') + ')</option>';
            player2Select.innerHTML += '<option value="' + p.id + '">' + p.name + ' (' + (p.team || 'Unknown') + ')</option>';
        });

        // Reset selections
        updateCompareButton();
    }

    // Select comparison role
    function selectComparisonRole(role) {
        currentComparisonRole = role;

        // Update button states
        document.querySelectorAll('#player-comparison-section .view-btn').forEach(btn => {
            if (btn.textContent.toLowerCase().includes(role)) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
        });

        // Filter players
        filterPlayersByRole(role);

        // Hide results
        document.getElementById('comparison-results').style.display = 'none';
    }

    // Update comparebutton state
    function updateCompareButton() {
        const player1 = document.getElementById('player1-select').value;
        const player2 = document.getElementById('player2-select').value;
        const btn = document.getElementById('compare-btn');

        btn.disabled = !player1 || !player2 || player1 === player2;
    }


    // Event listeners for player selection
    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('player1-select').addEventListener('change', updateCompareButton);
        document.getElementById('player2-select').addEventListener('change', updateCompareButton);
    });

    // Compare players
    function comparePlayers() {
        const player1Id = document.getElementById('player1-select').value;
        const player2Id = document.getElementById('player2-select').value;

        if (!player1Id || !player2Id) return;

        const resultsDiv = document.getElementById('comparison-results');
        resultsDiv.innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: var(--accent);"></i><p style="margin-top: 1rem;">Comparing players...</p></div>';
        resultsDiv.style.display = 'block';

        const urlParams = new URLSearchParams(window.location.search);
        const view = urlParams.get('view') || 'overall';
        const tournamentId = urlParams.get('tournament_id') || '';

        let url = '/api/compare-players?player_ids=' + player1Id + ',' + player2Id;
        if (view === 'tournament' && tournamentId) {
            url += '&tournament_id=' + tournamentId;
        }

        fetch(url)
            .then(res => res.json())
            .then(data => {
                if (data.success && data.data && data.data.length >= 2) {
                    displayComparisonResults(data.data);
                } else {
                    resultsDiv.innerHTML = '<div class="no-data-message"><i class="fas fa-exclamation-triangle"></i><p>Could not compare players</p></div>';
                }
            })
            .catch(err => {
                console.error('Error comparing players:', err);
                resultsDiv.innerHTML = '<div class="no-data-message"><i class="fas fa-exclamation-circle"></i><p>Error loading comparison</p></div>';
            });
    }

    // Display comparison results
    function displayComparisonResults(players) {
        const p1 = players[0];
        const p2 = players[1];
        const resultsDiv = document.getElementById('comparison-results');

        let html = '';

        // Batting comparison
        if (p1.batting || p2.batting) {
            html += '<h3 style="margin-top: 2rem; margin-bottom: 1rem; font-size: 1.2rem; color: var(--fg);"><i class="fas fa-cricket-bat"></i> Batting Comparison</h3>';
            html += '<div class="table-wrapper"><table class="stats-table compare-table">';
            html += '<thead><tr><th>Stat</th><th>' + p1.name + '</th><th>' + p2.name + '</th></tr></thead><tbody>';

            const battingStats = ['matches', 'innings', 'runs', 'average', 'strike_rate', 'fifties', 'hundreds'];
            battingStats.forEach(stat => {
                const v1 = stat === 'matches' ? (p1.matches || 0) : ((p1.batting && p1.batting[stat]) || 0);
                const v2 = stat === 'matches' ? (p2.matches || 0) : ((p2.batting && p2.batting[stat]) || 0);
                const maxVal = Math.max(v1, v2, 1);
                html += '<tr><td>' + stat.replace('_', ' ').toUpperCase() + '</td>';
                html += '<td><div class="compare-cell">';
                html += '<div class="compare-value ' + (v1 > v2 ? 'stat-value' : '') + '">' + v1 + '</div>';
                html += '<div class="compare-bar"><div class="compare-bar-fill" style="width:' + (v1 / maxVal * 100) + '%"></div></div>';
                html += '</div></td>';
                html += '<td><div class="compare-cell">';
                html += '<div class="compare-value ' + (v2 > v1 ? 'stat-value' : '') + '">' + v2 + '</div>';
                html += '<div class="compare-bar"><div class="compare-bar-fill is-secondary" style="width:' + (v2 / maxVal * 100) + '%"></div></div>';
                html += '</div></td></tr>';
            });

            html += '</tbody></table></div>';
        }

        // Bowling comparison
        if (p1.bowling || p2.bowling) {
            html += '<h3 style="margin-top: 2rem; margin-bottom: 1rem; font-size: 1.2rem; color: var(--fg);"><i class="fas fa-bowling-ball"></i> Bowling Comparison</h3>';
            html += '<div class="table-wrapper"><table class="stats-table compare-table">';
            html += '<thead><tr><th>Stat</th><th>' + p1.name + '</th><th>' + p2.name + '</th></tr></thead><tbody>';

            const bowlingStats = ['matches', 'innings', 'wickets', 'average', 'economy', 'four_wickets', 'five_wickets'];
            bowlingStats.forEach(stat => {
                const v1 = stat === 'matches' ? (p1.matches || 0) : ((p1.bowling && p1.bowling[stat]) || 0);
                const v2 = stat === 'matches' ? (p2.matches || 0) : ((p2.bowling && p2.bowling[stat]) || 0);
                const maxVal = Math.max(v1, v2, 1);
                const better = stat === 'average' || stat === 'economy' ? (v1 > 0 && (v2 === 0 || v1 < v2)) : v1 > v2;
                html += '<tr><td>' + stat.replace('_', ' ').toUpperCase() + '</td>';
                html += '<td><div class="compare-cell">';
                html += '<div class="compare-value ' + (better ? 'stat-value' : '') + '">' + (v1 || '-') + '</div>';
                html += '<div class="compare-bar"><div class="compare-bar-fill" style="width:' + (v1 / maxVal * 100) + '%"></div></div>';
                html += '</div></td>';
                html += '<td><div class="compare-cell">';
                html += '<div class="compare-value ' + (!better && v2 > 0 ? 'stat-value' : '') + '">' + (v2 || '-') + '</div>';
                html += '<div class="compare-bar"><div class="compare-bar-fill is-secondary" style="width:' + (v2 / maxVal * 100) + '%"></div></div>';
                html += '</div></td></tr>';
            });

            html += '</tbody></table></div>';
        }

        resultsDiv.innerHTML = html;
    }

    function renderInsightsVisuals() {
        renderImpactDots();
        renderSparklines();
        renderVenueRings();
        renderPitchBars();
    }

    function renderImpactDots() {
        const dots = Array.from(document.querySelectorAll('.impact-dots'));
        if (!dots.length) return;
        const impacts = dots.map(el => parseFloat(el.dataset.impact || '0'));
        const maxImpact = Math.max(...impacts, 1);
        dots.forEach(el => {
            const impact = parseFloat(el.dataset.impact || '0');
            const filled = Math.max(1, Math.round((impact / maxImpact) * 8));
            el.innerHTML = '';
            for (let i = 0; i < 8; i++) {
                const dot = document.createElement('span');
                if (i < filled) dot.classList.add('is-hot');
                el.appendChild(dot);
            }
        });
    }

    function renderSparklines() {
        const svgs = document.querySelectorAll('.sparkline');
        svgs.forEach((svg, index) => {
            const data = (svg.dataset.series || '')
                .split(',')
                .map(v => parseFloat(v.trim()))
                .filter(v => !Number.isNaN(v));
            if (!data.length) return;
            const w = 110;
            const h = 36;
            const min = Math.min(...data);
            const max = Math.max(...data);
            const range = max - min || 1;
            const step = w / (data.length - 1 || 1);
            const points = data.map((v, i) => {
                const x = i * step;
                const y = h - ((v - min) / range) * (h - 6) - 3;
                return { x, y };
            });
            const path = points.map((p, i) => `${i === 0 ? 'M' : 'L'}${p.x},${p.y}`).join(' ');
            const gradId = `sparkGradient-${index}`;
            svg.innerHTML = `
                <defs>
                    <linearGradient id="${gradId}" x1="0%" y1="0%" x2="100%" y2="0%">
                        <stop offset="0%" stop-color="#6366f1"/>
                        <stop offset="100%" stop-color="#ec4899"/>
                    </linearGradient>
                </defs>
                <path d="${path}" stroke="url(#${gradId})" fill="none" stroke-width="2.5"/>
                <circle cx="${points[points.length - 1].x}" cy="${points[points.length - 1].y}" r="2.5"/>
            `;
        });
    }

    function renderVenueRings() {
        const rings = Array.from(document.querySelectorAll('.venue-ring'));
        if (!rings.length) return;
        const values = rings.map(el => parseFloat(el.dataset.value || '0'));
        const maxVal = Math.max(...values, 1);
        rings.forEach(el => {
            const value = parseFloat(el.dataset.value || '0');
            const pct = Math.min(100, Math.round((value / maxVal) * 100));
            el.style.background = `conic-gradient(#6366f1 0deg, #ec4899 ${pct * 3.6}deg, rgba(99, 102, 241, 0.15) ${pct * 3.6}deg)`;
        });
    }

    function renderPitchBars() {
        const bars = Array.from(document.querySelectorAll('.pitch-bar-fill'));
        if (!bars.length) return;
        const values = bars.map(el => parseFloat(el.dataset.value || '0'));
        const maxVal = Math.max(...values, 1);
        bars.forEach(el => {
            const value = parseFloat(el.dataset.value || '0');
            const pct = Math.max(8, Math.round((value / maxVal) * 100));
            el.style.width = `${pct}%`;
        });
    }

</script>
{% endblock %}
