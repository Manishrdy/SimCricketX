<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <!-- Apply saved theme immediately to prevent flash -->
    <script>
        (function () {
            var t = null;
            try { t = localStorage.getItem('theme'); } catch (e) {}
            if (!t) t = (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', t);
        }());
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign In â€” SimCricketX</title>
    <meta name="robots" content="noindex">

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:wght@400;500;600&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer">

    <!-- Auth styles -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/auth.css') }}">
</head>
<body>

<div class="auth-page">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         LEFT PANEL â€” branding
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <aside class="auth-left" aria-hidden="true">
        <div class="auth-left-glow"></div>
        <div class="auth-left-glow2"></div>

        <a href="/" class="auth-left-logo">
            <span class="auth-left-logo-icon">ğŸ</span>
            SimCricketX
        </a>

        <div class="auth-left-body">

            <!-- Animated cricket ball -->
            <svg class="auth-left-ball" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <radialGradient id="login-ballGrad" cx="36%" cy="34%" r="56%">
                        <stop offset="0%"   stop-color="#e85c50"/>
                        <stop offset="55%"  stop-color="#c0392b"/>
                        <stop offset="100%" stop-color="#7d1a0e"/>
                    </radialGradient>
                </defs>
                <circle cx="100" cy="100" r="90" fill="url(#login-ballGrad)"/>
                <path d="M100,12 C55,38 55,88 100,100 C55,112 55,162 100,188"
                      fill="none" stroke="rgba(255,200,185,0.7)" stroke-width="4" stroke-linecap="round"/>
                <path d="M100,12 C145,38 145,88 100,100 C145,112 145,162 100,188"
                      fill="none" stroke="rgba(255,200,185,0.7)" stroke-width="4" stroke-linecap="round"/>
                <g stroke="rgba(255,210,195,0.6)" stroke-width="2" stroke-linecap="round">
                    <line x1="62" y1="34" x2="58" y2="42"/> <line x1="51" y1="55" x2="47" y2="63"/>
                    <line x1="47" y1="78" x2="43" y2="86"/> <line x1="51" y1="115" x2="47" y2="123"/>
                    <line x1="62" y1="140" x2="58" y2="148"/>
                </g>
                <g stroke="rgba(255,210,195,0.6)" stroke-width="2" stroke-linecap="round">
                    <line x1="138" y1="34" x2="142" y2="42"/> <line x1="149" y1="55" x2="153" y2="63"/>
                    <line x1="153" y1="78" x2="157" y2="86"/> <line x1="149" y1="115" x2="153" y2="123"/>
                    <line x1="138" y1="140" x2="142" y2="148"/>
                </g>
                <ellipse cx="66" cy="64" rx="22" ry="15" fill="rgba(255,255,255,0.18)" transform="rotate(-25,66,64)"/>
            </svg>

            <div class="auth-left-tagline">
                Simulate<br>
                <span class="auth-left-tagline-accent">Every Ball.</span>
            </div>

            <p class="auth-left-sub">
                Build squads, tune pitch conditions, and run T20 &amp; List A simulations
                powered by a probabilistic ball-by-ball engine.
            </p>

            <ul class="auth-left-features">
                <li><i class="fas fa-check-circle"></i> Ball-by-ball simulation engine</li>
                <li><i class="fas fa-check-circle"></i> T20 &amp; List A format squads</li>
                <li><i class="fas fa-check-circle"></i> Tournaments &amp; player analytics</li>
                <li><i class="fas fa-check-circle"></i> Ground conditions &amp; pitch control</li>
            </ul>

        </div>

        <div class="auth-left-footer">
            Free &nbsp;Â·&nbsp; Open source &nbsp;Â·&nbsp; No credit card &nbsp;Â·&nbsp;
            <a href="https://github.com/manishrdy/SimCricketX" target="_blank" rel="noopener noreferrer">GitHub</a>
        </div>
    </aside>


    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
         RIGHT PANEL â€” form
         â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <main class="auth-right">

        <!-- Theme toggle -->
        <button class="auth-theme-btn" id="themeBtn" aria-label="Toggle dark mode" type="button">
            <i class="fas fa-moon" id="themeIcon" aria-hidden="true"></i>
        </button>

        <div class="auth-form-wrap">

            <h1 class="auth-form-title">Welcome back</h1>
            <p class="auth-form-sub">Sign in to continue your cricket journey</p>

            <!-- Error -->
            {% if error %}
            <div class="auth-alert" id="authAlert">
                <i class="fas fa-exclamation-circle" aria-hidden="true"></i>
                <span>{{ error }}</span>
            </div>
            {% endif %}

            <!-- Login form -->
            <form class="auth-form" method="POST" action="/login" id="loginForm" novalidate>
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="challenge_id"      id="challenge_id">
                <input type="hidden" name="challenge_counter" id="challenge_counter">
                <input type="hidden" name="challenge_digest"  id="challenge_digest">

                <!-- Email -->
                <div class="auth-field">
                    <label class="auth-label" for="email">Email address</label>
                    <div class="auth-input-wrap">
                        <i class="fas fa-envelope auth-input-icon" aria-hidden="true"></i>
                        <input class="auth-input"
                               type="email"
                               id="email"
                               name="email"
                               placeholder="you@example.com"
                               required
                               autofocus
                               autocomplete="email">
                    </div>
                </div>

                <!-- Password -->
                <div class="auth-field">
                    <label class="auth-label" for="password">Password</label>
                    <div class="auth-input-wrap">
                        <i class="fas fa-lock auth-input-icon" aria-hidden="true"></i>
                        <input class="auth-input auth-input--pw"
                               type="password"
                               id="password"
                               name="password"
                               placeholder="Your password"
                               required
                               autocomplete="current-password">
                        <button type="button" class="auth-eye-btn" id="eyeBtn" aria-label="Show password">
                            <i class="fas fa-eye" id="eyeIcon" aria-hidden="true"></i>
                        </button>
                    </div>
                </div>

                <button type="submit" class="auth-btn" id="submitBtn">
                    <i class="fas fa-sign-in-alt" aria-hidden="true"></i>
                    <span id="btnText">Sign In</span>
                </button>
            </form>

            <div class="auth-divider"></div>

            <div class="auth-link-row">
                Don't have an account?
                <a href="{{ url_for('register') }}">Create one free</a>
            </div>
            <div class="auth-link-row">
                <a href="https://github.com/Manishrdy/SimCricketX" target="_blank" rel="noopener noreferrer">
                    <i class="fab fa-github" aria-hidden="true"></i> Star on GitHub
                </a>
                <span class="sep">Â·</span>
                <a href="https://www.planetcricket.org/forums/members/manish.176972/" target="_blank" rel="noopener noreferrer">
                    Contact developer
                </a>
            </div>

        </div>
    </main>

</div><!-- /auth-page -->


<script>
(function () {
    'use strict';

    /* â”€â”€ Theme â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var html = document.documentElement;
    var btn  = document.getElementById('themeBtn');
    var icon = document.getElementById('themeIcon');

    function applyTheme(t) {
        html.setAttribute('data-theme', t);
        icon.className = (t === 'dark') ? 'fas fa-sun' : 'fas fa-moon';
        try { localStorage.setItem('theme', t); } catch (e) {}
    }

    // Sync icon with already-applied theme (set in <head>)
    applyTheme(html.getAttribute('data-theme') || 'light');

    btn.addEventListener('click', function () {
        applyTheme(html.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    });

    /* â”€â”€ Password visibility toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var eyeBtn  = document.getElementById('eyeBtn');
    var eyeIcon = document.getElementById('eyeIcon');
    var pwInput = document.getElementById('password');

    eyeBtn.addEventListener('click', function () {
        var show = pwInput.type === 'password';
        pwInput.type = show ? 'text' : 'password';
        eyeIcon.className = show ? 'fas fa-eye-slash' : 'fas fa-eye';
        eyeBtn.setAttribute('aria-label', show ? 'Hide password' : 'Show password');
    });

    /* â”€â”€ Proof-of-Work challenge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    var loginForm            = document.getElementById('loginForm');
    var submitBtn            = document.getElementById('submitBtn');
    var btnText              = document.getElementById('btnText');
    var challengeIdInput     = document.getElementById('challenge_id');
    var challengeCounterInput= document.getElementById('challenge_counter');
    var challengeDigestInput = document.getElementById('challenge_digest');
    var powChallenge         = null;
    var submittingWithPow    = false;

    async function sha256Hex(input) {
        var data       = new TextEncoder().encode(input);
        var hashBuffer = await crypto.subtle.digest('SHA-256', data);
        var hashArray  = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(function (b) { return b.toString(16).padStart(2, '0'); }).join('');
    }

    async function fetchChallenge() {
        var res = await fetch('/auth/challenge', { method: 'GET', cache: 'no-store' });
        if (!res.ok) throw new Error('Could not start security check');
        powChallenge = await res.json();
    }

    async function solveChallenge(challenge) {
        if (!window.crypto || !window.crypto.subtle) {
            throw new Error('Browser security API unavailable');
        }
        var prefix        = '0'.repeat(challenge.difficulty || 3);
        var maxIterations = Math.max(10000, Number(challenge.max_iterations || 1500000));
        for (var counter = 0; counter < maxIterations; counter++) {
            var digest = await sha256Hex(challenge.nonce + ':' + counter);
            if (digest.startsWith(prefix)) {
                return { counter: counter, digest: digest };
            }
            if (counter % 250 === 0) {
                await new Promise(function (resolve) { setTimeout(resolve, 0); });
            }
        }
        throw new Error('Security check timed out');
    }

    loginForm.addEventListener('submit', async function (e) {
        if (submittingWithPow) return;
        e.preventDefault();
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="fas fa-shield-halved fa-spin"></i> Running Security Checkâ€¦';
        document.body.style.pointerEvents = 'none';

        try {
            if (!powChallenge) await fetchChallenge();
            if (powChallenge.enabled === false) {
                submittingWithPow = true;
                loginForm.submit();
                return;
            }
            var solved = await solveChallenge(powChallenge);
            challengeIdInput.value      = powChallenge.challenge_id;
            challengeCounterInput.value = String(solved.counter);
            challengeDigestInput.value  = solved.digest;
            submittingWithPow = true;
            loginForm.submit();
        } catch (err) {
            submitBtn.disabled = false;
            submitBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> <span>Sign In</span>';
            document.body.style.pointerEvents = '';
            alert(err.message || 'Security check failed');
            try { await fetchChallenge(); } catch (_) {}
        }
    });

    /* â”€â”€ Init: fetch challenge + auto-dismiss errors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    window.addEventListener('DOMContentLoaded', function () {
        fetchChallenge().catch(function () {});

        var alert = document.getElementById('authAlert');
        if (alert) {
            setTimeout(function () {
                alert.style.transition = 'opacity 0.35s, transform 0.35s';
                alert.style.opacity    = '0';
                alert.style.transform  = 'translateY(-10px)';
                setTimeout(function () { alert.remove(); }, 380);
            }, 5000);
        }
    });
}());
</script>

</body>
</html>
