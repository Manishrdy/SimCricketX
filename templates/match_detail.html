<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{{ match.team_home.split('_')[0] }} vs {{ match.team_away.split('_')[0] }} ‚Äì SimCricketX</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <script>
        // Capture entire HTML ‚Üí POST to /download-archive ‚Üí receive ZIP blob ‚Üí force-download
        // DEBUG ENHANCED VERSION - Replace in match_detail.html
        // ‚úÖ CORRECT STRUCTURE - Two separate parts:

        // 1Ô∏è‚É£ FUNCTION DEFINITION (does the actual work)
        async function saveMatchArchive() {
            try {
                console.log("üêõ DEBUG: saveMatchArchive() called");

                // Capture entire HTML
                const html_content = document.documentElement.outerHTML;
                console.log("üêõ DEBUG: HTML content length:", html_content.length);
                console.log("üêõ DEBUG: HTML preview:", html_content.substring(0, 200));

                // Verify we have content
                if (!html_content || html_content.length < 1000) {
                    console.error("üêõ DEBUG: ‚ùå HTML content too short or empty!");
                    alert("‚ùå Error: No HTML content to save");
                    return;
                }

                const url = `${window.location.pathname}/download-archive`;
                console.log("üêõ DEBUG: POST URL:", url);

                const payload = { html_content };
                console.log("üêõ DEBUG: Payload size:", JSON.stringify(payload).length);

                console.log("üêõ DEBUG: Sending POST request...");
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                console.log("üêõ DEBUG: Response status:", response.status);
                console.log("üêõ DEBUG: Response ok:", response.ok);

                if (!response.ok) {
                    console.error("üêõ DEBUG: ‚ùå Response not ok");
                    let errMsg = "Unknown error";
                    try {
                        const errJson = await response.json();
                        errMsg = errJson.error || response.statusText;
                        console.error("üêõ DEBUG: Error JSON:", errJson);
                    } catch (parseError) {
                        console.error("üêõ DEBUG: Could not parse error JSON:", parseError);
                        errMsg = response.statusText;
                    }
                    alert("‚ùå Failed to create/download archive:\n" + errMsg);
                    return;
                }

                console.log("üêõ DEBUG: Reading response blob...");
                const blob = await response.blob();
                console.log("üêõ DEBUG: Blob size:", blob.size);

                if (blob.size === 0) {
                    console.error("üêõ DEBUG: ‚ùå Empty blob received!");
                    alert("‚ùå Error: Received empty file");
                    return;
                }

                // Extract filename from Content-Disposition header
                const cd = response.headers.get('Content-Disposition') || "";
                console.log("üêõ DEBUG: Content-Disposition:", cd);

                let filename = "match_archive.zip";
                const m = /filename="?([^"]+)"?/.exec(cd);
                if (m && m[1]) {
                    filename = m[1];
                }
                console.log("üêõ DEBUG: Download filename:", filename);

                // Trigger browser download
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename.replace(/\"/g, '');
                document.body.appendChild(link);

                console.log("üêõ DEBUG: Triggering download...");
                link.click();

                document.body.removeChild(link);
                URL.revokeObjectURL(link.href);

                console.log("üêõ DEBUG: ‚úÖ Download completed successfully!");

            } catch (e) {
                console.error("üêõ DEBUG: ‚ùå Exception in saveMatchArchive:", e);
                console.error("üêõ DEBUG: Stack trace:", e.stack);
                alert("‚ùå Unexpected error while downloading archive: " + e.message);
            }
        }

        // 2Ô∏è‚É£ EVENT BINDING (separate - runs when page loads)
        document.addEventListener("DOMContentLoaded", () => {
            console.log("üêõ DEBUG: DOM loaded, binding Save Report button...");

            const saveBtn = document.getElementById("save-report");
            if (saveBtn) {
                console.log("üêõ DEBUG: ‚úÖ Save Report button found, binding click event");
                saveBtn.onclick = saveMatchArchive;
            } else {
                console.error("üêõ DEBUG: ‚ùå Save Report button NOT found!");
            }
        });
    </script>

    <script>
        const savedTheme = localStorage.getItem('theme') || 'light';
        window.appTheme = savedTheme;
    </script>

    <style>
        /* Theme Variables (reuse from match_setup.html exactly) */
        :root {
            --bg: #f0f2f5;
            --fg: #1a1a1a;
            --card-bg: #ffffff;
            --input-bg: #e4e6eb;
            --accent: #4a90e2;
            --shadow: rgba(0, 0, 0, 0.1);
            --gradient: linear-gradient(135deg, #4a90e2, #357ab7);
        }

        [data-theme="dark"] {
            --bg: #18191a;
            --fg: #e4e6eb;
            --card-bg: #242526;
            --input-bg: #3a3b3c;
            --accent: #4a90e2;
            --shadow: rgba(0, 0, 0, 0.5);
            --gradient: linear-gradient(135deg, #4a90e2, #357ab7);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--fg);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        /* Header */
        .header {
            display: flex;
            align-items: center;
            padding: 1rem 2rem;
            background: var(--card-bg);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .header .home {
            font-size: 1.5rem;
            margin-right: 1rem;
            cursor: pointer;
            color: var(--accent);
        }

        .header h1 {
            flex: 1;
            font-size: 1.6rem;
            text-align: center;
            background: var(--gradient);
            -webkit-background-clip: text;
            color: transparent;
        }

        .toggle-theme {
            font-size: 1.5rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--fg);
        }

        /* Main Card */
        .card {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
            background: var(--card-bg);
            padding: 2rem;
            max-width: 1200px;
            width: 100%;
            margin: 2rem auto;
            border-radius: 1rem;
            box-shadow: 0 6px 24px var(--shadow);
        }

        /* Panels */
        .panels {
            display: flex;
            flex-direction: row;
            gap: 2rem;
            flex: 1;
        }

        .panel {
            flex: 1;
            background: var(--input-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            box-shadow: 0 4px 12px var(--shadow);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .panel h2 {
            font-size: 1.4rem;
            margin-bottom: 1rem;
            text-align: center;
            background: var(--gradient);
            -webkit-background-clip: text;
            color: transparent;
        }

        /* Player List */
        .xi-list {
            list-style: none;
            padding: 0;
        }

        .xi-list li {
            padding: .5rem;
            border-bottom: 1px solid var(--shadow);
        }

        .xi-list li:last-child {
            border: none;
        }

        /* Commentary */
        /* Commentary */
        .commentary {
            flex: 1;
            background: var(--card-bg);
            border-radius: .75rem;
            padding: 1rem;
            overflow-y: auto;
            font-family: monospace;
            line-height: 1.5;
            height: 900px;
            max-height: 900px;
        }

        /* Info Fields */
        .match-info {
            display: flex;
            flex-wrap: wrap;
            gap: .75rem;
            margin-bottom: 1rem;
        }

        .info {
            background: var(--card-bg);
            border-radius: .5rem;
            padding: .5rem 1rem;
            box-shadow: 0 2px 8px var(--shadow);
            font-size: .9rem;
            display: flex;
            align-items: center;
        }

        .info i {
            margin-right: .5rem;
            color: var(--accent);
        }

        /* Scoreboard */
        .scoreboard {
            background: var(--gradient);
            border-radius: 1rem;
            padding: 1rem;
            margin-top: 1rem;
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .score-display,
        .over-display {
            text-align: center;
            color: white;
        }

        .score-display span:first-child,
        .over-display span:first-child {
            display: block;
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 0.2rem;
        }

        .score-label {
            font-size: 0.75rem;
            opacity: 0.9;
            letter-spacing: 1px;
        }

        .team-name {
            color: white;
            font-weight: bold;
            font-size: 1.8rem;
        }

        /* Scorecard Modal/Panel */
        .scorecard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .scorecard-panel {
            background: var(--card-bg);
            border-radius: 1rem;
            padding: 2rem;
            max-width: 1200px;
            width: 95%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        /* .scorecard-header {
            text-align: center;
            margin-bottom: 1.5rem;
            background: var(--gradient);
            -webkit-background-clip: text;
            color: transparent;
            font-size: 1.5rem;
            font-weight: bold;
        } */

        .scorecard-header {
            text-align: center;
            margin-bottom: 1.5rem;
            background: white;
            /* Change this from: background: var(--gradient); */
            color: var(--accent);
            /* Change this from: color: transparent; */
            /* Remove this line: -webkit-background-clip: text; */
            font-size: 1.5rem;
            font-weight: bold;
            padding: 1rem;
            /* Add this for better spacing */
        }

        .scorecard-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 1rem;
            font-family: monospace;
        }

        .scorecard-table th,
        .scorecard-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--shadow);
        }

        .scorecard-table th {
            background: var(--input-bg);
            font-weight: bold;
        }

        .scorecard-summary {
            background: var(--input-bg);
            padding: 1rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
            text-align: center;
            font-weight: bold;
        }

        .target-info {
            background: var(--accent);
            color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            text-align: center;
            font-weight: bold;
            margin: 1rem 0;
        }

        .save-scorecard {
            margin-right: 8px;
            /* adds ~2ch of space */
        }

        .close-scorecard,
        .save-scorecard {
            background: var(--accent);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            float: right;
            margin-top: 1rem;
        }

        .close-scorecard:hover,
        .save-scorecard:hover {
            background-color: #0056b3;
        }

        .match-result {
            text-align: center;
            color: white;
            width: 100%;
        }

        .match-result span {
            font-size: 1.4rem;
            font-weight: bold;
            display: block;
            line-height: 1.3;
        }

        /* Impact Player Modal - Enhanced */
        .impact-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }

        .impact-content {
            background: var(--card-bg);
            margin: 2% auto;
            padding: 2rem;
            width: 95%;
            max-width: 1400px;
            border-radius: 1rem;
            box-shadow: 0 8px 32px var(--shadow);
            max-height: 90vh;
            overflow-y: auto;
        }

        .impact-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .impact-header h2 {
            font-size: 1.8rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
        }

        .impact-teams-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
            margin-bottom: 2rem;
        }

        .team-section {
            background: var(--input-bg);
            border-radius: 1rem;
            padding: 1.5rem;
            position: relative;
        }

        .team-section h3 {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1.3rem;
            color: var(--accent);
        }

        .team-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .player-column {
            background: var(--card-bg);
            border-radius: 0.75rem;
            padding: 1rem;
            min-height: 500px;
        }

        .column-header {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent);
            opacity: 0.9;
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .player-card {
            background: var(--card-bg);
            border: 2px solid transparent;
            border-radius: 0.5rem;
            padding: 0.75rem;
            cursor: grab;
            transition: all 0.2s ease;
            position: relative;
            user-select: none;
        }

        .player-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .player-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
        }

        .player-card.swapped {
            background: rgba(40, 167, 69, 0.1);
            border-color: #28a745;
        }

        .player-card.original {
            opacity: 0.6;
            background: rgba(220, 53, 69, 0.05);
        }

        .player-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .player-name {
            font-weight: 600;
        }

        .player-role {
            font-size: 0.85rem;
            color: var(--accent);
            opacity: 0.8;
        }

        .swap-badge {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            background: #28a745;
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .team-swap-status {
            text-align: center;
            margin-top: 1rem;
            padding: 0.5rem;
            background: var(--card-bg);
            border-radius: 0.5rem;
            font-weight: 600;
        }

        .team-swap-status.active {
            color: #28a745;
        }

        .team-swap-status.inactive {
            color: #6c757d;
        }

        .swap-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
        }

        .swap-btn {
            padding: 0.5rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .swap-btn.swap {
            background: #28a745;
            color: white;
        }

        .swap-btn.reset {
            background: #dc3545;
            color: white;
        }

        .swap-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .swap-btn:not(:disabled):hover {
            transform: scale(1.05);
        }

        .impact-actions {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        .impact-btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .impact-btn.primary {
            background: var(--gradient);
            color: white;
        }

        .impact-btn.secondary {
            background: var(--input-bg);
            color: var(--fg);
        }

        .impact-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .impact-btn:not(:disabled):hover {
            transform: scale(1.05);
        }

        .drag-placeholder {
            border: 2px dashed var(--accent);
            height: 60px;
            border-radius: 0.5rem;
            margin: 0.5rem 0;
            opacity: 0.5;
        }
    </style>
</head>

<body>
    <div class="header">
        <a href="{{ url_for('home') }}" class="home"><i class="fa fa-home"></i></a>
        <h1>{{ match.team_home.split('_')[0] }} vs {{ match.team_away.split('_')[0] }}</h1>
        <button class="toggle-theme" id="theme-toggle">üåô</button>
    </div>

    <div class="card" style="width:100%;max-width:100%;margin:0;padding:2rem;">
        <div class="match-info">
            <div class="info"><i class="fa fa-fingerprint"></i><strong>Match ID:&nbsp;</strong> {{ match.match_id }}
            </div>
            <div class="info"><i class="fa fa-calendar-alt"></i><strong>Date:&nbsp;</strong> {{ match.timestamp }}</div>
            <div class="info"><i class="fa fa-user"></i><strong>Created by:&nbsp;</strong> {{ match.created_by }}</div>
            <div class="info"><i class="fa fa-stadium"></i><strong>Stadium:&nbsp;</strong> {{ match.stadium }}</div>
            <div class="info"><i class="fa fa-paint-roller"></i><strong>Pitch:&nbsp;</strong> {{ match.pitch }}</div>
            <div class="info"><i class="fa fa-cloud-rain"></i><strong>Rain Chance:&nbsp;</strong> {{
                ((match.rain_probability or 0)
                * 100)|int }}%</div>
            <div class="info"><strong>Toss:</strong> <span id="toss-result">Pending...</span></div>
        </div>

        <div style="text-align:center; margin-bottom:2.5rem;">
            <button id="spin-toss"
                style="padding:0.6rem 1.5rem; font-size:1rem; background:var(--accent); color:#fff; border:none; border-radius:0.5rem; cursor:pointer;">
                Spin the Coin!
            </button>


            <div id="toss-outcome" style="margin-top:0.75rem; font-size:1rem; font-weight:bold;"></div>

            <div id="decision-area" style="margin-top:1rem; display:none;">
                <span id="winner-choice"></span>
                <button class="decision-btn" data-choice="Bat"
                    style="margin-left:1rem; padding:0.5rem 1rem;">Bat</button>
                <button class="decision-btn" data-choice="Bowl"
                    style="margin-left:0.5rem; padding:0.5rem 1rem;">Bowl</button>
            </div>
        </div>


        <div class="panels">
            <div class="panel">
                <h2>{{ match.team_home.split('_')[0] }} Playing XI</h2>
                <ul class="xi-list">
                    {% for p in match.playing_xi.home %}
                    <li>{{ p.name }} ‚Äì {{ p.role }}{% if p.will_bowl %} (Bowling){% endif %}</li>
                    {% endfor %}
                </ul>
                <h2>{{ match.team_away.split('_')[0] }} Playing XI</h2>
                <ul class="xi-list">
                    {% for p in match.playing_xi.away %}
                    <li>{{ p.name }} ‚Äì {{ p.role }}{% if p.will_bowl %} (Bowling){% endif %}</li>
                    {% endfor %}
                </ul>
            </div>

            <div class="panel">
                <h2>Live Commentary</h2>
                <!-- <div id="commentary-log" class="commentary" style="height:75vh;overflow-y:auto;"> -->
                <div id="commentary-log" class="commentary">
                    <p><em>Match starts soon...</em></p>
                </div>


                <div class="scoreboard" id="scoreboard">
                    <!-- <div class="team-name">
                        <span id="batting-team">{{ match.team_home.split('_')[0] }}</span>
                    </div> -->
                    <div class="score-display">
                        <span id="score">0/0</span>
                        <span class="score-label">RUNS/WKTS</span>
                    </div>
                    <div class="over-display">
                        <span id="over-info">0.0</span>
                        <span class="score-label">OVERS</span>
                    </div>
                </div>
            </div>


        </div>
    </div>

    <!-- Scorecard Overlay -->
    <div class="scorecard-overlay" id="scorecard-overlay">
        <div class="scorecard-panel">
            <div class="scorecard-header" id="scorecard-title">TEAM SCORECARD</div>

            <div style="display: flex; gap: 1rem; margin-bottom: 1rem;">
                <!-- Batsmen Table -->
                <div style="flex: 1;">
                    <h3 style="text-align: center; margin-bottom: 0.5rem; font-size: 1.1rem;">BATTING</h3>
                    <table class="scorecard-table" id="scorecard-table">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th></th>
                                <th>Fielder</th>
                                <th>Bowler</th>
                                <th>R</th>
                                <th>B</th>
                                <th>4s</th>
                                <th>6s</th>
                                <th>S/R</th>


                            </tr>
                        </thead>
                        <tbody id="scorecard-tbody">
                            <!-- Players will be populated here -->
                        </tbody>
                    </table>
                </div>

                <!-- Bowlers Table -->
                <div style="flex: 1;">
                    <h3 style="text-align: center; margin-bottom: 0.5rem; font-size: 1.1rem;">BOWLING</h3>
                    <table class="scorecard-table" id="bowling-table">
                        <thead>
                            <tr>
                                <th>Bowler</th>
                                <th>O</th>
                                <th>M</th>
                                <th>R</th>
                                <th>W</th>
                                <th>NB</th>
                                <th>WD</th>
                                <th>ECO</th>
                            </tr>
                        </thead>
                        <tbody id="bowling-tbody">
                            <!-- Bowlers will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Move these INSIDE the scorecard-panel -->
            <div class="scorecard-summary" id="scorecard-summary">
                Total: 0/0 | Overs: 0.0 | Run Rate: 0.00 | Extras: 0
            </div>

            <div class="target-info" id="target-info" style="display: none;">
                Team needs X runs from Y overs at Z.ZZ runs per over
            </div>

            <div class="scorecard-actions">
                <button class="close-scorecard" onclick="closeScorecard()">Close</button>
                <!-- <button class="save-scorecard" onclick="saveScorecardImage()">Save</button> -->
            </div>
        </div>
    </div>

    <!-- Impact Player Modal -->
    <div id="impact-modal" class="impact-modal">
        <div class="impact-content">
            <div class="impact-header">
                <h2>Impact Player Substitution</h2>
                <p>Each team can optionally swap one player from Playing XI with a substitute</p>
            </div>

            <div class="impact-teams-container">
                <!-- Home Team Section -->
                <div class="team-section" id="home-team-section">
                    <h3 id="home-team-title">Home Team</h3>
                    <div class="team-columns">
                        <div class="player-column">
                            <div class="column-header">Playing XI</div>
                            <div class="player-list" id="home-playing-list"></div>
                        </div>
                        <div class="player-column">
                            <div class="column-header">Substitutes</div>
                            <div class="player-list" id="home-subs-list"></div>
                        </div>
                    </div>
                    <div class="team-swap-status inactive" id="home-swap-status">No swap made</div>
                    <div class="swap-controls">
                        <button class="swap-btn reset" id="home-reset-btn" disabled>Reset Swap</button>
                    </div>
                </div>

                <!-- Away Team Section -->
                <div class="team-section" id="away-team-section">
                    <h3 id="away-team-title">Away Team</h3>
                    <div class="team-columns">
                        <div class="player-column">
                            <div class="column-header">Playing XI</div>
                            <div class="player-list" id="away-playing-list"></div>
                        </div>
                        <div class="player-column">
                            <div class="column-header">Substitutes</div>
                            <div class="player-list" id="away-subs-list"></div>
                        </div>
                    </div>
                    <div class="team-swap-status inactive" id="away-swap-status">No swap made</div>
                    <div class="swap-controls">
                        <button class="swap-btn reset" id="away-reset-btn" disabled>Reset Swap</button>
                    </div>
                </div>
            </div>

            <div class="impact-actions">
                <button class="impact-btn primary" id="confirm-swaps">Confirm & Continue</button>
            </div>
        </div>
    </div>

    <script>
        // Enhanced Impact Player System
        let impactPlayerState = {
            home: {
                originalXI: [],
                originalSubs: [],
                currentXI: [],
                currentSubs: [],
                swapped: false,
                swapInfo: null
            },
            away: {
                originalXI: [],
                originalSubs: [],
                currentXI: [],
                currentSubs: [],
                swapped: false,
                swapInfo: null
            }
        };

        function showImpactPlayerModal() {
            const modal = document.getElementById('impact-modal');
            const homeTeamName = matchData.team_home.split('_')[0];
            const awayTeamName = matchData.team_away.split('_')[0];

            // Set team names
            document.getElementById('home-team-title').textContent = homeTeamName;
            document.getElementById('away-team-title').textContent = awayTeamName;

            // Initialize state
            initializeImpactPlayerState();

            // Render both teams
            renderTeam('home');
            renderTeam('away');

            modal.style.display = 'block';
        }

        function initializeImpactPlayerState() {
            // Deep copy original lineups
            impactPlayerState.home.originalXI = JSON.parse(JSON.stringify(matchData.playing_xi.home));
            impactPlayerState.home.originalSubs = JSON.parse(JSON.stringify(matchData.substitutes.home));
            impactPlayerState.home.currentXI = JSON.parse(JSON.stringify(matchData.playing_xi.home));
            impactPlayerState.home.currentSubs = JSON.parse(JSON.stringify(matchData.substitutes.home));
            impactPlayerState.home.swapped = false;
            impactPlayerState.home.swapInfo = null;

            impactPlayerState.away.originalXI = JSON.parse(JSON.stringify(matchData.playing_xi.away));
            impactPlayerState.away.originalSubs = JSON.parse(JSON.stringify(matchData.substitutes.away));
            impactPlayerState.away.currentXI = JSON.parse(JSON.stringify(matchData.playing_xi.away));
            impactPlayerState.away.currentSubs = JSON.parse(JSON.stringify(matchData.substitutes.away));
            impactPlayerState.away.swapped = false;
            impactPlayerState.away.swapInfo = null;
        }

        function renderTeam(team) {
            const playingList = document.getElementById(`${team}-playing-list`);
            const subsList = document.getElementById(`${team}-subs-list`);

            // Clear existing content
            playingList.innerHTML = '';
            subsList.innerHTML = '';

            // Render Playing XI
            impactPlayerState[team].currentXI.forEach((player, index) => {
                const card = createPlayerCard(player, team, 'xi', index);
                playingList.appendChild(card);
            });

            // Render Substitutes
            impactPlayerState[team].currentSubs.forEach((player, index) => {
                const card = createPlayerCard(player, team, 'sub', index);
                subsList.appendChild(card);
            });

            // Update swap status
            updateSwapStatus(team);
        }

        function createPlayerCard(player, team, type, index) {
            const card = document.createElement('div');
            card.className = 'player-card';
            card.draggable = true;
            card.dataset.team = team;
            card.dataset.type = type;
            card.dataset.index = index;

            // Check if this player is swapped
            const isSwapped = impactPlayerState[team].swapInfo &&
                ((type === 'xi' && player.name === impactPlayerState[team].swapInfo.inPlayer) ||
                    (type === 'sub' && player.name === impactPlayerState[team].swapInfo.outPlayer));

            if (isSwapped) {
                card.classList.add('swapped');
            }

            // Check if this is the original player who was swapped out
            const isOriginalOut = type === 'sub' &&
                impactPlayerState[team].swapInfo &&
                player.name === impactPlayerState[team].swapInfo.outPlayer;

            if (isOriginalOut) {
                card.classList.add('original');
            }

            card.innerHTML = `
        <div class="player-info">
            <div>
                <div class="player-name">${player.name}</div>
                <div class="player-role">${player.role}</div>
            </div>
        </div>
        ${isSwapped && type === 'xi' ? '<div class="swap-badge">IMPACT</div>' : ''}
    `;

            // Drag event handlers
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragend', handleDragEnd);

            return card;
        }

        function handleDragStart(e) {
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/plain', JSON.stringify({
                team: e.target.dataset.team,
                type: e.target.dataset.type,
                index: e.target.dataset.index
            }));
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
        }

        // Set up drop zones
        document.addEventListener('DOMContentLoaded', () => {
            const playerLists = document.querySelectorAll('.player-list');

            playerLists.forEach(list => {
                list.addEventListener('dragover', handleDragOver);
                list.addEventListener('drop', handleDrop);
                list.addEventListener('dragenter', handleDragEnter);
                list.addEventListener('dragleave', handleDragLeave);
            });
        });

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
        }

        function handleDragEnter(e) {
            if (e.target.classList.contains('player-list')) {
                e.target.style.background = 'rgba(74, 144, 226, 0.1)';
            }
        }

        function handleDragLeave(e) {
            if (e.target.classList.contains('player-list')) {
                e.target.style.background = '';
            }
        }

        function handleDrop(e) {
            e.preventDefault();
            e.target.style.background = '';

            const data = JSON.parse(e.dataTransfer.getData('text/plain'));
            const dropZone = e.target.closest('.player-list');

            if (!dropZone) return;

            const dropZoneId = dropZone.id;
            const dropTeam = dropZoneId.includes('home') ? 'home' : 'away';
            const dropType = dropZoneId.includes('playing') ? 'xi' : 'sub';

            // Can only swap within same team
            if (data.team !== dropTeam) return;

            // Can only swap between XI and subs, not within same list
            if (data.type === dropType) return;

            // Store the event globally so performSwap can access it
            window.currentDropEvent = e;

            // Perform the swap
            performSwap(data.team, data.type, data.index, dropType);

            // Clean up
            window.currentDropEvent = null;
        }

        function performSwap(team, fromType, fromIndex, toType) {
            const state = impactPlayerState[team];

            // If already swapped, reset first
            if (state.swapped) {
                resetTeamSwap(team);
            }

            const fromList = fromType === 'xi' ? state.currentXI : state.currentSubs;
            const toList = toType === 'xi' ? state.currentXI : state.currentSubs;

            const draggedPlayer = fromList[fromIndex];

            // Find the closest player in the drop zone to swap with
            const dropZone = window.currentDropEvent.target.closest('.player-list');
            const afterElement = getDragAfterElement(dropZone, window.currentDropEvent.clientY);
            let swapWithIndex = 0;

            // Determine which player to swap with based on drop position
            if (afterElement) {
                const cards = [...dropZone.querySelectorAll('.player-card')];
                swapWithIndex = cards.indexOf(afterElement);
                if (swapWithIndex > 0) swapWithIndex--; // Adjust for before position
            } else {
                // Dropped at the end
                swapWithIndex = toList.length - 1;
            }

            // Ensure valid index
            swapWithIndex = Math.max(0, Math.min(swapWithIndex, toList.length - 1));

            if (toList.length > 0) {
                const swapWithPlayer = toList[swapWithIndex];

                // Perform the swap
                fromList[fromIndex] = swapWithPlayer;
                toList[swapWithIndex] = draggedPlayer;

                // Record swap info
                state.swapped = true;
                state.swapInfo = {
                    outPlayer: fromType === 'xi' ? draggedPlayer.name : swapWithPlayer.name,
                    inPlayer: fromType === 'sub' ? draggedPlayer.name : swapWithPlayer.name,
                    outIndex: fromType === 'xi' ? fromIndex : swapWithIndex,
                    inIndex: fromType === 'sub' ? fromIndex : swapWithIndex
                };

                // Re-render team
                renderTeam(team);

                // Enable reset button
                document.getElementById(`${team}-reset-btn`).disabled = false;
            }
        }

        // Add this helper function after performSwap
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.player-card:not(.dragging)')];

            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;

                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        function resetTeamSwap(team) {
            const state = impactPlayerState[team];

            // Restore original lineups
            state.currentXI = JSON.parse(JSON.stringify(state.originalXI));
            state.currentSubs = JSON.parse(JSON.stringify(state.originalSubs));
            state.swapped = false;
            state.swapInfo = null;

            // Re-render team
            renderTeam(team);

            // Disable reset button
            document.getElementById(`${team}-reset-btn`).disabled = true;
        }

        function updateSwapStatus(team) {
            const statusEl = document.getElementById(`${team}-swap-status`);
            const state = impactPlayerState[team];

            if (state.swapped && state.swapInfo) {
                statusEl.textContent = `Swapped: ${state.swapInfo.outPlayer} ‚Üî ${state.swapInfo.inPlayer}`;
                statusEl.className = 'team-swap-status active';
            } else {
                statusEl.textContent = 'No swap made';
                statusEl.className = 'team-swap-status inactive';
            }
        }

        // Reset button handlers
        document.getElementById('home-reset-btn').addEventListener('click', () => resetTeamSwap('home'));
        document.getElementById('away-reset-btn').addEventListener('click', () => resetTeamSwap('away'));

        // Confirm swaps handler
        document.getElementById('confirm-swaps').addEventListener('click', async () => {
            const swapData = {
                home_swap: null,
                away_swap: null
            };

            // Check home team swap
            if (impactPlayerState.home.swapped && impactPlayerState.home.swapInfo) {
                const homeOutIndex = impactPlayerState.home.originalXI.findIndex(
                    p => p.name === impactPlayerState.home.swapInfo.outPlayer
                );
                const homeInIndex = impactPlayerState.home.originalSubs.findIndex(
                    p => p.name === impactPlayerState.home.swapInfo.inPlayer
                );

                swapData.home_swap = {
                    out_player_index: homeOutIndex,
                    in_player_index: homeInIndex
                };
            }

            // Check away team swap
            if (impactPlayerState.away.swapped && impactPlayerState.away.swapInfo) {
                const awayOutIndex = impactPlayerState.away.originalXI.findIndex(
                    p => p.name === impactPlayerState.away.swapInfo.outPlayer
                );
                const awayInIndex = impactPlayerState.away.originalSubs.findIndex(
                    p => p.name === impactPlayerState.away.swapInfo.inPlayer
                );

                swapData.away_swap = {
                    out_player_index: awayOutIndex,
                    in_player_index: awayInIndex
                };
            }

            try {
                // Only send request if at least one team made a swap
                if (swapData.home_swap || swapData.away_swap) {
                    const response = await fetch(`/match/${matchData.match_id}/impact-player-swap`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(swapData)
                    });

                    if (response.ok) {
                        const result = await response.json();
                        matchData = result.updated_match_data;
                    } else {
                        alert('Failed to save swaps. Please try again.');
                        return;
                    }
                }

                // Close modal and continue
                document.getElementById('impact-modal').style.display = 'none';
                setTimeout(startMatch, delay);

            } catch (error) {
                console.error('Error saving swaps:', error);
                alert('An error occurred. Please try again.');
            }
        });
    </script>
    <script>

        let matchOver = false;
        let currentInningsNumber = null;
        let matchData = {{ match| tojson }}; // Initialize matchData from the template
        let delay = 300;  // default 1x pace
        let isFinalScoreboard = false;

        document.querySelectorAll('.pace-btn').forEach(btn => {
            btn.onclick = () => delay = parseInt(btn.dataset.pace);
        });

        const commentaryLog = document.getElementById('commentary-log');
        const scoreElem = document.getElementById('score');
        const overInfoElem = document.getElementById('over-info');
        const strikerInfoElem = document.getElementById('striker-info');
        const bowlerInfoElem = document.getElementById('bowler-info');

        // Spin the coin, update Toss:‚Ä¶, then log intros and start the match
        function spinTossAndStartMatch() {
            const resultEl = document.getElementById('toss-result');
            fetch(`${window.location.pathname}/spin-toss`)
                .then(r => r.json())
                .then(d => {
                    // ‚ë† Update the ‚ÄúToss:‚Äù label
                    resultEl.textContent = `${d.toss_winner} chose to ${d.toss_decision}`;
                    // ‚ë° Log toss commentary and intros
                    commentaryLog.innerHTML += `<p>${d.toss_commentary}</p>`;
                    commentaryLog.innerHTML += `<br>`;
                    // commentaryLog.innerHTML += `<p>üß¢ <strong>Striker:</strong> ${d.striker}</p>`;
                    // commentaryLog.innerHTML += `<p>üéØ <strong>Non-striker:</strong> ${d.non_striker}</p>`;
                    // commentaryLog.innerHTML += `<p>üé≥ <strong>Bowler:</strong> ${d.bowler}</p>`;
                    commentaryLog.innerHTML += `<br>`;
                    commentaryLog.innerHTML += `<br>`;
                    // ‚ë¢ Kick off the match
                    startMatch();
                })
                .catch(err =>
                    commentaryLog.innerHTML += `<p style="color:red;">Toss error: ${err}</p>`
                );
        }

        // Start toss & simulation immediately upon loading
        // replace the auto-call with this:
        document.getElementById('spin-toss').onclick = () => {
            spinTossAndStartMatch();
        };


        // Add these functions to your script section

        function showScorecard(data, completeData) {
            console.log("Inside showScorecard")

            // Track current innings number
            currentInningsNumber = completeData.innings_number;

            document.getElementById('scorecard-overlay').style.display = 'flex';

            // Update title
            document.getElementById('scorecard-title').textContent =
                `${data.innings} INNINGS SCORECARD`;

            // Populate batsmen table
            const tbody = document.getElementById('scorecard-tbody');
            tbody.innerHTML = '';
            data.players.forEach(player => {
                const row = tbody.insertRow();
                row.innerHTML = `
            <td>${player.name}</td>
            <td>${player.status}</td>
            <td>${player.fielder_out || ''}</td>
            <td>${player.bowler_out || ''}</td>
            <td>${player.runs}</td>
            <td>${player.balls}</td>
            <td>${player.fours}</td>
            <td>${player.sixes}</td>
            <td>${player.strike_rate ? player.strike_rate + '%' : ''}</td>
            `;
            });

            // Populate bowlers table
            const bowlingTbody = document.getElementById('bowling-tbody');
            bowlingTbody.innerHTML = '';
            data.bowlers.forEach(bowler => {
                const row = bowlingTbody.insertRow();
                row.innerHTML = `
            <td>${bowler.name}</td>
            <td>${bowler.overs}</td>
            <td>${bowler.maidens}</td>
            <td>${bowler.runs}</td>
            <td>${bowler.wickets}</td>
            <td>${bowler.noballs}</td>
            <td>${bowler.wides}</td>
            <td>${bowler.economy}</td>
            `;
            });

            // Update summary
            document.getElementById('scorecard-summary').textContent =
                `Total: ${data.total_score}/${data.wickets} | Overs: ${data.overs} | Run Rate: ${data.run_rate} | Extras: ${data.extras}`;


            console.log("data.target_info: ", data.target_info)
            console.log("DEBUG INFO:", {
                "data": data,
                scorecard: data.scorecard_data,
                inningsEnd: data.innings_end,
                inningsNumber: data.innings_number
            });

            // Show target info if 2nd innings
            if (data.target_info) {
                document.getElementById('target-info').style.display = 'block';

                console.log("Checking for target-info: ", {
                    "data": data,
                    "data.inningsNumber": data.inningsNumber,
                    "data.innings_end": data.innings_end,
                    "data.innings_number": data.innings_number
                })

                if (data.inningsNumber != 2) {
                    console.log('Innnings 1 identified')
                    document.getElementById('target-info').textContent = data.target_info;
                }
                else {
                    // console.log("Innings 2 identified")
                    // document.getElementById('target-info').textContent = data.result;
                }

            }
            else {
                console.log("Checking for target-info in else: ", {
                    "data": data,
                    "completeData": completeData
                })

                if (data.wickets === 10) {
                    console.log("I think you found it!!!")
                    document.getElementById('target-info').style.display = 'block';
                    document.getElementById('target-info').textContent = completeData.result;
                }
            }
        }


        // Global variable to store first innings scorecard image
        let firstInningsImageBlob = null;

        async function captureCurrentScorecardImage() {
            try {
                const panel = document.querySelector('.scorecard-panel');
                const titleElement = document.getElementById('scorecard-title');

                if (!panel || !titleElement) {
                    console.error("‚ùå Missing scorecard panel or title");
                    return false;
                }

                // Backup styles
                const originalPanelStyle = panel.style.cssText;
                const originalTitleStyles = {
                    background: titleElement.style.background,
                    color: titleElement.style.color,
                    webkitBackgroundClip: titleElement.style.webkitBackgroundClip,
                    backgroundClip: titleElement.style.backgroundClip
                };

                // Prepare for capture
                titleElement.style.background = 'none';
                titleElement.style.color = '#4a90e2';
                titleElement.style.webkitBackgroundClip = 'initial';
                titleElement.style.backgroundClip = 'initial';

                panel.style.maxHeight = 'none';
                panel.style.overflow = 'visible';
                panel.scrollTop = 0;

                await new Promise(res => setTimeout(res, 150));

                const canvas = await html2canvas(panel, {
                    backgroundColor: null,
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: true
                });

                // Restore styles
                Object.assign(titleElement.style, originalTitleStyles);
                panel.style.cssText = originalPanelStyle;

                // Convert to blob
                return new Promise((resolve) => {
                    canvas.toBlob(async (blob) => {
                        if (!blob) {
                            console.error('‚ùå Failed to create image blob');
                            return resolve(false);
                        }

                        const title = titleElement.textContent || '';
                        if (title.includes('1st INNINGS')) {
                            firstInningsImageBlob = blob;
                            console.log('‚úÖ First innings image saved');
                        } else if (title.includes('2nd INNINGS')) {
                            await sendScorecardImagesToBackend(firstInningsImageBlob, blob);
                            console.log('‚úÖ Second innings image sent');
                        }

                        resolve(true);
                    }, 'image/png', 0.95);
                });

            } catch (err) {
                console.error("‚ùå Exception in captureCurrentScorecardImage:", err);
                return false;
            }
        }

        async function sendScorecardImagesToBackend(firstInningsBlob, secondInningsBlob) {
            try {
                console.log("üì§ DEBUG: Sending scorecard images to backend...");

                const formData = new FormData();

                if (firstInningsBlob) {
                    const teams = document.querySelector('h1').textContent.replace(' ‚Äì Project X', '');
                    const firstInningsFilename = `${teams.replace(' vs ', '_vs_')}_first_innings_scorecard.png`;
                    formData.append('first_innings_image', firstInningsBlob, firstInningsFilename);
                    console.log("üì§ DEBUG: Added first innings image:", firstInningsFilename);
                }

                if (secondInningsBlob) {
                    const teams = document.querySelector('h1').textContent.replace(' ‚Äì Project X', '');
                    const secondInningsFilename = `${teams.replace(' vs ', '_vs_')}_second_innings_scorecard.png`;
                    formData.append('second_innings_image', secondInningsBlob, secondInningsFilename);
                    console.log("üì§ DEBUG: Added second innings image:", secondInningsFilename);
                }

                // Send images to backend
                const response = await fetch(`${window.location.pathname}/save-scorecard-images`, {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    console.log('‚úÖ Scorecard images sent to backend successfully');
                } else {
                    console.error('‚ùå Failed to send images:', response.status);
                }

            } catch (error) {
                console.error('‚ùå Error sending scorecard images to backend:', error);
            }
        }

        async function closeScorecard() {
            await captureCurrentScorecardImage();
            document.getElementById('scorecard-overlay').style.display = 'none';
        }


        function startMatch() {
            if (matchOver) return;

            fetch(window.location.pathname + "/next-ball")
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        commentaryLog.innerHTML += `<p style="color:red;">${data.error}</p>`;
                        return;
                    }

                    // ‚ë† First‚Äêinnings end
                    if (data.innings_end && data.innings_number === 1) {

                        if (data.commentary) {
                            commentaryLog.innerHTML += `<p>${data.commentary}</p>`;
                            commentaryLog.scrollTop = commentaryLog.scrollHeight;
                        }


                        if (data.scorecard_data) {
                            // Show the 1st-innings scorecard
                            showScorecard(data.scorecard_data, data);

                            // Don't auto-close‚Äîwait for the user to click "Close"
                            const closeBtn = document.querySelector('.close-scorecard');
                            closeBtn.onclick = async () => {
                                console.log("üêõ DEBUG: closeScorecard() clicked; isFinalScoreboard =", isFinalScoreboard);

                                // ‚úÖ ADD: Capture scorecard image before any other logic
                                await captureCurrentScorecardImage();

                                // Check for impact player swap opportunity
                                if (data.innings_number === 1 && !matchData.impact_players_swapped) {
                                    document.getElementById('scorecard-overlay').style.display = 'none';
                                    showImpactPlayerModal();
                                    return; // Don't continue with normal flow
                                }

                                if (isFinalScoreboard) {
                                    console.log("üêõ DEBUG: Final scoreboard ‚áí invoking saveMatchArchive() before close");
                                    try {
                                        await saveMatchArchive();
                                        console.log("üêõ DEBUG: saveMatchArchive() completed successfully");
                                    } catch (err) {
                                        console.error("üêõ DEBUG: Error in saveMatchArchive():", err);
                                    }
                                }
                                else {
                                    console.log("üêõ DEBUG: Not final scoreboard ‚áí skipping archive");
                                }

                                // Hide the overlay
                                document.getElementById('scorecard-overlay').style.display = 'none';
                                console.log("üêõ DEBUG: closeScorecard() executed");

                                // Append any final commentary
                                commentaryLog.scrollTop = commentaryLog.scrollHeight;

                                // Update the live scoreboard for ball-by-ball view
                                scoreElem.textContent = `Score: ${data.score}/${data.wickets}`;
                                overInfoElem.textContent = `Over: ${data.over}.${data.ball}`;

                                // Now kick off 2nd innings
                                setTimeout(startMatch, delay);
                            };

                            // Don‚Äôt proceed until the user clicks
                            return;
                        }
                    }


                    if (data.innings_end && data.innings_number === 2) {
                        console.log("Inside 2nd innings scoreboard")
                        if (data.scorecard_data) {
                            console.log("üêõ DEBUG: Final scorecard now displayed; setting isFinalScoreboard = true");
                            isFinalScoreboard = true;
                            showScorecard(data.scorecard_data, data);
                        }

                        commentaryLog.innerHTML += `<p>${data.commentary || "<b>Match Over!</b>"}</p>`;
                        matchOver = true;
                        return;
                    }

                    // ‚úÖ ADD THIS - Check for super over
                    if (data.match_tied) {
                        commentaryLog.innerHTML += `<p style="color:green;"><b>MATCH TIED! Super Over Required!</b></p>`;
                        commentaryLog.innerHTML += `<p>${data.commentary}</p>`;

                        // ‚úÖ Show scorecard FIRST (like regular match)
                        if (data.scorecard_data) {
                            setTimeout(() => {
                                showScorecard(data.scorecard_data, data);

                                // ‚úÖ Modify close button to show super over options AFTER closing
                                const closeBtn = document.querySelector('.close-scorecard');
                                const originalOnClick = closeBtn.onclick;
                                closeBtn.onclick = async () => {
                                    await originalOnClick(); // Close scorecard normally

                                    // ‚úÖ THEN show super over options
                                    setTimeout(() => {
                                        commentaryLog.innerHTML += `
                        <div style="margin: 1rem 0; text-align: center;">
                            <h3>Choose which team bats first in Super Over:</h3>
                            <button onclick="startSuperOver('home')" style="margin: 0.5rem; padding: 0.5rem 1rem; background: var(--accent); color: white; border: none; border-radius: 0.5rem;">
                                ${data.home_team} bats first
                            </button>
                            <button onclick="startSuperOver('away')" style="margin: 0.5rem; padding: 0.5rem 1rem; background: var(--accent); color: white; border: none; border-radius: 0.5rem;">
                                ${data.away_team} bats first
                            </button>
                        </div>
                    `;
                                    }, 500);
                                };
                            }, 1500);
                        }

                        matchOver = true;
                        return;
                    }


                    // Add this function to capture complete webpage
                    function saveCompleteWebpage() {
                        // Get the complete HTML of the current page
                        const completeHTML = document.documentElement.outerHTML;

                        // Send to backend
                        return fetch(`${window.location.pathname}/save-complete-webpage`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                html_content: completeHTML,
                                match_id: window.location.pathname.split('/').pop()
                            })
                        });
                    }

                    // Modify your match completion handler:
                    if (data.match_over) {
                        console.log("üèè Match over - enabling Save Report");
                        // Show match result commentary first
                        if (data.commentary) {
                            commentaryLog.innerHTML += `<p>${data.commentary}</p>`;
                        }

                        if (data.scorecard_data) {
                            setTimeout(() => {
                                showScorecard(data.scorecard_data, data);
                            }, 1500);
                        }

                        matchOver = true;
                        return;
                    }

                    // Normal ball-by-ball update
                    commentaryLog.innerHTML += `<p>${data.commentary}</p>`;
                    commentaryLog.scrollTop = commentaryLog.scrollHeight;

                    scoreElem.textContent = `Score: ${data.score}/${data.wickets}`;
                    overInfoElem.textContent = `Over: ${data.over}.${data.ball}`;

                    setTimeout(startMatch, delay);
                })
                .catch(err => commentaryLog.innerHTML += `<p style="color:red;">Match error: ${err}</p>`);
        }

        // Production fix for saveScorecardImage() function
        function saveScorecardImage() {
            const overlay = document.getElementById('scorecard-panel');
            const titleElement = document.getElementById('scorecard-title');

            // Store original styles to restore later
            const originalStyles = {
                background: titleElement.style.background,
                color: titleElement.style.color,
                webkitBackgroundClip: titleElement.style.webkitBackgroundClip,
                backgroundClip: titleElement.style.backgroundClip
            };

            try {
                // Temporarily apply solid styling for better canvas capture
                titleElement.style.background = 'none';
                titleElement.style.color = '#4a90e2'; // Use your accent color directly
                titleElement.style.webkitBackgroundClip = 'initial';
                titleElement.style.backgroundClip = 'initial';

                // Capture with enhanced settings for better quality
                html2canvas(overlay, {
                    backgroundColor: null,
                    scale: 2,
                    useCORS: true,
                    logging: false,
                    allowTaint: true
                }).then(canvas => {
                    // Restore original styles immediately after capture
                    restoreOriginalStyles();

                    // Generate and download the image
                    canvas.toBlob(blob => {
                        if (blob) {
                            const url = URL.createObjectURL(blob);
                            const link = document.createElement('a');
                            link.href = url;
                            link.download = getFilename();
                            link.style.display = 'none';

                            document.body.appendChild(link);
                            link.click();
                            document.body.removeChild(link);
                            URL.revokeObjectURL(url);
                        } else {
                            console.error('Failed to create blob from canvas');
                        }
                    }, 'image/png', 0.95);

                }).catch(error => {
                    // Ensure styles are restored even on error
                    restoreOriginalStyles();
                    console.error('Error capturing scorecard:', error);
                    alert('Failed to save scorecard image. Please try again.');
                });

            } catch (error) {
                // Fallback error handling
                restoreOriginalStyles();
                console.error('Error in saveScorecardImage:', error);
                alert('Failed to save scorecard image. Please try again.');
            }

            // Helper function to restore original styles
            function restoreOriginalStyles() {
                titleElement.style.background = originalStyles.background;
                titleElement.style.color = originalStyles.color;
                titleElement.style.webkitBackgroundClip = originalStyles.webkitBackgroundClip;
                titleElement.style.backgroundClip = originalStyles.backgroundClip;
            }

            // Helper function to generate meaningful filename
            function getFilename() {
                const titleText = titleElement.textContent || 'scorecard';
                const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
                const cleanTitle = titleText.toLowerCase().replace(/[^a-z0-9]/g, '_');
                return `${cleanTitle}_${timestamp}.png`;
            }
        }

        // ‚úÖ NEW: Function to start the next super over after a tie
        function startNextSuperOver(firstBattingTeam, roundNumber) {
            console.log(`üèè Starting Super Over ${roundNumber} with ${firstBattingTeam} batting first`);

            // Clear the choice buttons
            const choiceDiv = document.querySelector('div:has(> button[onclick*="startNextSuperOver"])');
            if (choiceDiv) {
                choiceDiv.remove();
            }

            fetch(`${window.location.pathname}/start-super-over`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ first_batting_team: firstBattingTeam })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        commentaryLog.innerHTML += `<p style="color:red;">Error starting Super Over ${roundNumber}: ${data.error}</p>`;
                        return;
                    }

                    commentaryLog.innerHTML += `<p>${data.commentary}</p>`;
                    commentaryLog.innerHTML += `
                <div style="background: var(--input-bg); padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; text-align: center;">
                    <h4 style="color: var(--accent); margin-bottom: 0.5rem;">Ready for Super Over ${roundNumber}!</h4>
                    <button onclick="startSuperOverSimulation()" 
                            style="padding: 0.75rem 1.5rem; background: var(--accent); color: white; border: none; border-radius: 0.5rem; font-weight: bold; font-size: 1rem;">
                        üèè Start Super Over ${roundNumber} Simulation
                    </button>
                </div>
            `;
                    commentaryLog.scrollTop = commentaryLog.scrollHeight;
                })
                .catch(error => {
                    console.error(`Error starting Super Over ${roundNumber}:`, error);
                    commentaryLog.innerHTML += `<p style="color:red;">Network error starting Super Over ${roundNumber}: ${error}</p>`;
                });
        }

        // ‚úÖ UPDATE: Enhanced startSuperOver function with round tracking
        function startSuperOver(firstBattingTeam) {
            console.log(`üèè Starting super over with ${firstBattingTeam} batting first`);

            fetch(`${window.location.pathname}/start-super-over`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ first_batting_team: firstBattingTeam })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.error) {
                        commentaryLog.innerHTML += `<p style="color:red;">Error starting super over: ${data.error}</p>`;
                        return;
                    }

                    commentaryLog.innerHTML += `<p>${data.commentary}</p>`;

                    const roundText = data.round ? ` ${data.round}` : '';
                    commentaryLog.innerHTML += `
                <div style="background: var(--input-bg); padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; text-align: center;">
                    <h4 style="color: var(--accent); margin-bottom: 0.5rem;">Ready for Super Over${roundText}!</h4>
                    <button onclick="startSuperOverSimulation()" 
                            style="padding: 0.75rem 1.5rem; background: var(--accent); color: white; border: none; border-radius: 0.5rem; font-weight: bold; font-size: 1rem;">
                        üèè Start Super Over${roundText} Simulation
                    </button>
                </div>
            `;
                    commentaryLog.scrollTop = commentaryLog.scrollHeight;
                })
                .catch(error => {
                    console.error("Error starting super over:", error);
                    commentaryLog.innerHTML += `<p style="color:red;">Network error starting super over: ${error}</p>`;
                });
        }

        function startSuperOverSimulation() {
            // ‚úÖ RESET matchOver for super over simulation
            matchOver = false;

            console.log("üèè Starting super over simulation...");

            fetch(`${window.location.pathname}/next-super-over-ball`)
                .then(res => res.json())
                .then(data => {
                    console.log("üèè Super over response:", data);

                    if (data.error) {
                        commentaryLog.innerHTML += `<p style="color:red;">Super Over Error: ${data.error}</p>`;
                        return;
                    }

                    commentaryLog.innerHTML += `<p>${data.commentary}</p>`;
                    commentaryLog.scrollTop = commentaryLog.scrollHeight;

                    // Update score display with round info
                    const roundText = data.round ? ` (Round ${data.round})` : '';
                    scoreElem.textContent = `Super Over${roundText}: ${data.score}/${data.wickets}`;
                    overInfoElem.textContent = `Ball: ${data.ball}/6`;

                    // ‚úÖ NEW: Handle another super over tie
                    if (data.super_over_tied_again) {
                        commentaryLog.innerHTML += `<p style="color:orange; font-weight:bold;">Super Over ${data.round} ended in a tie! Score: ${data.home_score}-${data.away_score}</p>`;

                        // Show options for next super over
                        commentaryLog.innerHTML += `
                    <div style="background: var(--input-bg); padding: 1rem; border-radius: 0.5rem; margin: 1rem 0; text-align: center;">
                        <h4 style="color: var(--accent); margin-bottom: 0.5rem;">Super Over ${data.round + 1} Required!</h4>
                        <p style="margin-bottom: 1rem;">Choose which team bats first in the next Super Over:</p>
                        <button onclick="startNextSuperOver('home', ${data.round + 1})" 
                                style="margin: 0.5rem; padding: 0.5rem 1rem; background: var(--accent); color: white; border: none; border-radius: 0.5rem;">
                            ${data.home_team} bats first
                        </button>
                        <button onclick="startNextSuperOver('away', ${data.round + 1})" 
                                style="margin: 0.5rem; padding: 0.5rem 1rem; background: var(--accent); color: white; border: none; border-radius: 0.5rem;">
                            ${data.away_team} bats first
                        </button>
                    </div>
                `;

                        commentaryLog.scrollTop = commentaryLog.scrollHeight;
                        matchOver = true; // Stop current loop, wait for user choice
                        return;
                    }

                    if (data.super_over_complete) {
                        const totalRounds = data.total_super_overs || data.round || 1;
                        const roundText = totalRounds > 1 ? ` after ${totalRounds} Super Over(s)` : '';

                        commentaryLog.innerHTML += `<p style="color:green; font-size: 1.2rem; font-weight: bold;">üèÜ MATCH DECIDED${roundText}!</p>`;
                        commentaryLog.innerHTML += `<p style="color:green; font-weight: bold;">${data.result}</p>`;

                        // Update final score display
                        document.getElementById('scoreboard').innerHTML = `
                    <div class="match-result">
                        <span>${data.result}</span>
                        <small style="display: block; margin-top: 0.5rem; opacity: 0.8;">
                            Decided in Super Over ${totalRounds}
                        </small>
                    </div>`;

                        matchOver = true;
                        return;
                    }

                    if (data.super_over_innings_end) {
                        if (data.target) {
                            commentaryLog.innerHTML += `<p style="background: var(--accent); color: white; padding: 0.5rem; border-radius: 0.3rem; text-align: center; font-weight: bold;">
                        Target: ${data.target} runs in Super Over ${data.round}
                    </p>`;
                        }
                        setTimeout(() => startSuperOverSimulation(), 1000); // Continue with next innings
                    } else if (data.innings_complete) {
                        setTimeout(() => startSuperOverSimulation(), 500); // Quick transition to result
                    } else {
                        setTimeout(() => startSuperOverSimulation(), delay); // Next ball
                    }
                })
                .catch(error => {
                    console.error("Super over fetch error:", error);
                    commentaryLog.innerHTML += `<p style="color:red;">Super Over Network Error: ${error}</p>`;
                });
        }

        // Add this function somewhere in your script section
        function captureFullCommentary() {
            const commentaryElement = document.getElementById('commentary-log');
            const fullCommentary = commentaryElement.innerHTML;

            // Send the complete commentary to backend for archiving
            return fetch(`${window.location.pathname}/save-commentary`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    commentary_html: fullCommentary,
                    match_id: window.location.pathname.split('/').pop()
                })
            });
        }

        function saveMatchReport() {
            console.log("üíæ Saving match report...");
            const teams = document.querySelector('h1').textContent.replace(' ‚Äì Project X', '');
            const timestamp = new Date().toISOString().slice(0, 19).replace(/[:-]/g, '');
            const filename = `match_report_${teams.replace(' vs ', '_vs_')}_${timestamp}.html`;

            const blob = new Blob([document.documentElement.outerHTML], {
                type: 'text/html;charset=utf-8'
            });

            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.style.display = 'none';

            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            URL.revokeObjectURL(link.href);

            console.log(`‚úÖ Match report saved as: ${filename}`);
        }


        // Theme toggle (consistent with match_setup.html)
        const root = document.documentElement, ttl = document.getElementById('theme-toggle');

        function applyTheme(t) {
            root.setAttribute('data-theme', t);
            ttl.textContent = t === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            localStorage.setItem('theme', t);
        }

        applyTheme(window.appTheme);
        ttl.onclick = () => applyTheme(window.appTheme = window.appTheme === 'dark' ? 'light' : 'dark');
    </script>


</body>

</html>