{% extends "layout.html" %}

{% block title %}
{{ match.team_home.split('_')[0] }} vs {{ match.team_away.split('_')[0] }} - SimCricketX
{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/match_detail.css') }}">
<link rel="stylesheet" href="{{ url_for('static', filename='css/match_dashboard.css') }}">
{% endblock %}

{% block content %}
<div class="match-layout">
    <!-- Sidebar: Match Info & Toss -->
    <div class="info-card">
        <div class="match-meta-grid">
            <div class="meta-item"><i class="fa fa-fingerprint"></i> ID: {{ match.match_id }}</div>
            <div class="meta-item"><i class="fa fa-calendar-alt"></i>
                {% if match.timestamp and match.timestamp|length >= 8 %}
                {{ match.timestamp[4:6] }}-{{ match.timestamp[6:8] }}-{{ match.timestamp[0:4] }}
                {% else %}
                {{ match.timestamp }}
                {% endif %}
            </div>
            <div class="meta-item">üèüÔ∏è {{ match.stadium }}</div>
            <div class="meta-item"><i class="fa fa-paint-roller"></i> {{ match.pitch }}</div>
        </div>

        <div class="toss-section">
            <h3 style="margin-bottom: 1rem;">Toss</h3>
            <button id="spin-toss" class="impact-btn primary toss-btn">Spin Coin</button>
            <div id="toss-result">Pending...</div>
        </div>

        <div class="team-list-container">
            <div class="team-list-header" style="border-color: #3b82f6;">{{ match.team_home.split('_')[0] }} XI</div>
            <ul class="xi-list" id="home-xi-display">
                {% for p in match.playing_xi.home %}
                <li>
                    <span>{{ p.name }}</span>
                    <span class="xi-role">{{ p.role }}</span>
                </li>
                {% endfor %}
            </ul>

            <div class="team-list-header" style="border-color: #ef4444;">{{ match.team_away.split('_')[0] }} XI</div>
            <ul class="xi-list" id="away-xi-display">
                {% for p in match.playing_xi.away %}
                <li>
                    <span>{{ p.name }}</span>
                    <span class="xi-role">{{ p.role }}</span>
                </li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <!-- Main Panel: Score & Commentary -->
    <div class="main-panel">
        <div class="score-banner">
            <div>
                <div style="font-size: 0.9rem; margin-bottom: 0.5rem; opacity: 0.9;">
                    {{ match.team_home.split('_')[0] }} vs {{ match.team_away.split('_')[0] }}
                </div>
                <!-- <div class="team-name" id="batting-team">{{ match.team_home.split('_')[0] }}</div> -->
                <div class="main-score" id="score">0/0</div>
            </div>
            <div class="score-meta">
                <div class="overs-display" id="over-info">0.0</div>
                <div class="rr-display">OVERS</div>
            </div>
        </div>

        <div class="controls-bar">
            <span class="pace-label">Sim Speed:</span>
            <button class="pace-btn" data-pace="1000">1x</button>
            <button class="pace-btn" data-pace="300">3x</button>
            <button class="pace-btn" data-pace="50">MAX</button>
            <button class="pace-btn" id="save-dashboard-btn" title="Save Match Center image">
                <i class="fa fa-download"></i> Save Center
            </button>

            <div class="sim-mode-wrapper">
                <span class="sim-mode-label">Simulation</span>
                <span class="sim-mode-text">Auto</span>
                <label class="sim-mode-switch" title="Toggle simulation mode">
                    <input type="checkbox" id="simulation-mode-toggle">
                    <span class="sim-mode-slider"></span>
                </label>
                <span class="sim-mode-text">Manual</span>
            </div>

            <button class="pace-btn" id="resume-decision-btn" style="display:none;">
                Resume Selection
            </button>

            <div class="view-toggle-wrapper">
                <span class="toggle-label" id="label-commentary">Commentary</span>
                <label class="toggle-switch">
                    <input type="checkbox" id="view-toggle">
                    <span class="toggle-slider"></span>
                </label>
                <span class="toggle-label" id="label-matchcenter">Match Center</span>
            </div>
        </div>

        <!-- Premium AI-Style Code Block Console -->
        <div class="code-window">
            <div class="window-header">
                <div class="window-controls">
                    <span class="window-title">simulation_log.txt</span>
                </div>
                <button class="copy-action-btn" id="copy-log-btn">
                    <i class="fa-regular fa-clone"></i> <span>Copy</span>
                </button>
            </div>
            <div class="commentary-box" id="commentary-log">
                <div class="code-line system-msg">
                    <span class="token-comment">// Match simulation ready. Waiting
                        for toss...</span>
                </div>
            </div>
        </div>

        <!-- Match Center Dashboard (toggle view) ‚Äî viewport-locked, no scroll -->
        <div class="dashboard-container" id="dashboard-container" style="display:none;">
            <!-- Row 1: Wagon Wheel | Players + Win Prob -->
            <div class="dash-panel ground-panel" id="wagon-panel">
                <div class="panel-badge-row">
                    <span class="innings-badge" id="wagon-view-label">Innings 2</span>
                    <button class="innings-flip-btn" id="wagon-flip-btn" title="Flip wagon innings view">Flip</button>
                </div>
                <div class="panel-header">Wagon Wheel</div>
                <svg id="wagon-wheel-svg" viewBox="0 0 300 300"></svg>
            </div>
            <div class="dash-panel players-panel" id="players-panel">
                <div class="panel-header">At the Crease</div>
                <div id="striker-card" class="player-card striker"></div>
                <div id="non-striker-card" class="player-card"></div>
                <div class="panel-divider"></div>
                <div id="bowler-card" class="player-card bowler-card"></div>
                <div id="partnership-bar"></div>
                <div class="panel-divider"></div>
                <div id="win-prob-display"></div>
            </div>

            <!-- Row 2: Timeline strip + Ticker (full width) -->
            <div class="dash-panel timeline-panel">
                <div id="over-timeline" class="timeline-strip"></div>
                <div id="latest-ball-ticker" class="timeline-ticker"></div>
            </div>

            <!-- Row 3: Manhattan | Worm -->
            <div class="dash-panel chart-panel" id="manhattan-panel">
                <div class="panel-badge-row">
                    <span class="innings-badge">White ball = wicket</span>
                </div>
                <div class="panel-header">Manhattan</div>
                <canvas id="manhattan-chart"></canvas>
            </div>
            <div class="dash-panel chart-panel" id="worm-panel">
                <div class="panel-badge-row">
                    <span class="innings-badge">White ball = wicket</span>
                </div>
                <div class="panel-header">Run Chase</div>
                <canvas id="worm-chart"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Scorecard Overlay -->
<div class="overlay" id="scorecard-overlay">
    <div class="overlay-content scorecard-panel" id="scorecard-panel">
        <div class="scorecard-header">
            <h2 class="scorecard-title" id="scorecard-title">SCORECARD</h2>
            <button class="close-scorecard" onclick="closeScorecard()">Close</button>
        </div>
        <style>
            /* Modern IDE Theme (VS Code / AI Artifact Vibe) */
            .code-window {
                background: #1e1e1e;
                /* VS Code Editor BG */
                border: 1px solid #333;
                border-radius: 8px;
                overflow: hidden;
                box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
                display: flex;
                flex-direction: column;
                flex: 1 1 auto;
                min-height: 0;
                height: 100%;
                max-height: 100%;
                margin-top: 0;
                font-family: 'JetBrains Mono', 'Fira Code', monospace;
            }

            .window-header {
                background: #252526;
                /* VS Code Header BG */
                border-bottom: 1px solid #1e1e1e;
                padding: 0.5rem 1rem;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }

            .window-controls {
                display: flex;
                align-items: center;
                gap: 0.5rem;
            }

            .dot {
                width: 12px;
                height: 12px;
                border-radius: 50%;
                display: inline-block;
            }

            .dot.red {
                background: #ff5f56;
            }

            .dot.yellow {
                background: #ffbd2e;
            }

            .dot.green {
                background: #27c93f;
            }

            .window-title {
                margin-left: 0;
                /* Adjusted margin */
                color: #9cdcfe;
                font-size: 0.8rem;
                opacity: 0.8;
            }

            .copy-action-btn {
                background: transparent;
                border: none;
                color: #d4d4d4;
                font-family: inherit;
                font-size: 0.75rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                gap: 0.4rem;
                padding: 0.4rem 0.6rem;
                border-radius: 4px;
                transition: all 0.2s ease;
            }

            .copy-action-btn:hover {
                background: #3c3c3c;
                color: #fff;
            }

            .commentary-box {
                flex: 1 1 auto;
                padding: 1rem;
                overflow-y: auto;
                color: #d4d4d4;
                font-size: 0.9rem;
                line-height: 1.6;
                min-height: 0;
                height: 100%;
                max-height: 100%;
            }

            /* Syntax Highlighting Vibe */
            .token-comment {
                color: #6a9955;
            }

            /* Green comments */
            .token-keyword {
                color: #569cd6;
            }

            /* Blue keywords */
            .token-string {
                color: #ce9178;
            }

            /* Orange strings */
            .token-number {
                color: #b5cea8;
            }

            /* Light green numbers */
            .token-error {
                color: #f48771;
            }

            /* Red for wickets */

            .code-line {
                display: flex;
                gap: 1rem;
                padding: 0.1rem 0;
            }

            /* Custom Scrollbar */
            .commentary-box::-webkit-scrollbar {
                width: 10px;
            }

            .commentary-box::-webkit-scrollbar-track {
                background: #1e1e1e;
            }

            .commentary-box::-webkit-scrollbar-thumb {
                background: #424242;
                border-radius: 0;
            }

            .commentary-box::-webkit-scrollbar-thumb:hover {
                background: #4f4f4f;
            }
        </style>

        <div class="scorecard-body">
            <!-- Batting Section -->
            <div>
                <h3 class="section-title">Batting</h3>
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>Batter</th>
                            <th></th>
                            <th>R</th>
                            <th>B</th>
                            <th>4s</th>
                            <th>6s</th>
                            <th>SR</th>
                        </tr>
                    </thead>
                    <tbody id="scorecard-tbody"></tbody>
                </table>
            </div>

            <!-- Bowling Section -->
            <div>
                <h3 class="section-title">Bowling</h3>
                <table class="score-table">
                    <thead>
                        <tr>
                            <th>Bowler</th>
                            <th>O</th>
                            <th>M</th>
                            <th>R</th>
                            <th>W</th>
                            <th>ECO</th>
                        </tr>
                    </thead>
                    <tbody id="bowling-tbody"></tbody>
                </table>
            </div>

            <div class="scorecard-summary" id="scorecard-summary"></div>
            <div class="target-info" id="target-info" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- Manual Decision Modal -->
<div class="overlay" id="decision-overlay">
    <div class="overlay-content decision-panel">
        <div class="scorecard-header">
            <h2 class="scorecard-title" id="decision-title">Manual Selection Required</h2>
            <button class="close-scorecard" id="decision-close-btn">Close</button>
        </div>
        <div class="decision-body">
            <p id="decision-context" class="decision-context"></p>
            <div id="decision-options" class="decision-options"></div>
            <div class="impact-actions" style="margin-top:1rem;">
                <button class="impact-btn" id="decision-auto-btn" style="margin-right:0.5rem;">Switch to Auto & Continue</button>
                <button class="impact-btn primary" id="decision-submit-btn" disabled>Confirm Selection</button>
            </div>
        </div>
    </div>
</div>

<!-- Impact Player Modal -->
<div id="impact-modal" class="impact-modal" style="display: none;"> <!-- Using inline style for logic control -->
    <div class="impact-content">
        <div class="impact-header">
            <h2>Impact Player Substitution</h2>
            <p>Drag and drop players to swap substitutes or reorder the Playing XI.</p>
        </div>

        <div class="impact-grid">
            <!-- Home Team -->
            <div class="impact-col" id="home-team-section">
                <h3 id="home-team-title" style="text-align:center; color: var(--accent); margin-bottom:1rem;">Home</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <div class="column-header">Playing XI</div>
                        <div class="player-list" id="home-playing-list"></div>
                    </div>
                    <div>
                        <div class="column-header">Subs</div>
                        <div class="player-list" id="home-subs-list"></div>
                    </div>
                </div>

                <div class="team-swap-status inactive" id="home-swap-status">No swap made</div>
                <div style="text-align: center; margin-top: 0.5rem;">
                    <button class="swap-btn reset" id="home-reset-btn" disabled>Reset</button>
                </div>
            </div>

            <!-- Away Team -->
            <div class="impact-col" id="away-team-section">
                <h3 id="away-team-title" style="text-align:center; color: var(--accent); margin-bottom:1rem;">Away</h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div>
                        <div class="column-header">Playing XI</div>
                        <div class="player-list" id="away-playing-list"></div>
                    </div>
                    <div>
                        <div class="column-header">Subs</div>
                        <div class="player-list" id="away-subs-list"></div>
                    </div>
                </div>

                <div class="team-swap-status inactive" id="away-swap-status">No swap made</div>
                <div style="text-align: center; margin-top: 0.5rem;">
                    <button class="swap-btn reset" id="away-reset-btn" disabled>Reset</button>
                </div>
            </div>
        </div>

        <div class="impact-actions">
            <button class="impact-btn primary" id="confirm-swaps">Confirm & Continue</button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- HTML2Canvas for Scorecard Capture -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" integrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoeqMV/TJlSKda6FXzoEyYGjTe+vXA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<!-- Chart.js for Manhattan & Worm Charts -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>

<!-- Initialize Match Data from Jinja -->
<!-- Match Data Container -->
<script id="match-data-json" type="application/json">
    {{ match | tojson | safe }}
</script>

<script>
    // Initialize Match Data safely
    try {
        window.matchData = JSON.parse(document.getElementById('match-data-json').textContent);
    } catch (e) {
        console.error("Failed to parse match data", e);
        window.matchData = {};
    }
</script>

<!-- Load Main Logic -->
<script src="{{ url_for('static', filename='js/match_detail.js') }}"></script>
<!-- Dashboard Rendering -->
<script src="{{ url_for('static', filename='js/match_dashboard.js') }}"></script>

<script>
    // Copy Log Functionality
    document.getElementById('copy-log-btn').addEventListener('click', function () {
        const logContent = document.getElementById('commentary-log').innerText;

        navigator.clipboard.writeText(logContent).then(() => {
            const btn = this;
            const originalHTML = btn.innerHTML;

            btn.innerHTML = '<i class="fa-solid fa-check"></i> Copied!';
            btn.style.borderColor = '#10b981';
            btn.style.color = '#10b981';

            setTimeout(() => {
                btn.innerHTML = originalHTML;
                btn.style.borderColor = '';
                btn.style.color = '';
            }, 2000);
        }).catch(err => {
            console.error('Failed to copy log:', err);
        });
    });
</script>
{% endblock %}
